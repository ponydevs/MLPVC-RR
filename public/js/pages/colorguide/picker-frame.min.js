"use strict";var _createClass=function(){function i(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(g,d){if(parent===window)return alert("You aren't supposed to open this file directly! You will be redirected after you click OK."),window.location.href="/cg/picker";var a={menubar:d,statusbar:d,tabbar:d,picker:d,settings:d},l=function(){},p=function(e){return null==e.pageY&&(e.pageY=e.touches[0].pageY),null==e.pageX&&(e.pageX=e.touches[0].pageX),e},n={hand:0,picker:1,zoom:2},c=.004,h=32,i=1.1,e=function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)},t="string"==typeof window.navigator.userAgent&&/(macos|iphone|os ?x|ip[ao]d)/i.test(window.navigator.userAgent),r=function(){function o(e,t,a,i){var n=4<arguments.length&&arguments[4]!==d&&arguments[4];_classCallCheck(this,o),this.red=e,this.green=t,this.blue=a,this.alpha=!1!==n?n:i}return _createClass(o,[{key:"invert",value:function(){return this.red=255-this.red,this.green=255-this.green,this.blue=255-this.blue,this}}]),o}(),o=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getPixels",value:function(e){for(var t=1<arguments.length&&arguments[1]!==d?arguments[1]:d,a=[],i="function"==typeof t,n=0;n<e.data.length;n+=4){if(i){var o=n/4;if(!1===t(o%e.width,Math.floor(o/e.width)))continue}a.push(new(Function.prototype.bind.apply(r,[null].concat(_toConsumableArray(e.data.slice(n,n+4))))))}return a}}]),e}(),v=function(){function t(e){_classCallCheck(this,t),this.id=cuid(),this.boundingRect=e,this._tab=d}return _createClass(t,[{key:"belongsToTab",value:function(e){this._tab=e}},{key:"_getImageData",value:function(){if(!(this._tab instanceof $))throw new Error("Attempting to get image data without being bound to a tab");var e=this._tab.getCanvasCtx(),t=Math.max(0,this.boundingRect.topLeft.x),a=Math.max(0,this.boundingRect.topLeft.y),i=Math.min(this.boundingRect.sideLength,e.canvas.width-t),n=Math.min(this.boundingRect.sideLength,e.canvas.height-a);return e.getImageData(t,a,i,n)}},{key:"_getPixels",value:function(){var e=0<arguments.length&&arguments[0]!==d?arguments[0]:d;return o.getPixels(this._getImageData(),e)}}],[{key:"averageColor",value:function(e){var t=e.length,a=0,i=0,n=0,o=0;return g.each(e,function(e,t){a+=t.red,i+=t.green,n+=t.blue,o+=t.alpha}),new r(Math.round(a/t),Math.round(i/t),Math.round(n/t),Math.round(o/t))}},{key:"draw",value:function(n,o){n instanceof s?o.fillRect(n.boundingRect.topLeft.x,n.boundingRect.topLeft.y,n.boundingRect.sideLength,n.boundingRect.sideLength):n instanceof f&&g.each(n.slices,function(e,t){var a=n.boundingRect.topLeft.x+t.skip,i=n.boundingRect.topLeft.y+e;o.fillRect(a,i,t.length,1)})}},{key:"getArea",value:function(e,t,a){var i=u.calcRectanglePoints(e.left,e.top,t);if(a)return new s(i);var n=u.calcCircleSlices(t);return new f(i,n)}}]),t}(),s=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,v),_createClass(t,[{key:"resize",value:function(e){this.boundingRect=u.calcRectanglePoints(this.boundingRect.center.x,this.boundingRect.center.y,e)}},{key:"getAverageColor",value:function(){return v.averageColor(this._getPixels())}},{key:"toRound",value:function(){var e=u.calcCircleSlices(this.boundingRect.sideLength);return new f(this.boundingRect,e)}},{key:"toSquare",value:function(){return!1}}]),t}(),f=function(e){function i(e,t){_classCallCheck(this,i);var a=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return a.slices=t,a}return _inherits(i,v),_createClass(i,[{key:"resize",value:function(e){this.boundingRect=u.calcRectanglePoints(this.boundingRect.center.x,this.boundingRect.center.y,e),this.slices=u.calcCircleSlices(e)}},{key:"getAverageColor",value:function(){var a=this;return v.averageColor(this._getPixels(function(e,t){return a.slices[t].skip<e&&e<a.slices[t].skip+a.slices[t].length}))}},{key:"toRound",value:function(){return!1}},{key:"toSquare",value:function(){return new s(this.boundingRect)}}]),i}(),u=function(){function o(){_classCallCheck(this,o)}return _createClass(o,null,[{key:"calcRectanglePoints",value:function(e,t,a){var i=Math.floor(a/2);return{sideLength:a,topLeft:{x:e-i,y:t-i},center:{x:e,y:t}}}},{key:"distance",value:function(e,t){var a=2<arguments.length&&arguments[2]!==d?arguments[2]:0,i=3<arguments.length&&arguments[3]!==d?arguments[3]:0;return Math.sqrt(Math.pow(i-t,2)+Math.pow(a-e,2))}},{key:"calcCircleSlices",value:function(t){var e=t/2,i=new Array(t);g.each(i,function(e){i[e]=new Array(t)});for(var a=0;a<i.length;a++)for(var n=0;n<i[a].length;n++)i[a][n]=o.distance(a,n,e-.5,e-.5)<=e?1:0;return g.each(i,function(e,t){var a=t.join("").replace(/(^|0)1/g,"$1|1").replace(/1(0|$)/g,"1|$1").split("|");i[e]={skip:a[0].length,length:a[1].length}}),i}}]),o}(),m={pickingAreaSize:25,pickerWidth:"85%",sidebarColorFormat:"hex",levelsDialogEnabled:!1,copyHash:!0},k="picker_settings",_=function(){function e(){var t=this;_classCallCheck(this,e),this._settings=g.extend(!0,{},m);var a=void 0;try{a=JSON.parse(g.LocalStorage.get(k))}catch(e){}a&&g.each(m,function(e){void 0!==a[e]&&a[e]!==t._settings[e]&&(t._settings[e]=a[e])}),this.save()}return _createClass(e,[{key:"get",value:function(e){if(void 0===m[e])throw new Error("Trying to get non-existent setting: "+e);return this._settings[e]}},{key:"set",value:function(e,t){if(void 0===m[e])throw new Error("Trying to set non-existent setting: "+e);this._settings[e]=t,this.save()}},{key:"save",value:function(){g.LocalStorage.set(k,JSON.stringify(this._settings))}}],[{key:"getInstance",value:function(){return void 0===a.settings&&(a.settings=new e),a.settings}},{key:"clear",value:function(){g.LocalStorage.remove(k)}}]),e}(),b=function(){function t(){var i=this;_classCallCheck(this,t),this._$menubar=g("#menubar"),this._$menubar.children().children("a.dropdown").on("click",function(e){e.preventDefault(),e.stopPropagation(),i._$menubar.addClass("open"),g(e.target).trigger("mouseenter")}).on("mouseenter",function(e){if(i._$menubar.hasClass("open")){var t=g(e.target);t.hasClass("dropdown")&&(i._$menubar.find("a.active").removeClass("active").next().addClass("hidden"),t.addClass("active").next().removeClass("hidden"))}}),this._$filein=g.mk("input").attr({type:"file",accept:"image/png,image/jpeg,image/bmp",tabindex:-1,class:"fileinput"}).prop("multiple",!0).appendTo($body),this._$openImage=g("#open-image").on("click",function(e){e.preventDefault(),i.requestFileOpen()}),this.pasteCounter=1,this._$pasteImage=g("#paste-image").on("click",function(e){e.preventDefault(),i.requestFilePaste()}),this._$filein.on("change",function(){var e=i._$filein[0].files;if(0!==e.length){var t=1!==e.length?"s":"";g.Dialog.wait("Opening file"+t,"Reading opened file"+t+", please wait");var a=0;!function t(){if(void 0===e[a])return i._$openImage.removeClass("disabled"),i._$filein.val(""),void g.Dialog.close();i.handleFileOpen(e[a],function(e){if(e)return a++,t();i._$openImage.removeClass("disabled"),g.Dialog.fail("Drag and drop","Failed to read file #"+a+", aborting")})}()}}),this._$clearSettings=g("#clear-settings").on("click",function(e){e.preventDefault(),g.Dialog.confirm("Clear settings",'<p>The editor remembers your picking area size, sidebar color format and sidebar width settings.</p><p>If you want to reset these to their defaults, click the "Clear settings" button below.</p><p><strong>This will reload the picker, and any progress will be lost.</strong></p>',["Clear settings","Never mind"],function(e){e&&(g.Dialog.wait(!1,"Clearing settings"),_.clear(),window.location.reload())})}),this._$levelsDIalogToggle=g("#levels-dialog-toggle").on("click",function(e){e.preventDefault(),i.askLevelsToggle()}),_.getInstance().get("levelsDialogEnabled")&&this._$levelsDIalogToggle.parent().addClass("checked");var e=g("#about-dialog-template").children();this._$aboutDialog=g("#about-dialog").on("click",function(){g.Dialog.info("About",e.clone())}),$body.on("click",function(){i._$menubar.removeClass("open"),i._$menubar.find("a.active").removeClass("active"),i._$menubar.children("li").children("ul").addClass("hidden")})}return _createClass(t,[{key:"requestFileOpen",value:function(){this._$filein.trigger("click")}},{key:"requestFilePaste",value:function(){var a=this,e=g.mk("div","paste-div").attr("contenteditable","true");g.Dialog.request("Open from Clipboard",e,!1,function(){e.pastableContenteditable(),e.on("pasteImage",function(e,t){g.Dialog.close(),S.getInstance().openImage(t.dataURL,t.name||"paste"+a.pasteCounter+++"-"+t.width+"x"+t.height+".png")}).on("pasteImageError",function(e,t){g.Dialog.fail("Could not read pasted data: "+t.message)}).on("pasteText",function(){e.html("")}),e[0].focus()})}},{key:"handleFileOpen",value:function(e,t){if(!/^image\/(png|jpeg|bmp)$/.test(e.type))return g.Dialog.fail("Invalid file","You may only use PNG, JPEG and BMP images with this tool"),void t(!1);var a=URL.createObjectURL(e);S.getInstance().openImage(a,e.name,t)}},{key:"askLevelsToggle",value:function(){var e="will <strong>reload</strong> the picker causing you to <strong>lose</strong> any opened images and picking areas.";(0<arguments.length&&arguments[0]!==d?arguments[0]:_.getInstance().get("levelsDialogEnabled"))?g.Dialog.confirm("Disable levels dialog","Are you sure you want to disable the levels dialog? This "+e,["Disable & reload","Keep enabled"],function(e){e&&(g.Dialog.wait(!1,"Disabling levels dialog"),_.getInstance().set("levelsDialogEnabled",!1),window.location.reload())}):g.Dialog.confirm("Enable levels dialog","<p>The levels tool can be used to adjust the visible colors of images on a per-tab basis without affecting the colors reported by the picking areas, which in some cases can be useful to weed out ambiguous areas that have a lot of artifacts.</p><p>This feature is disabled by default due to the drastic <strong>performance decrease</strong> it causes. Would you like to enable this feature anyway? If you change your mind, you will be able to disable the dialog from the Tools menu.</p><p><strong>Note:</strong> Clicking <q>Enable & reload</q> "+e,["Enable & reload","Keep disabled"],function(e){e&&(g.Dialog.wait(!1,"Enabling levels dialog"),_.getInstance().set("levelsDialogEnabled",!0),window.location.reload())})}}],[{key:"getInstance",value:function(){return void 0===a.menubar&&(a.menubar=new t),a.menubar}}]),t}(),y=function(){function e(){var t=this;_classCallCheck(this,e),this._$el=g("#statusbar"),this._$info=this._$el.children(".info"),this._$pos=this._$el.children(".pos"),this._$colorat=this._$el.children(".colorat"),this._$color=this._$colorat.children(".color"),this._$opacity=this._$colorat.children(".opacity"),this.infoLocked=!1,this.Pos={mouse:"mousepos"},this["_$"+this.Pos.mouse]=this._$pos.children(".mouse"),g.each(this.Pos,function(e){t.setPosition(e)})}return _createClass(e,[{key:"lockInfo",value:function(){this.infoLocked=!0}},{key:"unlockInfo",value:function(){this.infoLocked=!1}},{key:"setInfo",value:function(){var e=0<arguments.length&&arguments[0]!==d?arguments[0]:"";this.infoLocked||(t&&e.replace(/Shift/g,"Option").replace(/Ctrl/g,"Command"),this._$info.text(e))}},{key:"setPosition",value:function(e){var t=1<arguments.length&&arguments[1]!==d?arguments[1]:{top:NaN,left:NaN},a=2<arguments.length&&arguments[2]!==d?arguments[2]:1,i=this.Pos[e];if("string"!=typeof i)throw new Error("[Statusbar.setPosition] Invalid position display key: "+e);1!==a&&(t.left*=a,t.top*=a),this["_$"+i].text(isNaN(t.left)||isNaN(t.top)?"":g.roundTo(t.left,2)+","+g.roundTo(t.top,2))}},{key:"setColorAt",value:function(){var e=0<arguments.length&&arguments[0]!==d?arguments[0]:"",t=1<arguments.length&&arguments[1]!==d?arguments[1]:"";e.length?this._$color.css({backgroundColor:e,color:g.RGBAColor.parse(e).isLight()?"black":"white"}):this._$color.css({backgroundColor:"",color:""}),this._$color.text(e||""),this._$opacity.text(t||"")}}],[{key:"getInstance",value:function(){return void 0===a.statusbar&&(a.statusbar=new e),a.statusbar}}]),e}(),C=function(e){var t=e.find(".color-preview"),a=e.mkData();t.html(g.mk("div").css("background-color","rgba("+a.red+","+a.green+","+a.blue+","+Math.round(a.opacity/100)+")"))},w=g.mk("form","set-area-color").append('<div class="label">\n\t\t\t\t<span>Red, Green, Blue (0-255)</span>\n\t\t\t\t<div class="input-group-3">\n\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="red"   class="change input-red">\n\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="green" class="change input-green">\n\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="blue"  class="change input-blue">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="label">\n\t\t\t\t<span>Opacity (%)</span>\n\t\t\t\t<input type="number" min="0" max="100" step="1" name="opacity" class="change">\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<div class="color-preview"></div>\n\t\t\t</div>').on("change keyup input",".change",function(e){var t=g(e.target).closest("form");C(t)}).on("set-color",function(e,a){var i=g(this);g.each(g.RGBAColor.COMPONENTS,function(e,t){i.find('input[name="'+t+'"]').val(a[t])}),i.find('input[name="opacity"]').val(Math.round(100*a.alpha)),C(i)}),$=function(){function a(e,t){var i=this;_classCallCheck(this,a),this._fileHash=t,this._canvas=mk("canvas"),this._imgdata={},this._pickingAreas={},this._zoomlevel=d,this._levels={low:0,high:255},this._pickingSize=d,this.file={extension:d,name:d},this.setName(e),this._$pickAreaColorDisplay=g.mk("span").attr({class:"pickcolor","data-info":"Change the color of the picking areas on this tab"}),this._$el=g.mk("li").attr("class","tab").append(this._$pickAreaColorDisplay,g.mk("span").attr({class:"filename","data-info":this.file.name+"."+this.file.extension}).text(this.file.name),g.mk("span").attr("class","fileext").text(this.file.extension),g.mk("span").attr({class:"close","data-info":"Close tab"}).text("×")),this._$el.on("click",function(e){switch(e.preventDefault(),e.target.className){case"close":return g.Dialog.confirm("Close tab","Please confirm that you want to close this tab.",["Close","Cancel"],function(e){e&&(i.close(),g.Dialog.close())});case"pickcolor":return g.Dialog.request("Select a picking area color",w.clone(!0,!0),"Set",function(a){a.triggerHandler("set-color",[i.loadPickingAreaColor()]),a.on("submit",function(t){t.preventDefault();var e=a.mkData();g.Dialog.wait(!1,"Setting picking area color");try{i.savePickingAreaColor("rgba("+e.red+","+e.green+","+e.blue+","+Math.round(e.opacity)/100+")")}catch(e){return g.Dialog.fail(!1,t.message)}g.Dialog.close()})})}I.getInstance().activateTab(i)})}return _createClass(a,[{key:"activate",value:function(){this._$el.addClass("active")}},{key:"deactivate",value:function(){this._$el.removeClass("active")}},{key:"isActive",value:function(){return this._$el.hasClass("active")}},{key:"getFileHash",value:function(){return this._fileHash}},{key:"setImage",value:function(i,n){var o=this,s=new Image;g(s).attr("src",i).on("load",function(){if(o._imgdata.src=i,o._imgdata.size={width:s.width,height:s.height},o._canvas.width=o._imgdata.size.width,o._canvas.height=o._imgdata.size.height,o._canvas.getContext("2d").drawImage(s,0,0),void 0===o._pickingAreaColor){var e=mk("canvas");e.width=1,e.height=1;var t=e.getContext("2d");t.drawImage(s,0,0,1,1);var a=(new(Function.prototype.bind.apply(r,[null].concat(_toConsumableArray(t.getImageData(0,0,1,1).data),[.5])))).invert();o.savePickingAreaColor(g.RGBAColor.fromRGB(a))}n(!0)}).on("error",function(){n(!1)})}},{key:"setName",value:function(e){var t=e.split(/\./g);this.file.extension=t.pop(),this.file.name=t.join(".")}},{key:"getName",value:function(){return this.file.name+"."+this.file.extension}},{key:"getImageSize",value:function(){return this._imgdata.size}},{key:"loadImagePosition",value:function(){return this._imgdata.position}},{key:"saveImagePosition",value:function(e){this._imgdata.position=e}},{key:"loadZoomLevel",value:function(){return this._zoomlevel}},{key:"saveZoomLevel",value:function(e){this._zoomlevel=e}},{key:"loadLevels",value:function(){return this._levels}},{key:"saveLevels",value:function(e){this._levels=e}},{key:"loadPickingSize",value:function(){return this._pickingSize}},{key:"savePickingSize",value:function(e){this._pickingSize=e}},{key:"getElement",value:function(){return this._$el}},{key:"getCanvasCtx",value:function(){return this._canvas.getContext("2d")}},{key:"placeArea",value:function(e,t){var a=!(2<arguments.length&&arguments[2]!==d)||arguments[2];this.addPickingArea(v.getArea(e,t,a))}},{key:"addPickingArea",value:function(e){e.belongsToTab(this),this._pickingAreas[e.id]=e}},{key:"loadPickingAreas",value:function(){return this._pickingAreas}},{key:"clearPickingAreas",value:function(){var e=0<arguments.length&&arguments[0]!==d&&arguments[0];this._pickingAreas={},this.isActive()&&(e||S.getInstance().redrawPickingAreas())}},{key:"removePickingArea",value:function(e){var t=1<arguments.length&&arguments[1]!==d&&arguments[1];if(void 0===this._pickingAreas[e])throw new Error("Trying to remove non-existing area, guid: "+e);delete this._pickingAreas[e],this.isActive()&&(t||S.getInstance().redrawPickingAreas())}},{key:"replacePickingArea",value:function(e,t){t.id=e,t.belongsToTab(this),this._pickingAreas[e]=t}},{key:"loadPickingAreaColor",value:function(){return this._pickingAreaColor||"rgba(255,0,255,.5)"}},{key:"savePickingAreaColor",value:function(e){this._pickingAreaColor=g.RGBAColor.parse(e),this._$pickAreaColorDisplay.html(g.mk("span").css("background-color",this._pickingAreaColor.toString())),this.isActive()&&S.getInstance().redrawPickingAreas()}},{key:"drawImage",value:function(){var e=this._imgdata.size,t=e.width,a=e.height;S.getInstance().getImageCanvasCtx().drawImage(this._canvas,0,0,t,a,0,0,t,a)}},{key:"close",value:function(){this._imgdata.src&&URL.revokeObjectURL(this._imgdata.src),I.getInstance().closeTab(this)}}]),a}(),I=function(){function e(){_classCallCheck(this,e),this._$tabbar=g("#tabbar"),this._activeTab=!1,this._tabStorage=[]}return _createClass(e,[{key:"newTab",value:function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];var i=new(Function.prototype.bind.apply($,[null].concat(t)));return this._tabStorage.push(i),this.updateTabs(),i}},{key:"activateTab",value:function(e){var a=this;e instanceof $&&(e=this.indexOf(e)),this._tabStorage[e]instanceof $?this._activeTab=e:this._activeTab=!1,g.each(this._tabStorage,function(e,t){e===a._activeTab?t.activate():t.deactivate()}),!1!==this._activeTab&&S.getInstance().openTab(this._tabStorage[this._activeTab])}},{key:"indexOf",value:function(a){var i=parseInt(a.getElement().attr("data-ix"),10);if(isNaN(i)&&g.each(this._tabStorage,function(e,t){if(t===a)return i=e,!1}),isNaN(i))throw console.log(a),new Error("Could not find index of the tab logged above");return i}},{key:"updateTabs",value:function(){var a=this;this._$tabbar.children().detach(),g.each(this._tabStorage,function(e,t){a._$tabbar.append(t.getElement().attr("data-ix",e))})}},{key:"getActiveTab",value:function(){return!1!==this._activeTab?this._tabStorage[this._activeTab]:d}},{key:"getTabs",value:function(){return this._tabStorage}},{key:"hasTabs",value:function(){return 0<this._tabStorage.length}},{key:"closeTab",value:function(e){var t=this.indexOf(e),a=this._tabStorage.length,i=1<a;i||S.getInstance().clearImage(),this._tabStorage.splice(t,1),i&&this.activateTab(Math.min(a-2,t)),this.updateTabs(),S.getInstance().updatePickingState()}},{key:"closeActiveTabConfirm",value:function(){this._activeTab instanceof $&&this._activeTab.getElement().find(".close").trigger("click")}}],[{key:"getInstance",value:function(){return void 0===a.tabbar&&(a.tabbar=new e),a.tabbar}}]),e}(),z=g.mk("form","levels-changer").append('<div class="label">\n\t\t\t<span>Range</span>\n\t\t\t<div class="slider-holder">\n\t\t\t\t<div class="slider"></div>\n\t\t\t\t<div class="inputs">\n\t\t\t\t\t<div class="low">\n\t\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="low">\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="high">\n\t\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="high">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="notice info">These settings do not affect the returned average color values in any way.</div>',g.mk("button").attr("class","darkblue").text("Reset to defaults").on("click",function(e){e.preventDefault();var t=g(this).closest("form");t.find('input[name="low"]').val(0),t.find('input[name="high"]').val(255),t.trigger("submit",[!0])})).on("update-disp",function(){var e=g(this),t=e.find('input[name="low"]'),a=parseInt(t.val(),10),i=e.find('input[name="high"]'),n={low:a,high:parseInt(i.val(),10)};S.getInstance().getImageCanvasCtx().setRange({r:n,g:n,b:n})}),S=function(){function t(){var c=this;_classCallCheck(this,t),this._mouseImagePos={top:NaN,left:NaN},this._zoomlevel=1,this._levels={low:0,high:255},this._moveMode=!1,this._$picker=g("#picker"),this.updatePickerSize(),this._$imageOverlay=g.mk("canvas").attr("class","image-overlay"),this._$imageCanvas=g.mk("canvas").attr("class","image-element"),this._$mouseOverlay=g.mk("canvas").attr("class","mouse-overlay"),this.setCanvasSize(0,0),this._$handTool=g.mk("button").attr({class:"fa fa-hand-paper-o","data-info":"Hand Tool (H) - Move around without having to hold Space"}).on("click",function(e){e.preventDefault(),c.switchTool("hand")}),this._$pickerTool=g.mk("button").attr({class:"fa fa-eyedropper","data-info":"Eyedropper Tool (I) - Click to place picking areas on the image (Hold Alt for rounded area)"}).on("click",function(e){e.preventDefault(),c.switchTool("picker")}),this._$zoomTool=g.mk("button").attr({class:"fa fa-search","data-info":"Zoom Tool (Z) - Left click to zoom in, right click to zoom out"}).on("click",function(e){e.preventDefault(),c.switchTool("zoom")}),this.switchTool("hand"),this._$levelsChanger=g.mk("button").attr({class:"fa fa-sliders","data-info":"Adjust levels… (Warning: Lag-inducing)"}).on("click",function(e){e.preventDefault();var t=_.getInstance().get("levelsDialogEnabled");if(!t)return b.getInstance().askLevelsToggle(t);I.getInstance().getActiveTab()&&g.Dialog.request("Adjust levels",z.clone(!0,!0),"Set",function(n){var e=n.find(".slider")[0],t=noUiSlider.create(e,{start:[c._levels.low||0,c._levels.high||255],margin:1,limit:255,connect:!0,direction:"ltr",orientation:"horizontal",behaviour:"tap-snap",step:1,tooltips:!1,range:{min:0,max:255},format:{to:function(e){return parseInt(e,10)},from:function(e){return e}}}),a=n.find(".slider-holder input"),i=!0;t.on("update",g.throttle(100,function(e,t){i||(a.eq(t).val(e[t]),n.triggerHandler("update-disp"))})),a.on("change input",function(){i=!0,t.set([a.eq(0).val(),a.eq(1).val()]),i=!1,n.triggerHandler("update-disp")});var o=t.get();a.eq(0).val(o[0]),a.eq(1).val(o[1]),setTimeout(function(){i=!1},200),n.on("submit",function(e,t){e.preventDefault();var a=n.mkData(),i={low:a.low,high:a.high};g.Dialog.wait(!1,"Changing levels",!1,function(){c.setLevels(i,t),g.Dialog.close()})})})}),this._$zoomin=g.mk("button").attr({class:"zoom-in fa fa-search-plus","data-info":"Zoom in (Alt+Scroll Up)"}).on("click",function(e,t){e.preventDefault(),c.setZoomLevel(c._zoomlevel*i,t),t&&c.updateMousePosition(t),c.drawPickerCursor(!e.altKey)}),this._$zoomout=g.mk("button").attr({class:"zoom-out fa fa-search-minus","data-info":"Zoom out (Alt+Scroll Down)"}).on("click",function(e,t){e.preventDefault(),c.setZoomLevel(c._zoomlevel/i,t),t&&c.updateMousePosition(t),c.drawPickerCursor(!e.altKey)}),this._$zoomfit=g.mk("button").attr({class:"zoom-fit fa fa-window-maximize","data-info":"Fit in view (Ctrl+0)"}).on("click",function(e){e.preventDefault(),c.setZoomFit()}),this._$zoomorig=g.mk("button").attr({class:"zoom-orig fa fa-search","data-info":"Original size (Ctrl+1)"}).on("click",function(e){e.preventDefault(),c.setZoomOriginal()}),this._$zoomperc=g.mk("span").attr({class:"zoom-perc","data-info":"Current zoom level (Click to enter a custom value between 0.4% and 3200%)",contenteditable:!0,spellcheck:"false",autocomplete:"off"}).text("100%").on("keydown",function(e){if(g.isKey(Key.Enter,e)){e.preventDefault();var t=parseFloat(c._$zoomperc.text());isNaN(t)||c.setZoomLevel(t/100),g.clearFocus(),c.updateZoomLevelInputs()}}).on("mousedown touchstart",function(){c._$zoomperc.data("mousedown",!0)}).on("mouseup touchend",function(){c._$zoomperc.data("mousedown",!1)}).on("click",function(){!0!==c._$zoomperc.data("focused")&&(c._$zoomperc.data("focused",!0),c._$zoomperc.select())}).on("dblclick",function(e){e.preventDefault(),c._$zoomperc.select()}).on("blur",function(){c._$zoomperc.data("mousedown")||c._$zoomperc.data("focused",!1),0===c._$zoomperc.html().trim().length&&c.updateZoomLevelInputs(),g.clearSelection()}),this._$actionTopLeft=g.mk("div").attr("class","actions actions-tl").append(g.mk("div").attr("class","picking-tools").append("<span class='label'>Picking</span>",this._$handTool,this._$pickerTool,this._$zoomTool,this._$levelsChanger),g.mk("div").attr("class","zoom-controls").append("<span class='label'>Zooming</span>",this._$zoomin,this._$zoomout,this._$zoomfit,this._$zoomorig,this._$zoomperc)).on("mousedown touchstart",function(e){e.stopPropagation(),c._$zoomperc.triggerHandler("blur")}),this._$pickingSize=g.mk("span").attr({class:"picking-size","data-info":"Size of newly placed picking areas (Click to enter a custom value between 1px and 400px)",contenteditable:!0,spellcheck:"false",autocomplete:"off"}).on("keydown",function(e){if(g.isKey(Key.Enter,e)){e.preventDefault();var t=parseInt(c._$pickingSize.text().trim());c.setPickingSize(isNaN(t)?d:t),g.clearFocus()}}).on("mousedown touchstart",function(){c._$pickingSize.data("mousedown",!0)}).on("mouseup touchend",function(){c._$pickingSize.data("mousedown",!1)}).on("click",function(){!0!==c._$pickingSize.data("focused")&&(c._$pickingSize.data("focused",!0),c._$pickingSize.select())}).on("dblclick",function(e){e.preventDefault(),c._$pickingSize.select()}).on("blur",function(){c._$pickingSize.data("mousedown")||c._$pickingSize.data("focused",!1),0===c._$pickingSize.text().trim().length&&c.setPickingSize(),g.clearSelection()}),this._pickingSizeDecreaseInterval=d,this._pickingSizeIncreaseInterval=d,this._$decreasePickingSize=g.mk("button").attr({class:"fa fa-minus-circle","data-info":"Decrease picking area size (Down Arrow)"}).on("mousedown touchstart",function(e){e.preventDefault(),void 0!==c._pickingSizeIncreaseInterval&&(clearInterval(c._pickingSizeIncreaseInterval),c._pickingSizeIncreaseInterval=d);var t=!e.altKey;c.decreasePickingSize(t,!1),c._pickingSizeDecreaseInterval=setInterval(function(){c.decreasePickingSize(t,!1)},150)}).on("mouseup mouseleave touchend",function(){void 0!==c._pickingSizeDecreaseInterval&&(clearInterval(c._pickingSizeDecreaseInterval),c._pickingSizeDecreaseInterval=d)}),this._$increasePickingSize=g.mk("button").attr({class:"fa fa-plus-circle","data-info":"Increase picking area size (Up Arrow)"}).on("mousedown touchstart",function(e){e.preventDefault(),void 0!==c._pickingSizeDecreaseInterval&&(clearInterval(c._pickingSizeDecreaseInterval),c._pickingSizeDecreaseInterval=d);var t=!e.altKey;c.increasePickingSize(t,!1),c._pickingSizeIncreaseInterval=setInterval(function(){c.increasePickingSize(t,!1)},150)}).on("mouseup mouseleave touchend",function(){void 0!==c._pickingSizeIncreaseInterval&&(clearInterval(c._pickingSizeIncreaseInterval),c._pickingSizeIncreaseInterval=d)}),this.setPickingSize(_.getInstance().get("pickingAreaSize"),!1),this._$areaCounter=g.mk("span"),this._$areaImageCounter=g.mk("span"),this._$averageColor=g.mk("span").attr("class","average text"),this._$copyColorBtn=g.mk("button").attr({class:"fa fa-clipboard","data-info":"Copy average color to clipboard"}).on("click",function(e){var t=c._$averageColor.children().eq(0).text();c.shouldCopyHash()||(t=t.replace(/^#/,"")),g.copy(t,e)}),this._$hashToggleBtn=g.mk("button").attr({class:"fa fa-hashtag","data-info":"Toggle whether the hash symbol is copied with the color code"}).on("click",function(e){var t=!c.shouldCopyHash();_.getInstance().set("copyHash",t),g(e.target)[t?"removeClass":"addClass"]("tool-disabled")}),this._$averageColorRgb=g.mk("span").attr("class","average text rgb"),this._$actionsBottomLeft=g.mk("div").attr("class","actions actions-bl").append(g.mk("div").append('<span class="label">Picking tool settings</span>',g.mk("div").attr("class","picking-controls text").append(this._$decreasePickingSize,this._$pickingSize,this._$increasePickingSize)),g.mk("div").append('<span class="label">Picking status</span>',g.mk("span").attr("class","counters text").append(this._$areaCounter," & ",this._$areaImageCounter),this._$averageColor,this._$averageColorRgb)).on("mousedown touchstart",function(e){e.stopPropagation(),c._$zoomperc.triggerHandler("blur")}),this._$areasList=g.mk("ul");var l=!1;this._$listResizeHandle=g.mk("div").attr("class","resize-handle").on("mousedown touchstart",function(){l=!0,$body.addClass("area-list-resizing")}),this._$areasDeleteSelected=g.mk("button").attr({class:"fa fa-trash","data-info":"Delete selected areas (Del)"}).on("click",function(e){e.preventDefault(),c.deleteSelectedAreas()}),this._$displayFormatSwitch=g.mk("button").attr("class","fa"),this._$selectAllAreas=g.mk("button").attr({class:"fa fa-check-circle","data-info":"Selects all areas (Ctrl+A). Shift+Click to deselect (Ctrl+Shift+A)."}).on("click",function(e){e.preventDefault(),c.selectAllAreas(e.shiftKey)}),this.setSidebarDisplayFormat(_.getInstance().get("sidebarColorFormat"),!1),this._$areasListButtons=g.mk("div").attr("class","action-buttons").append(this._$areasDeleteSelected,this._$displayFormatSwitch,this._$selectAllAreas),this._$areasSidebar=g("#areas-sidebar").append(this._$listResizeHandle,this._$areasListButtons,this._$areasList).on("mousewheel",function(e){e.stopPropagation()}).on("click",".select-handle",function(e){e.preventDefault();var t=g(e.target).closest("li");if(e.ctrlKey&&!e.altKey){if(t.closest("ul").parent().hasClass("selected"))return;t.toggleClass("selected").find(".selected").removeClass("selected")}else if(!e.shiftKey||e.altKey||e.ctrlKey)c._$areasSidebar.find("li.selected").removeClass("selected"),t.addClass("selected");else{var a=c._$areasSidebar.find(".lastclicked"),i=a.length;if(0<i){var n=void 0,o=void 0,s=void 0;if(0<t.children("ul").length)0<a.children("ul").length?(n=a.index(),o=t.index(),s=t.parent().children()):t.addClass("selected");else n=a.index(),o=t.index(),s=t.parent().find(".entry"),t.parent().is(a.parent())||(n=Math.min(o,t.siblings().first().index()));if(c._$areasSidebar.find("li.selected").removeClass("selected"),void 0!==n){if(o<n){var r=n;n=o,o=r}for(var l=n;l<=o||l<i;l++)s.eq(l).addClass("selected")}}}c._$areasSidebar.find("li.lastclicked").removeClass("lastclicked"),t.addClass("lastclicked")}).on("dblclick",".entry",function(e){e.preventDefault();var t=g(e.target).closest("li");if(!(0<t.children("ul").length)){var a=t.parents("li").index(),n=t.attr("id").replace(/^picking-area-/,""),o=I.getInstance().getTabs()[a],s=o.loadPickingAreas()[n],i=s instanceof f,r=g.mk("form","area-update-form").append('<div class="label">\n\t\t\t\t\t\t<span>Area type</span>\n\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t<label><input type="radio" name="type" value="round" '+(i?"checked":"")+'><span>Rounded</span></label>\n\t\t\t\t\t\t\t<label><input type="radio" name="type" value="square" '+(i?"":"checked")+"><span>Square</span></label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>",g.mk("label").append("<span>Area size (1-400px)</span>",g.mk("input").attr({type:"number",min:1,max:400,step:1,name:"size"}).val(s.boundingRect.sideLength)));g.Dialog.request("Edit picking area",r,"Update",function(){r.on("submit",function(e){e.preventDefault();var t=r.mkData();g.Dialog.wait(!1,"Updating area");var a=g.clamp(parseInt(t.size,10),1,400);a!==s.boundingRect.sideLength&&s.resize(a);var i=s["to"+g.capitalize(t.type)]();!1!==i&&o.replacePickingArea(n,i),c.updatePickingState(),o.isActive()&&c.redrawPickingAreas(),g.Dialog.close()})})}}),this.setPickerWidth(_.getInstance().get("pickerWidth")),this.updatePickingState(),this._$loader=g.mk("div").attr("class","loader"),$w.on("resize",g.throttle(250,function(){c.resizeHandler()})),this._$picker.append(this._$actionTopLeft,this._$actionsBottomLeft,this._$mouseOverlay,this._$imageOverlay,this._$loader);var h=void 0,u=void 0;$body.on("mousemove touchmove",g.throttle(50,function(e){var t=p(e);if(l){var a=Math.max(t.pageX-2,0)/$body.width();c.setPickerWidth(g.roundTo(100*a,2))}else if(I.getInstance().getActiveTab()&&!g.Dialog.isOpen()&&(c.updateMousePosition(t),h&&u)){var i=t.pageY,n=t.pageX,o=c.getPickerPosition(),s=h.top+(i-u.top)-o.top,r=h.left+(n-u.left)-o.left;c.move({top:s,left:r}),c.updateZoomLevelInputs()}})),this._$mouseOverlay.on("mousemove touchmove",function(e){c.updateMousePosition(e),c.drawPickerCursor(!e.altKey)}).on("mousedown touchstart",function(e){I.getInstance().getActiveTab()&&!g.Dialog.isOpen()&&(e.preventDefault(),c._activeTool===n.picker&&c.placeArea(c._mouseImagePos,c._pickingAreaSize,!e.altKey))}).on("click",function(e){c._activeTool===n.zoom&&1===e.which&&(e.preventDefault(),c._$zoomin.trigger("click",[e]))}).on("contextmenu",function(e){c._activeTool===n.zoom&&(e.preventDefault(),c._$zoomout.trigger("click",[e]))}).on("mouseleave",function(){c.clearMouseOverlay()}),$w.on("mousewheel",function(e){e.altKey&&(e.preventDefault(),0<e.originalEvent.deltaY?c._$zoomout.trigger("click",[e]):c._$zoomin.trigger("click",[e]))}),this._$picker.on("mousewheel",function(e){if(!e.altKey){e.preventDefault();var t=c._pickerHeight*(e.shiftKey?.1:.025)*Math.sign(e.originalEvent.wheelDelta);e.ctrlKey?c.move({left:"+="+t+"px"}):c.move({top:"+="+t+"px"}),c.updateMousePosition(e)}}),$body.on("mousedown touchstart",function(e){var t=p(e);I.getInstance().getActiveTab()&&g(t.target).is(c._$imageOverlay)&&c._$imageOverlay.hasClass("draggable")&&(t.passive||t.preventDefault(),c._$imageOverlay.addClass("dragging"),h=c.getImagePosition(),u={top:t.pageY,left:t.pageX})}),$body.on("mouseup mouseleave touchend blur",function(e){var t="mouseup"===e.type||"touchend"===e.type;l&&t&&(l=!1,c.storeSidebarWidth(),$body.removeClass("area-list-resizing")),I.getInstance().getActiveTab()&&t&&(u=h=d,c._$imageOverlay.removeClass("dragging"))})}return _createClass(t,[{key:"getZoomedTopLeft",value:function(e,t){var a=2<arguments.length&&arguments[2]!==d?arguments[2]:this.getPickerCenterPosition(),i=e.left,n=e.top,o=a.left,s=a.top;return{top:s+t*(n-s),left:o+t*(i-o)}}},{key:"getImageCanvasSize",value:function(){return{width:this._$imageCanvas.width(),height:this._$imageCanvas.height()}}},{key:"getImagePosition",value:function(){var e=0<arguments.length&&arguments[0]!==d?arguments[0]:this._$imageCanvas.offset(),t=this.getPickerPosition();return e.left-=t.left,e.right-=t.right,e}},{key:"getPickerCenterPosition",value:function(){return{top:this._pickerHeight/2,left:this._pickerWidth/2}}},{key:"getPickerPosition",value:function(){var e=this._$picker.offset();return e.top-=(this._pickerHeight-this._$picker.outerHeight())/2,e.left-=(this._pickerWidth-this._$picker.outerWidth())/2,e}},{key:"setPickingSize",value:function(){var e=0<arguments.length&&arguments[0]!==d?arguments[0]:d,t=!(1<arguments.length&&arguments[1]!==d)||arguments[1];isNaN(e)||(this._pickingAreaSize=g.clamp(e,1,400)),this._$pickingSize.text(this._pickingAreaSize+"px"),this._$decreasePickingSize.prop("disabled",1===this._pickingAreaSize),this._$increasePickingSize.prop("disabled",400===this._pickingAreaSize),t&&_.getInstance().set("pickingAreaSize",this._pickingAreaSize);var a=I.getInstance().getActiveTab();a&&a.savePickingSize(this._pickingAreaSize)}},{key:"decreasePickingSize",value:function(e){var t=!(1<arguments.length&&arguments[1]!==d)||arguments[1];this.setPickingSize(this._pickingAreaSize-5),t&&this.drawPickerCursor(e)}},{key:"increasePickingSize",value:function(e){var t=!(1<arguments.length&&arguments[1]!==d)||arguments[1];this.setPickingSize(1===this._pickingAreaSize?5:this._pickingAreaSize+5),t&&this.drawPickerCursor(e)}},{key:"drawPickerCursor",value:function(e){var t=I.getInstance().getActiveTab();if(t&&!g.Dialog.isOpen()&&this._activeTool===n.picker){var a=v.getArea(this._mouseImagePos,this._pickingAreaSize,e);this.clearMouseOverlay();var i=this.getMouseOverlayCtx();i.fillStyle=t.loadPickingAreaColor().toString(),v.draw(a,i)}}},{key:"placeArea",value:function(e,t){var a=!(2<arguments.length&&arguments[2]!==d)||arguments[2],i=I.getInstance().getActiveTab();i&&(i.placeArea(e,t,a),this.redrawPickingAreas())}},{key:"redrawPickingAreas",value:function(){var e=I.getInstance().getActiveTab();if(e){this.clearImageOverlay();var a=this.getImageOverlayCtx();a.fillStyle=e.loadPickingAreaColor().toString(),g.each(e.loadPickingAreas(),function(e,t){v.draw(t,a)}),this.updatePickingState()}}},{key:"updatePickingState",value:function(){var h=this,o=0,s=0,u=[];if(this._$areasList.empty(),g.each(I.getInstance().getTabs(),function(e,t){var a=t.loadPickingAreas(),i=Object.keys(a),l=g.mk("ul"),n=g.mk("li").append(g.mk("span").attr("class","entry").append(g.mk("span").attr("class","name").text(t.getName()),g.mk("span").attr({class:"select-handle","data-info":"Picking area tab selection handle (Click to select, Ctrl/Shift+Click to select multiple)"})),l);if(h._$areasList.append(n),i.length){s++,o+=i.length;var c=0;g.each(a,function(e,t){var a=t.getAverageColor(),i="hex"===h._sidebarDisplayFormat,n=g.RGBAColor.fromRGB(a).toHex(),o=void 0,s=void 0;if(i)o=g.RGBAColor.fromRGB(a).toString(),s=n+(255!==a.alpha?" @ "+g.roundTo(a.alpha/255*100,2)+"%":"");else if(4===(s=(o=g.RGBAColor.fromRGB(a).toRGBString()).replace(/^rgba?\((.+)\)$/,"$1").split(",")).length){var r=g.roundTo(100*parseFloat(s.pop()),2);s=s.join(", ")+" @ "+r+"%"}else s=s.join(", ");l.append(g.mk("li","picking-area-"+t.id).attr({class:"entry","data-info":"Picking area (Double click to change shape and size)"}).append(g.mk("span").attr("class","index").text(++c),g.mk("span").attr("class","color").css({backgroundColor:o,color:g.RGBAColor.parse(n).isLight()?"black":"white"}).html(s),g.mk("span").attr("class","size "+(t instanceof f?"rounded":"square")).html(g.mk("span").text(t.boundingRect.sideLength)),g.mk("span").attr({class:"select-handle","data-info":"Picking area selection handle (Click to select, Ctrl/Shift+Click to select multiple)"}))),u.push(a)})}}),this._$areaCounter.text(o+" area"+(1!==o?"s":"")),this._$areaImageCounter.text(s+" image"+(1!==s?"s":"")),this._$averageColor.empty(),this._$averageColorRgb.empty(),u.length){var e=g.RGBAColor.fromRGB(v.averageColor(u)),t=this._$hashToggleBtn.clone(!0,!0);this.shouldCopyHash()||t.addClass("tool-disabled"),this._$averageColor.append(g.mk("span").attr("class","color").css({backgroundColor:e.toString(),color:e.isLight()?"black":"white"}).text(e.toHex()),this._$copyColorBtn.clone(!0,!0),t),this._$averageColorRgb.html(e.toRGB())}}},{key:"selectAllAreas",value:function(){var e=0<arguments.length&&arguments[0]!==d&&arguments[0];this._$areasList.children()[e?"removeClass":"addClass"]("selected")}},{key:"deleteSelectedAreas",value:function(){var e=this._$areasList.find(".selected");if(e.length){var o={},s=I.getInstance().getTabs();e.each(function(e,t){var a=g(t);if(0<a.children("ul").length){var i=a.index();s[i].clearPickingAreas(!0)}else{var n=a.parents("li").index();void 0===o[n]&&(o[n]=[]),o[n].push(a.attr("id").replace(/^picking-area-/,""))}}),g.each(o,function(a,e){g.each(e,function(e,t){s[a].removePickingArea(t,!0)})}),t.getInstance().redrawPickingAreas()}}},{key:"setSidebarDisplayFormat",value:function(e){var a=this,t=!(1<arguments.length&&arguments[1]!==d)||arguments[1];if(!/^(hex|rgb)$/.test(e))throw new Error("Invalid sidebar display format: "+e);var i="hex"===e;this._$displayFormatSwitch.attr({class:"fa fa-"+(i?"tint":"hashtag"),"data-info":"Switch to displaying colors in the sidebar in "+(i?"RGB":"HEX")+" format"}).off("click").on("click",function(e){e.preventDefault(),a.setSidebarDisplayFormat(i?"rgb":"hex");var t=g(e.target);t.is(":hover")&&y.getInstance().setInfo(t.attr("data-info"))}),this._sidebarDisplayFormat=e,this.updatePickingState(),t&&_.getInstance().set("sidebarColorFormat",e)}},{key:"clearImageOverlay",value:function(){e(this.getImageOverlayCtx())}},{key:"clearMouseOverlay",value:function(){e(this.getMouseOverlayCtx())}},{key:"updateZoomLevelInputs",value:function(){this._$zoomperc.text(g.roundTo(100*this._zoomlevel,2)+"%"),document.activeElement.blur(),this._$zoomout.prop("disabled",this._zoomlevel<=c),this._$zoomin.prop("disabled",this._zoomlevel>=h)}},{key:"updateMousePosition",value:function(e){var t=p(e),a=this.getImagePosition();this._mouseImagePos.top=Math.floor((t.pageY-a.top)/this._zoomlevel),this._mouseImagePos.left=Math.floor((t.pageX-a.left)/this._zoomlevel),y.getInstance().setPosition("mouse",this._mouseImagePos);var i=I.getInstance().getActiveTab();if(i instanceof $){var n=i.getImageSize();if(this._mouseImagePos.top<0||this._mouseImagePos.top>n.height-1||this._mouseImagePos.left<0||this._mouseImagePos.left>n.width-1)y.getInstance().setColorAt();else{var o=this.getImageCanvasCtx().getImageData(this._mouseImagePos.left,this._mouseImagePos.top,1,1).data;y.getInstance().setColorAt(new g.RGBAColor(o[0],o[1],o[2]).toHex(),g.roundTo(o[3]/255*100,2)+"%")}}}},{key:"setLevels",value:function(){var e=0<arguments.length&&arguments[0]!==d?arguments[0]:{low:0,high:255},t=!(1<arguments.length&&arguments[1]!==d)||arguments[1],a=I.getInstance().getActiveTab();if(a&&_.getInstance().get("levelsDialogEnabled")){if(t)this.getImageCanvasCtx().setRange({r:e,g:e,b:e});this._levels=e,a.saveLevels(e)}}},{key:"setZoomLevel",value:function(e,t){var a=I.getInstance().getActiveTab();if(a){var i=a.getImageSize(),n=g.clamp(e,c,h),o=void 0,s=void 0;if(this._zoomlevel!==n){o=g.scaleResize(i.width,i.height,{scale:n}),s=this._zoomlevel,this._zoomlevel=o.scale;var r=this.getPickerPosition(),l=this.getZoomedTopLeft(this.getImagePosition(),n/s,t?{top:t.pageY,left:t.pageX}:d);this.move({top:l.top-r.top,left:l.left-r.left,width:o.width,height:o.height})}a.saveZoomLevel(this._zoomlevel),this.updateZoomLevelInputs()}}},{key:"setZoomFit",value:function(){var n=this;this._fitImageHandler(function(e){var t=n._pickerWidth>n._pickerHeight,a=e.width===e.height?t:e.width>e.height,i=g.scaleResize(e.width,e.height,a?{height:n._pickerHeight}:{width:n._pickerWidth});return t&&(i.width>n._pickerWidth?i=g.scaleResize(e.width,e.height,{width:n._pickerWidth}):i.height>n._pickerHeight&&(i=g.scaleResize(e.width,e.height,{height:n._pickerHeight}))),t||(i.height>n._pickerHeight?i=g.scaleResize(e.width,e.height,{height:n._pickerHeight}):i.width>n._pickerWidth&&(i=g.scaleResize(e.width,e.height,{width:n._pickerWidth}))),i})}},{key:"setZoomOriginal",value:function(){this._fitImageHandler(function(e){return{width:e.width,height:e.height,scale:1}})}},{key:"_fitImageHandler",value:function(e){var t=I.getInstance().getActiveTab();if(t){var a=e(t.getImageSize()),i=(this._pickerHeight-a.height)/2,n=(this._pickerWidth-a.width)/2;this.move({top:i,left:n,width:a.width,height:a.height}),this._zoomlevel=a.scale,this.setZoomLevel(this._zoomlevel)}}},{key:"setPickerWidth",value:function(e){var t=g.clamp(parseFloat(e),50,85);this._$picker.width(t+"%"),this._$areasSidebar.outerWidth(100-t+"%"),this.resizeHandler()}},{key:"storeSidebarWidth",value:function(){_.getInstance().set("pickerWidth",g.roundTo(this._$picker.width()/$w.width()*100,2)+"%")}},{key:"move",value:function(e){var t=1<arguments.length&&arguments[1]!==d&&arguments[1],a=I.getInstance().getActiveTab();a&&(this._$imageOverlay.add(this._$imageCanvas).add(this._$mouseOverlay).css(e),t||a.saveImagePosition({top:this._$imageOverlay.css("top"),left:this._$imageOverlay.css("left"),width:this._$imageOverlay.css("width"),height:this._$imageOverlay.css("height")},a))}},{key:"updatePickerSize",value:function(){this._pickerWidth=this._$picker.innerWidth(),this._pickerHeight=this._$picker.innerHeight()}},{key:"resizeHandler",value:function(){this.updatePickerSize(),"number"==typeof this._zoomlevel&&this.setZoomLevel(this._zoomlevel)}},{key:"setCanvasSize",value:function(e,t){this._$mouseOverlay[0].width=this._$imageOverlay[0].width=this._$imageCanvas[0].width=e,this._$mouseOverlay[0].height=this._$imageOverlay[0].height=this._$imageCanvas[0].height=t,_.getInstance().get("levelsDialogEnabled")&&this.getImageCanvasCtx().initialize()}},{key:"openImage",value:function(e,t){var a=this,i=2<arguments.length&&arguments[2]!==d?arguments[2]:l;if(this._$picker.hasClass("loading"))throw new Error("The picker is already loading another image");this._$picker.addClass("loading"),y.getInstance().setInfo();var n=md5(e).toString(),o=I.getInstance().getTabs(),s=void 0;if(g.each(o,function(e,t){if(t.getFileHash()===n)return s=t,!1}),void 0!==s)return this._$picker.removeClass("loading"),I.getInstance().activateTab(s),void i(!0);var r=I.getInstance().newTab(t,n);r.setImage(e,function(e){a._$picker.removeClass("loading"),e?I.getInstance().activateTab(r):g.Dialog.fail("Oh no","The provided image could not be loaded. This is usually caused by attempting to open a file that is, in fact, not an image."),i(e)})}},{key:"openTab",value:function(e){var t=e.getImageSize();if(!t)throw new Error("Attempt to open a tab without an image");this._$imageCanvas.appendTo(this._$picker),this.setCanvasSize(t.width,t.height),e.drawImage();var a=e.loadImagePosition();if(a){this.move(a,!0);var i=e.loadZoomLevel();void 0!==i&&(this._zoomlevel=i,this.setZoomLevel(i))}else this.setZoomFit();this.setLevels(e.loadLevels()||this._levels),this.setPickingSize(e.loadPickingSize()),this.updatePickerSize(),this.redrawPickingAreas()}},{key:"clearImage",value:function(){I.getInstance().getActiveTab()&&(this._$imageCanvas.detach(),this._$mouseOverlay.removeClass("picking zooming"),e(this.getImageCanvasCtx()),e(this.getImageOverlayCtx()),y.getInstance().setColorAt(),y.getInstance().setPosition("mouse"),this._zoomlevel=1,this.updateZoomLevelInputs(),g.Dialog.close())}},{key:"moveMode",value:function(e){var t=1<arguments.length&&arguments[1]!==d&&arguments[1],a=this._activeTool===n.hand;!e||this._moveMode||!t&&a?e||!this._moveMode||!t&&a||(this._moveMode=!1,this._$imageOverlay.removeClass("draggable dragging")):(this._moveMode=!0,this._$imageOverlay.addClass("draggable"))}},{key:"getImageCanvasCtx",value:function(){var e=_.getInstance().get("levelsDialogEnabled");return this._$imageCanvas[0].getContext(e?"hdr2d":"2d")}},{key:"getImageOverlayCtx",value:function(){return this._$imageOverlay[0].getContext("2d")}},{key:"getMouseOverlayCtx",value:function(){return this._$mouseOverlay[0].getContext("2d")}},{key:"switchTool",value:function(e){if(this._activeTool!==e){switch(this._activeTool){case n.hand:this.moveMode(!1,!0);break;case n.picker:this._$mouseOverlay.removeClass("picking"),this.clearMouseOverlay();break;case n.zoom:this._$mouseOverlay.removeClass("zooming")}switch(n[e]){case n.hand:this.moveMode(!0,!0);break;case n.picker:this._$mouseOverlay.addClass("picking");break;case n.zoom:this._$mouseOverlay.addClass("zooming")}"zoom"!==e&&this._$zoomTool.removeClass("selected"),"picker"!==e&&this._$pickerTool.removeClass("selected"),"hand"!==e&&this._$handTool.removeClass("selected"),this["_$"+e+"Tool"].addClass("selected"),this._activeTool=n[e]}}},{key:"shouldCopyHash",value:function(){return _.getInstance().get("copyHash")}}],[{key:"getInstance",value:function(){return void 0===a.picker&&(a.picker=new t),a.picker}}]),t}();b.getInstance(),y.getInstance(),I.getInstance(),S.getInstance(),$body.on("keydown",function(e){var t=e.target.tagName.toLowerCase();if(("input"!==t||"file"===e.target.type)&&"textarea"!==t&&null===e.target.getAttribute("contenteditable")){switch(e.keyCode){case Key[0]:if(!e.ctrlKey||e.altKey)return;S.getInstance().setZoomFit();break;case Key[1]:if(!e.ctrlKey||e.altKey)return;S.getInstance().setZoomOriginal();break;case Key.Space:if(e.ctrlKey||e.altKey)return;S.getInstance().moveMode(!0);break;case Key.H:S.getInstance().switchTool(n.hand);break;case Key.I:S.getInstance().switchTool(n.picker);break;case Key.O:if(!e.ctrlKey||e.altKey)return;e.shiftKey?b.getInstance().requestFilePaste():b.getInstance().requestFileOpen();break;case Key.Z:S.getInstance().switchTool(n.zoom);break;case Key.UpArrow:if(e.ctrlKey||e.altKey)return;S.getInstance().increasePickingSize(!e.altKey);break;case Key.DownArrow:if(e.ctrlKey||e.altKey)return;S.getInstance().decreasePickingSize(!e.altKey);break;case Key.Delete:if(e.ctrlKey||e.altKey)return;S.getInstance().deleteSelectedAreas();break;case Key.A:if(!e.ctrlKey||e.altKey)return;S.getInstance().selectAllAreas(e.shiftKey);break;default:return}e.preventDefault()}}),$body.on("keyup",function(e){var t=e.target.tagName.toLowerCase();if(("input"!==t||"file"===e.target.type)&&"textarea"!==t&&null===e.target.getAttribute("contenteditable")){switch(e.keyCode){case Key.Space:if(e.ctrlKey||e.altKey)return;S.getInstance().moveMode(!1);break;case Key.Alt:break;default:return}e.preventDefault()}}),$body.on("paste","[contenteditable]",function(e){var t="",a=g(this);if(e.clipboardData?t=e.clipboardData.getData("text/plain"):window.clipboardData?t=window.clipboardData.getData("Text"):e.originalEvent.clipboardData&&(t=g.mk("div").text(e.originalEvent.clipboardData.getData("text"))),document.queryCommandSupported("insertText"))return document.execCommand("insertHTML",!1,g(t).html()),!1;a.find("*").each(function(){g(this).addClass("within")}),setTimeout(function(){a.find("*").each(function(){g(this).not(".within").contents().unwrap()})},1)}),$body.on("mouseenter","[data-info]",function(){y.getInstance().setInfo(g(this).attr("data-info"))}).on("mouseleave","[data-info]",function(){y.getInstance().setInfo()}).on("dragover dragend",function(e){e.stopPropagation(),e.preventDefault()}).on("drop",function(e){e.preventDefault();var a=e.originalEvent.dataTransfer.files;if(0!==a.length){var t=1!==a.length?"s":"";g.Dialog.wait("Drag and drop","Reading dropped file"+t+", please wait");var i=0;!function t(){void 0!==a[i]?b.getInstance().handleFileOpen(a[i],function(e){if(e)return i++,t();g.Dialog.fail("Drag and drop","Failed to read file #"+i+", aborting")}):g.Dialog.close()}()}}),window.Plugin=a}(jQuery);