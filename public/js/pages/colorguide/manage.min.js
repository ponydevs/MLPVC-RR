"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var a=arguments[e];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(t[n]=a[n])}return t},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function n(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(f){var r=window.TAG_TYPES_ASSOC,e=void 0,o=window.HEX_COLOR_PATTERN,s="WebkitAppearance"in document.documentElement.style,d=window.EQG,v=window.PRINTABLE_ASCII_PATTERN,p=!!window.AppearancePage,u=window.PersonalGuide,c=u?"/@"+u:"",n=window.TAG_NAME_REGEX,h=function(t,e,a){var n=[];a&&a[1]||n.push("HEX color"),a&&a[2]||n.push("color name"),this.message="Parse error on line "+e+' (shown below)\n\t\t\t\t<pre style="font-size:16px"><code>'+t.replace(/</g,"&lt;")+"</code></pre>\n\t\t\t\t"+(n.length?"The "+n.join(" and ")+" is missing from this line.":"Please check for any typos before continuing."),this.lineNumber=e},g=$.mk("form","sprite-upload").html((u?'<div class="notice info"><label>About sprites</label><p>Sprites are small, pixelated images showcasing all of the colors a given character has. They are most useful if they contain a full body image of your character with any difficult details highlighted. You can use it together with the notes, adding explanations about anything that might be confusing.</p><p>Sprites have a height limit of 300px, a width limit between 300 and 700 pixels, and are expected to be PNG files with a transparent background.</p><p>We provide templates that fit these guidelines for anyone to use through the <a class="sprite-template-gen">Template Generator</a>. If you decide to use this generator, you must add at least the mane and tail before uploading the sprite to the site.</p><p class="color-red">The staff reserves the right to remove any sprites that do not follow these guidelines.</p></div>':"")+'<p class="align-center"><a class="upload-link">Click here to upload a file</a> (max. '+window.MAX_SIZE+') or enter a URL below.</p>\n\t\t<label><input type="text" name="image_url" placeholder="External image URL" required></label>\n\t\t<p class="align-center">The URL will be checked against the supported provider list, and if an image is found, it\'ll be downloaded to the server and set as this appearance\'s sprite image.</p>');p&&$("#relatedShows"),$.fn.reorderTags=function(){return this.each(function(){$(this).children(".tag").sort(function(t,e){var a=/^.*typ-([a-z]+).*$/;return t=[t.className.replace(a,"$1"),t.innerHTML.trim()],e=[e.className.replace(a,"$1"),e.innerHTML.trim()],t[0]===e[0]?t[1].localeCompare(e[1]):t[0].localeCompare(e[0])}).appendTo(this)})};var a=$.mk("form","pony-editor").append('<label>\n\t\t\t\t\t<span>Name (2-70 chars.)</span>\n\t\t\t\t\t<input type="text" name="label" placeholder="Enter a name" pattern="'+v.replace("+","{2,70}")+'" required maxlength="70">\n\t\t\t\t</label>\n\t\t\t\t<div class="label">\n\t\t\t\t\t<span>Additional notes (1000 chars. max, optional)</span>\n\t\t\t\t\t<div class="ace_editor"></div>\n\t\t\t\t</div>\n\t\t\t\t<label><input type=\'checkbox\' name=\'private\'> Make private (only '+(u?"you and staff":"staff")+" can see added colors)</label>"),i=function(t,l,o){var r=!!o,s=t.parents("[id^=p]").find(".notes"),c=void 0;if(p){if(!r)return;c=$content.children("h1")}else c=t.siblings().first();$.Dialog.request(l,a.clone(!0,!0),"Save",function(a){var n=void 0,i=$.codeFlask(a.find(".ace_editor").get(0),"html");r&&o.notes&&i.updateCode(o.notes),r?(n=o.appearanceID,a.find("input[name=label]").val(o.label),o.cm_preview&&a.find("input[name=cm_preview]").val(o.cm_preview),o.cm_dir&&a.find("input[name=cm_dir]").enable().filter("[value="+o.cm_dir+"]").prop("checked",!0),o.private&&a.find("input[name=private]").prop("checked",!0),a.append($.mk("div").attr("class","align-center").append($.mk("button").attr("class","orange typcn typcn-media-eject").text("Selective wipe").on("click",function(t){t.preventDefault();var e=o.label,a=$.mk("form","selective-wipe").html('<p>Select which of the following actions to execute below.</p>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cache"> Clear cached images</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cm_tokenized"> Clear tokenized cutie mark</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cm_source"> Clear cutie mark source file</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_sprite"> Clear sprite image</label>\n\t\t\t\t\t\t\t\t\t\t\t<fieldset>\n\t\t\t\t\t\t\t\t\t\t\t\t<legend>Color Groups</legend>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="" checked><span>Nothing</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="color_hex"><span>HEX values</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="color_all"><span>Colors</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="all"><span>Color groups</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</fieldset>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_notes"> Clear notes</label>\n\t\t\t\t\t\t\t\t\t\t\t'+(u?"":'<label><input type="checkbox" name="wipe_tags"> Remove all tags</label>')+'\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="mkpriv"> Make private</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="reset_priv_key"> Generate new private sharing key</label>');$.Dialog.close(),$.Dialog.request("Selectively wipe data from "+e,a,"Clear data",function(){a.on("submit",function(t){t.preventDefault();var e=a.mkData();if(e.wipe_colors||delete e.wipe_colors,0===Object.keys(e).length)return $.Dialog.fail(!1,"You didn't select any data to clear");$.Dialog.clearNotice(/select any data/),$.Dialog.confirm(!1,"The action you are about to perform is irreversible. Are you sure you want to proceed?",["Wipe selected data","Changed my mind"],function(t){t&&($.Dialog.wait(!1),$.API.delete("/cg/appearance/"+n+"/selective",e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Navigation.reload(!0)})))})})})}),$.mk("button").attr({class:"darkblue typcn typcn-pencil cg-cm-editor"}).text("Cutie Mark").on("click",function(t){t.preventDefault();var e=o.label;$.Dialog.close(),$.Dialog.wait("Manage Cutie Mark of "+e,"Retrieving CM data from server"),$.API.get("/cg/appearance/"+n+"/cutiemarks",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);A.factory(!1,n,e,this)}))})))):a.append("<label><input type='checkbox' name='template'> Pre-fill with common color groups</label>"),a.on("submit",function(t){t.preventDefault();var e=a.mkData();e.notes=i.getCode(),$.Dialog.wait(!1,"Saving changes"),p&&(e.APPEARANCE_PAGE=!0),u&&(e.PERSONAL_GUIDE=!0),d&&(e.eqg=!0),$.API[r?"put":"post"]("/cg/appearance"+(r?"/"+n:""),e,$.mkAjaxHandler(function(t){if(!t.status)return $.Dialog.fail(!1,t.message);if(r)return p?$.Navigation.reload(!0):(c.text(t.label),t.newurl&&c.attr("href",t.newurl),s.html(t.notes),void $.Dialog.close());$.Dialog.success(!1,"Appearance added");var e=function(){$.Dialog.wait(!1,"Loading appearance page"),$.Navigation.visit(t.goto)};if(!t.info)return e();$.Dialog.segway(l,t.info,"View appearance page",e)}))})})};$("#new-appearance-btn").on("click",function(){var t=$(this),e=t.text().trim();if(!u)return i(t,e);$.Dialog.wait(e,"Checking whether there are available slots"),$.API.get("/user/"+u+"/pcg/slots",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);i(t,e)}))});var m=$.mk("form","edit-tag");m.append('<label><span>Tag name (3-64 chars.)</span><input type="text" name="name" required pattern="^[^-][ -~]{1,29}$" maxlength="64"></label>');var l='<div class=\'type-selector\'>\n\t\t\t<label>\n\t\t\t\t<input type="radio" name="type" value="" checked>\n\t\t\t\t<span class="tag">Typeless</span>\n\t\t\t</label>';$.each(r,function(t,e){l+='<label>\n\t\t\t\t<input type="radio" name="type" value="'+t+'">\n\t\t\t\t<span class="tag typ-'+t+'">'+e+"</span>\n\t\t\t</label>"}),l+="</div>",m.append('<div class="align-center">\n\t\t\t<span>Tag type</span><br>\n\t\t\t'+l+'\n\t\t</div>\n\t\t<label>\n\t\t\t<span>Tag description (max 255 chars., optional)</span>\n\t\t\t<textarea name="title" maxlength="255"></textarea>\n\t\t</label>',$.mk("div").attr("class","align-center edit-only").append($.mk("button").attr("class","blue typcn typcn-flow-children synon").html("Synonymize&hellip;").on("click",function(t){t.preventDefault();var e=$(this).closest("form").data("tag"),a=e.name,l=e.id;$.Dialog.close(function(){window.CGTagEditing(a,l,"synon",function(t){var e=$(".tag.id-"+l),a=void 0;if(e.length)switch(t){case"synon":a=this.target,e.addClass("synonym");var n=e.eq(0).clone().removeClass("ctxmenu-bound"),i=e.add($(".tag.id-"+a.id)).closest(".tags");i.filter(function(){return 0===$(this).children(".id-"+l).length}).append(n).reorderTags(),i.filter(function(){return 0===$(this).children(".id-"+a.id).length}).append(void 0).reorderTags(),S();break;case"unsynon":this.keep_tagged?e.removeClass("synonym"):e.remove()}$.Dialog.close()})})})));var b=new(function(){function t(){_classCallCheck(this,t),this.clear()}return _createClass(t,[{key:"set",value:function(t,e){return this.cache[t]=e}},{key:"get",value:function(t){return this.cache[t]}},{key:"has",value:function(t){return this.cache.hasOwnProperty(t)}},{key:"clear",value:function(){this.cache={}}}]),t}());var k,y,x,C=(k=void 0,{read:function(){return new Promise(function(t,e){if(void 0===k){var a={};u&&(a.PERSONAL_GUIDE=u),$.API.get("/cg/appearances/list",a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Appearance list retrieval",this.message);k=this.list,t(k)})).fail(function(){e()})}else t(k)})}}),D=(y={},{read:function(t){return a=t,new Promise(function(t,e){void 0===y[a]?$.API.get("/cg/appearance/"+a+"/link-targets",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Color group list retrieval",this.message);y[a]=this.list,t(y[a])})).fail(function(){e()}):t(y[a])});var a}}),w=function(){function n(t){var l=this,e=1<arguments.length&&arguments[1]!==f?arguments[1]:{};_classCallCheck(this,n),this.mode="gui",this.editing="object"===(void 0===e?"undefined":_typeof(e))&&e.label&&e.Colors,void 0!==t&&(t instanceof jQuery?(this.group_id=t.attr("id").replace(/\D/g,""),this.appearance_id=parseInt(t.parents("[id^=p]").attr("id").substring(1),10)):this.appearance_id=parseInt(t,10)),this.colorAppearanceDataCache={},this.templates={$inputMethodDropdown:$.mk("select").attr({class:"clrmthd",required:!0}).html('<option value="hex">Hex</option>\n\t\t\t\t\t\t<option value="link">Link</option>').on("change",function(t){var e=$(t.target);e.closest(".clr").removeClass("mthd-hex mthd-link").addClass("mthd-"+e.children("option:selected").attr("value"))}),$appearanceSelector:$.mk("select").attr("class","clrla").html('<option value="" selected data-default>(appearance)</option>').on("mouseenter",function(t){var e=$(t.target);e.hasClass("loaded")||(e.disable(),C.read().then(function(t){var a=$.mk("optgroup").attr("label","Pony Guide"),n=$.mk("optgroup").attr("label","EQG Guide"),i=$.mk("optgroup").attr("label","Personal Color Guide");!0===d?e.append(n,a):!1===d?e.append(a,n):e.append(i),$.each(t,function(t,e){(null===e.ishuman?i:e.ishuman?n:a).append($.mk("option").attr({value:e.id}).text(e.label))}),e.addClass("loaded").enable()}))}).on("change",function(t){var e=$(t.target),a=e.find("option:selected"),n=a.attr("value"),i=a.text();isNaN(n)||l.loadColorSelectFor(e,n,i)}),$colorSelector:$.mk("select").attr({class:"clrlc hidden",disabled:!0}).html('<option value="" selected data-default>(color)</option>\n\t\t\t\t\t\t<option value="\n" class="appearance-name-option" disabled></option>\n\t\t\t\t\t\t<option value="\n" data-appearance-switch>(change appearance)</option>\n\t\t\t\t\t\t<option value="\n" disabled>----------</option>').on("change",function(t){var e=$(t.target);e.children("option:selected").hasAttr("data-appearance-switch")&&e.addClass("hidden").disable().prev().val("").removeClass("hidden")}),$colorInput:$.mk("input").attr({class:"clri",autocomplete:"off",spellcheck:"false"}).patternAttr(o).on("keyup change input",function(t,e){n.validateColorInput(t,e)}).on("paste blur keyup",function(t){var e=function(){return l.expandColorInput(t)};"paste"===t.type?setTimeout(e,10):e()}),$colorLabel:$.mk("input").attr({class:"clrl",list:"common-color-names",pattern:v.replace("+","{3,30}"),maxlength:30,required:!0}),$colorActions:$.mk("div").attr("class","clra").append($.mk("span").attr({class:"typcn typcn-trash remove red",title:"Remove"}).on("click",function(t){var e=$(t.target);e.closest(".clr").addClass("faded").find("input:not(:disabled), select:not(:disabled)").disable().addClass("fade-disabled"),e.addClass("hidden").next().removeClass("hidden")}),$.mk("span").attr({class:"typcn typcn-arrow-back add green hidden",title:"Restore"}).on("click",function(t){var e=$(t.target);e.closest(".clr").removeClass("faded").find(".fade-disabled").enable().removeClass("fade-disabled"),e.addClass("hidden").prev().removeClass("hidden")}),$.mk("span").attr("class","typcn typcn-arrow-move move blue"))},this.$addBtn=$.mk("button").attr("class","typcn typcn-plus green add-color").text("Add new color").on("click",function(t){t.preventDefault(),l.addColor()}),this.$editorToggle=$.mk("button").attr("class","typcn typcn-document-text darkblue").text("Plain text editor").on("click",function(t){t.preventDefault();var e=$(t.target);e.disable();try{l.saveColorInputs()}catch(t){if(!(t instanceof h))throw t;return $.Dialog.fail(!1,t.message),l.flask.elTextarea.focus(),void e.enable()}e.toggleClass("typcn-document-text typcn-edit").toggleHtml(["Plain text editor","Interactive editor"]).enable(),$.Dialog.clearNotice(/Parse error on line \d+ \(shown below\)/)}),this.$form=$.mk("form","cg-editor").append($.mk("label").append("<span>Group name (2-30 chars.)</span>",$.mk("input").attr({type:"text",name:"label",pattern:v.replace("+","{2,30}"),required:!0,list:"common-cg-names"}).val(this.editing?e.label:f),'<datalist id="common-cg-names">\n\t\t\t\t\t\t<option>Coat</option>\n\t\t\t\t\t\t<option>Mane & Tail</option>\n\t\t\t\t\t\t<option>Eyes</option>\n\t\t\t\t\t\t<option>Iris</option>\n\t\t\t\t\t\t<option>Cutie Mark</option>\n\t\t\t\t\t\t<option>Magic</option>\n\t\t\t\t\t</datalist>'),u?f:$.mk("label").append($.mk("input").attr({type:"checkbox",name:"major"}).on("click change",function(){$(this).parent().next()[this.checked?"removeClass":"addClass"]("hidden").children("input").prop("disabled",!this.checked)}),"<span>This is a major change</span>"),"<label class=\"hidden\">\n\t\t\t\t\t<span>Change reason (1-255 chars.)</span>\n\t\t\t\t\t<input type='text' name='reason' pattern=\""+v.replace("+","{1,255}")+'" required disabled>\n\t\t\t\t</label>\n\t\t\t\t<p class="align-center">Each color must have a short (3-30 chars.) description.'+(u?"<br>The editor rounds RGB values: ≤3 to 0 and ≥252 to 255.":"")+"<br>Rows that have a label will always be saved.</p>",$.mk("div").attr("class","btn-group").append(this.$addBtn,this.$editorToggle),$.mk("div").attr("class","clrs").append(this.makeColorDiv()),'<datalist id="common-color-names">\n\t\t\t\t\t<option>Outline</option>\n\t\t\t\t\t<option>Fill</option>\n\t\t\t\t\t<option>Shadow Outline</option>\n\t\t\t\t\t<option>Shadow Fill</option>\n\t\t\t\t\t<option>Gradient Top</option>\n\t\t\t\t\t<option>Gradient Middle</option>\n\t\t\t\t\t<option>Gradient Bottom</option>\n\t\t\t\t\t<option>Highlight Top</option>\n\t\t\t\t\t<option>Highlight Bottom</option>\n\t\t\t\t</datalist>').on("submit",function(t){t.preventDefault();try{l.saveColorInputs(!0)}catch(t){if(!(t instanceof h))throw t;return $.Dialog.fail(!1,t.message),void l.flask.elTextarea.focus()}var a=l.$form.mkData(),n=l.appearance_id;if(a.Colors=[],$.each(l.colorValues,function(t,e){e.deleted||a.Colors.push(e)}),l.editing||(a.ponyid=l.appearance_id),0===a.Colors.length)return $.Dialog.fail(!1,"You need to add at least one valid color");a.Colors=JSON.stringify(a.Colors),p&&(a.APPEARANCE_PAGE=!0);var i=$("#changes");i.length||(a.FULL_CHANGES_SECTION=!0),$.Dialog.wait(!1,"Saving changes"),$.API[l.editing?"put":"post"]("/cg/colorgroup"+(l.editing?"/"+l.group_id:""),a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.cgs){var t=$("#p"+n);if(this.cgs&&t.find("ul.colors").html(this.cgs),!p&&this.notes)t.find(".notes").html(this.notes);if(this.update){var e=t.find(".update");e.length?e.replaceWith(this.update):$(this.update).insertAfter(t.find("strong"))}this.changes&&(i.length?i.replaceWith(this.changes):$(this.changes).insertBefore($("#tags"))),S(),(this.update||this.changes)&&Time.update(),p&&this.cm_list&&$("#pony-cm-list").html(this.cm_list),$.Dialog.close()}else $.Dialog.close()}))}),this.editing&&this.setColorValues(e.Colors).renderColorInputs()}return _createClass(n,[{key:"expandColorInput",value:function(t){var e=t.target,n=$.RGBAColor.parse(e.value);if(null!==n){var a=$(e);switch(u||$.each($.RGBAColor.COMPONENTS,function(t,e){var a=n[e];a<=3?n[e]=0:252<=a&&(n[e]=255)}),n=n.toHex(),t.type){case"paste":a.next().focus();case"blur":a.val(n)}a.trigger("change",[n])}}},{key:"makeColorDiv",value:function(e){var t=this.templates.$inputMethodDropdown.clone(!0,!0),a=this.templates.$colorInput.clone(!0,!0),n=this.templates.$colorLabel.clone(),i=this.templates.$colorActions.clone(!0,!0),l=this.templates.$appearanceSelector.clone(!0,!0),o=this.templates.$colorSelector.clone(!0,!0),r=$.mk("div").attr("class","clr mthd-hex"),s=void 0;return r.append(t,l,o),"object"===(void 0===e?"undefined":_typeof(e))&&(e.hex&&a.val(e.hex.toUpperCase()),e.label&&n.val(e.label),e.id&&(s=$.mk("span").attr("class","clrid").text("ID:"+e.id)),e.linked_to&&(t.val("link").triggerHandler("change"),void 0!==e.appearance?this.colorAppearanceDataCache[e.id]=e.appearance:e.appearance=this.colorAppearanceDataCache[e.id],this.loadColorSelectFor(l,e.appearance.id,e.appearance.label).then(function(t){t.val(e.linked_to)}))),r.append("<span class='clrp'></span>",a,n,s,i),a.triggerHandler("change"),"object"===(void 0===e?"undefined":_typeof(e))&&e.deleted&&i.find(".remove").triggerHandler("click"),r}},{key:"addColor",value:function(){var t=this.$form.children(".clrs");if(t.length||(t=$.mk("div").attr("class","clrs"),this.$form.append(t)),"gui"===this.mode){var e=this.makeColorDiv();t.append(e),e.find(".clri").focus()}else this.flask.updateCode(this.flask.getCode()+"\n"+(copyHashEnabled?"#":"")+"\t"),this.flask.focus()}},{key:"renderColorInputs",value:function(){var a=this,n=this.getCleanClrsDiv();$.each(this.colorValues,function(t,e){n.append(a.makeColorDiv(e))}),n.sortable({handle:".move",ghostClass:"moving",scroll:!1,animation:150})}},{key:"saveColorInputs",value:function(t){var e=this.$form.children(".clrs");if("gui"===this.mode){var d=[];if(e.children(".clr").each(function(){var t=$(this),e=t.children(".clrmthd"),a=e.is(":disabled"),n=e.find("option:selected").attr("value"),i=t.children(".clrid"),l=i.length?i.text().replace("ID:",""):f;switch(n){case"hex":var o=t.children(".clri").val(),r=$.RGBAColor.parse(o),s=null!==r;d.push({id:l,hex:s?r.toHex():o||"",label:t.children(".clrl").val(),deleted:a});break;case"link":var c=t.children(".clrlc");d.push({id:l,hex:f,label:t.children(".clrl").val(),linked_to:c.val(),deleted:a})}}),this.colorValues=d,t)return;var i=["// One color per line, e.g. #012ABC Fill"];$.each(d,function(t,e){var a="";if("object"===(void 0===e?"undefined":_typeof(e))){var n=[];e.linked_to?n.push("@"+e.linked_to):n.push(e.hex?e.hex:"#"),n.push(e.label||""),e.id&&n.push("ID:"+e.id),a=(e.deleted?"//":"")+n.join("\t")}i.push(a)}),this.destroySortable(),e.empty().addClass("code-editor"),this.flask=$.codeFlask(e[0],"colorguide"),this.flask.updateCode(i.join("\n")+"\n"),$(this.flask.elTextarea).css("tab-size","8"),this.flask.elTextarea.focus(),this.mode="text"}else{if(this.colorValues=n.parseColorsText(this.flask.getCode()),t)return;this.flask=null,e.removeClass("code-editor"),this.renderColorInputs(),this.mode="gui"}}},{key:"setColorValues",value:function(t){return this.colorValues=t,this}},{key:"getForm",value:function(){return this.$form}},{key:"destroySortable",value:function(){this.getClrsDiv().sortable("destory")}},{key:"getClrsDiv",value:function(){return this.$form.find(".clrs")}},{key:"getCleanClrsDiv",value:function(){var t=$.mk("div").attr("class","clrs");return this.getClrsDiv().replaceWith(t),t}},{key:"loadColorSelectFor",value:function(a,t,n){var i=a.next(),l=parseInt(a.siblings().filter(".clrid").text().replace("ID:",""),10);return a.disable(),new Promise(function(e){D.read(t).then(function(t){i.children("optgroup").remove(),i.children(".appearance-name-option").text(n),$.each(t,function(t,e){var a=$.mk("optgroup").attr("label",e.label);i.append(a),$.each(e.colors,function(t,e){a.append($.mk("option").attr({value:e.id,disabled:void 0===e.id||e.id===l}).text(e.label))})}),a.enable().addClass("hidden"),i.enable().val("").removeClass("hidden"),e(i)})})}}],[{key:"factory",value:function(t,e,a){$.Dialog.request(t,new n(e,a).getForm(),"Save")}},{key:"validateColorInput",value:function(t,e){var a=$(t.target),n=a.prev(),i=("string"==typeof e?e:a.val()).trim();o.test(i)?n.removeClass("invalid").css("background-color",i.replace(o,"#$1")):n.addClass("invalid").css("background-color","")}},{key:"parseColorsText",value:function(t){for(var e=[],a=t.split("\n"),n=0,i=a.length;n<i;n++){var l=a[n],o=l.trim();if(!/^(\/\/($|[^#@].*))?$/.test(o))if("#"!==o){var r=o.match(/^(?:(\/\/)?#?(?:([a-f\d]{0,6})?|@(\d+)))?\s+(?:([ -~]{3,30}))?(?:\s*ID:(\d+))?$/i);if(!r||!r[4])throw new h(l,n+1,r);var s=$.RGBAColor.parse(r[2]);e.push({hex:null!==s?s.toHex():r[2]?"#"+r[2]:"",label:r[4],id:r[5],linked_to:r[3]?r[3]:null,deleted:!!r[1]})}else e.push({hex:f,label:""})}return e}}]),n}(),A=function(){function i(a,t,e){var n=this;_classCallCheck(this,i),this.appearance_id=a,this.appearance_label=t,this.$cmSection=$content.find("section.approved-cutie-mark"),this.$CMPreview=$.mk("ul").attr("class","dialog-preview"),this.$CMList=$.mk("ul").attr("class","cm-list"),this.$AddNewButton=$.mk("button").attr("class","green typcn typcn-plus").text("Add new cutie mark").on("click",function(t){t.preventDefault(),n.$CMList.append(n.crateCutiemarkDataLi()),n.$AddNewButton[4<=n.$CMList.children().length?"disable":"enable"]()}),this.$DeleteButton=$.mk("button").attr("class","red typcn typcn-trash").text("Delete all").on("click",function(t){t.preventDefault(),n.$CMList.children(":not(.faded)").find("legend > .remove").trigger("click"),n.$DeleteButton.disable("noop-disabled")}),this.$BottomActionGroup=$.mk("div").attr("class","btn-group").append(this.$AddNewButton),this.$form=$.mk("form","cm-data-editor").append(this.$CMList,this.$BottomActionGroup,$.mk("div").attr("class","notice info").append($.mk("p").append("<strong>Potential issues:</strong> ","<button>File size issue</button>","<button>Inverted colors</button>","<button>Gradients to black</button>","<button>Blank space around</button>",'<button class="darkblue typcn typcn-minus" disabled>Close</button>'),'<div class="issue-descriptions">\n\t\t\t\t\t\t<p class="hidden">Generally vector files are very light (~10KB max.) so if your file exceeds 1 MB you will see an error. This can indicate that an embedded image (such as a screencap) was left inside the vector file.</p>\n\t\t\t\t\t\t<p class="hidden">If you see any inverted colors that means those colors are not in the guide. Make sure the colors that are displayed incorrectly match the ones in the guide.</p>\n\t\t\t\t\t\t<p class="hidden">If you see gradients to black throughout then those colors used Inkscape\'s Swatches feature and the site simulates how the vector would appear in Adobe Illustator. You\'ll have to change those colors to regular fills to avoid this.</p>\n\t\t\t\t\t\t<div class="hidden">\n\t\t\t\t\t\t\t<p>If the cutie mark has a lot of transparent space around it that means the canvas/artboard is not cropped properly. This is strongly recommended for optimal display on the site and to make it easier to reuse. To fix this:</p>\n\t\t\t\t\t\t\t<p><strong>In Illustrator:</strong> Object &rsaquo; Artboards (at the bottom) &rsaquo; Fit to Artwork Bounds</p>\n\t\t\t\t\t\t\t<p><strong>In Inkscape:</strong> File &rsaquo; Document Properties&hellip; &rsaquo; Custom size &rsaquo; Resize page to content&hellip; &rsaquo; Resize page to drawing or selection</p>\n\t\t\t\t\t</div>').on("click","button",function(t){t.preventDefault();var e=$(t.target);e.disable().siblings().enable(),e.parent().next().children().addClass("hidden").eq(e.index()-1).removeClass("hidden")})).on("submit",function(t){t.preventDefault();var o=[],r=!1;if(n.$CMList.children(":not(.faded)").each(function(t,e){var a=$(e),n={};a.hasAttr("id")&&(n.id=parseInt(a.attr("id").replace(/\D/g,"")));var i=a.find(".svg-replace");if(i.find('input[type="checkbox"]').is(":checked")&&(n.svgdata=i.find(".svg-replace-preview").data("svgdata"),!n.svgdata))return r=!0,$.Dialog.fail(!1,"SVG data missing for "+$.nth(t+1)+" cutie mark");n.label=a.find(".custom-label").val(),n.facing=a.find(".radio-group.orientation input:checked").attr("value"),n.attribution=a.find(".radio-group.attrib-method-radios input:checked").attr("value");var l=a.find(".attrib-method-list input:not(:disabled)");l.length&&(n[l.attr("name")]=l.val()),n.rotation=a.find(".rotation-range").val(),o.push(n)}),!r){var e={CMData:JSON.stringify(o)};p&&(e.APPEARANCE_PAGE=!0),$.Dialog.wait(!1,"Saving cutie mark data"),$.API.put("/cg/appearance/"+a+"/cutiemarks",e,$.mkAjaxHandler(function(t){if(!t.status)return $.Dialog.fail(!1,t.message);$.Dialog.close(),n.$cmSection.length&&(n.$cmSection.children(":not(h2,p)").remove(),n.$cmSection.removeClass("hidden").append(t.html))}))}}).on("change input",".rotation-range",function(t){var e=$(t.target),a=e.val();e.prev().children(".rotation-display").text(a)}),e.cms.length?($.each(e.cms,function(t,e){n.$CMList.append(n.crateCutiemarkDataLi(e))}),this.updateRanges(),this.$BottomActionGroup.append(this.$DeleteButton)):this.$CMList.append(this.crateCutiemarkDataLi())}return _createClass(i,[{key:"getForm",value:function(){return this.$form}},{key:"updateRange",value:function(t){var e=$.Event("change");e.target=t,this.$form.trigger(e)}},{key:"updateRanges",value:function(){var a=this;this.$CMList.find(".rotation-range").each(function(t,e){a.updateRange(e)})}},{key:"crateCutiemarkDataLi",value:function(t){var l=this,e=void 0!==t;e||(t={});var a=t.id?"facing-"+t.id:$.randomString(),n=t.id?"attribution-"+t.id:$.randomString(),i=$.mk("div").html('<p>Body orientation</p>\n\t\t\t\t<div class="radio-group orientation">\n\t\t\t\t\t<label><input type="radio" name="'+a+'" value="left" required><span>Left</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+a+'" value="right" required><span>Right</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+a+'" value="" required><span>Symmetrical</span></label>\n\t\t\t\t</div>');"string"!=typeof t.facing&&null!==t.facing||i.find("input[value='"+(null===t.facing?"":t.facing)+"']").prop("checked",!0);var o=void 0!==t.rotation?t.rotation:0,r=$.mk("div").attr("class","label").html('<p>Attribution</p>\n\t\t\t\t<div class="radio-group attrib-method-radios">\n\t\t\t\t\t<label><input type="radio" name="'+n+'" value="none" required checked><span>None</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+n+'" value="user" required><span>User</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+n+'" value="deviation" required><span>Deviation</span></label>\n\t\t\t\t</div>').on("change input",".attrib-method-radios input",function(t){var e,a,n,i;e=t.target,a=t.target.value,n=$(e),(i=n.closest(".label").next().children()).addClass("hidden").find("input").disable("attrib-disabled"),n.is(":checked")&&i.filter("."+a).removeClass("hidden").find("input").enable("attrib-disabled")}),s=$.mk("div").attr("class","attrib-method-list").append('<div class="attrib-method user hidden">\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<span>Username</span>\n\t\t\t\t\t\t<input type="text" name="username" maxlength="20" required disabled class="attrib-disabled">\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t\t<div class="attrib-method deviation hidden">\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<span>Deviation link</span>\n\t\t\t\t\t\t<input type="url" name="deviation" required disabled class="attrib-disabled">\n\t\t\t\t\t</label>\n\t\t\t\t</div>');if(e&&(t.deviation&&(s.find('input[name="deviation"]').val(t.deviation).enable("attrib-disabled").closest(".hidden").removeClass("hidden"),r.find('input[value="deviation"]').prop("checked",!0)),t.username)){var c=s.find('input[name="username"]').val(t.username);t.deviation||(c.enable("attrib-disabled").closest(".hidden").removeClass("hidden"),r.find('input[value="user"]').prop("checked",!0))}var d=$.mk("button").attr({class:"btn typcn typcn-minus collapse",title:"Hide inputs but retain values"}).text("Collapse").on("click",function(t){t.preventDefault();var e=$(t.target),a=e.closest("li");e.parent().nextAll(":not(.hidden)").addClass("hidden collapse-hidden"),e.addClass("hidden").next().removeClass("hidden"),a.addClass("collapsed")}),p=$.mk("button").attr({class:"btn typcn typcn-plus hidden expand",title:"Reveal inputs"}).text("Expand").on("click",function(t){t.preventDefault();var e=$(t.target),a=e.closest("li");e.parent().nextAll(".collapse-hidden").removeClass("hidden collapse-hidden"),e.addClass("hidden").prev().removeClass("hidden"),a.removeClass("collapsed")}),u=$.mk("button").attr({class:"btn red typcn typcn-trash remove",title:"Delete cutie mark on save"}).text("Remove").on("click",function(t){t.preventDefault();var e=$(t.target),a=e.closest("li");a.addClass("faded").find("input:not(:disabled), select:not(:disabled)").disable().addClass("fade-disabled"),e.addClass("hidden").next().removeClass("hidden"),e.siblings(".collapse:not(.hidden)").trigger("click"),0===a.siblings(":not(.faded)").length&&l.$DeleteButton.disable("noop-disabled")}),h=$.mk("button").attr({class:"btn green typcn typcn-arrow-back hidden restore",title:"Don't delete cutie mark on save"}).text("Restore").on("click",function(t){t.preventDefault();var e=$(t.target);e.closest("li").removeClass("faded").find(".fade-disabled").enable().removeClass("fade-disabled"),e.addClass("hidden").prev().removeClass("hidden"),l.$DeleteButton.enable("noop-disabled"),e.siblings(".expand:not(.hidden)").trigger("click")}),g=(e?"Replace":"Upload")+" SVG file",m=$.mk("li").append($.mk("fieldset").append($.mk("legend").append("<span>"+(e?"Cutie Mark #"+t.id:"New Cutie Mark")+"</span>",d,p,u,h),$.mk("div").attr("class","label svg-replace").append($.mk("label").append($.mk("input").attr({type:"checkbox",checked:!e,disabled:!e,class:e?f:"hidden"}).on("click",function(t){if(t.target.readOnly)return!1}).on("change input",function(t){var e=t.target.checked,a=$(t.target).parent().next();if(a[e?"removeClass":"addClass"]("hidden"),e){var n=a.children(".svgcont"),i=n.attr("data-ogbg");i&&(a.removeData("svgdata").removeData("svgel"),n.backgroundImageUrl(i)),a.hasClass("upload-wrap")||a.addClass("upload-wrap").uploadZone({requestKey:"file",title:g,accept:".svg,.svgz,image/svg+xml",target:$.API.API_PATH+"/cg/appearance/"+l.appearance_id+"/sanitize-svg",helper:!0}).on("uz-uploadfinish",function(t,e){e&&e.svgel&&a.data({svgdata:e.svgdata,svgel:e.svgel}).children(".svgcont").backgroundImageUrl("data:image/svg+xml;utf8,"+encodeURI(e.svgel))})}}),"<span>"+g+"</span>"),$.mk("div").attr("class","svg-replace-preview hidden").html('<div class="svgcont"></div>')),$.mk("label").append("<span>Custom label (1-32 chars, optional)</span>",$.mk("input").attr({type:"text",maxlength:32,class:"custom-label",pattern:v.replace("+","{1,32}"),value:t.label})),i,r,s,$.mk("div").append("<span>Rotation: <span class='rotation-display'>"+o+"</span></span>",$.mk("input").attr({type:"range",min:-45,max:45,step:1,class:"rotation-range",required:!0}).val(o)),'<div class="notice info">Rotation does not affect the original image file, only the way it\'s displayed on the site.</div>'));return t.id&&m.attr("id","cmdata-"+t.id),t.rendered&&m.find(".svgcont").attr("data-ogbg",t.rendered),m.find(".svg-replace input:checked").trigger("change"),m}}],[{key:"factory",value:function(t,e,a,n){$.Dialog.request(t,new i(e,a,n).getForm(),"Save")}}]),i}(),_=function(t){var a=t.closest("[id^=p]").attr("id").substring(1);$.Dialog.confirm("Apply template on appearance","Add common color groups to this appearance?<br>Note: This will only work if there are no color groups currently present.",function(t){if(t){$.Dialog.wait(!1,"Applying template");var e={};p&&(e.APPEARANCE_PAGE=!0),$.API.post("/cg/appearance/"+a+"/template",e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$("#p"+a).find("ul.colors").html(this.cgs),S(),$.Dialog.close()}))}})},I=(x=jQuery).mk("form","template-gen-form").html('<div class="tab-wrap">\n\t\t\t\t<ul class="tab-list">\n\t\t\t\t\t<li class="tab" data-content="features">Body Shape</li>\n\t\t\t\t\t<li class="tab" data-content="colors">Colors</li>\n\t\t\t\t</ul>\n\t\t\t\t<ul class="tab-contents">\n\t\t\t\t\t<li class="content-features">\n\t\t\t\t\t\t<div class="label">\n\t\t\t\t\t\t\t<span>Species</span>\n\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t<label><input type="radio" name="features" value="" required checked><span>Earth pony</span></label>\n\t\t\t\t\t\t\t\t<label><input type="radio" name="features" value="horn" required><span>Unicorn</span></label>\n\t\t\t\t\t\t\t\t<label><input type="radio" name="features" value="wing" required><span>Pegasus</span></label>\n\t\t\t\t\t\t\t\t<label><input type="radio" name="features" value="horn,wing" required><span>Alicorn</span></label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="label">\n\t\t\t\t\t\t\t<span>Body type</span>\n\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t<label><input type="radio" name="body" value="female" required checked><span>Female</span></label>\n\t\t\t\t\t\t\t\t<label><input type="radio" name="body" value="male" required><span>Male</span></label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="label">\n\t\t\t\t\t\t\t<span>Eye shape</span>\n\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t<label><input type="radio" name="eyes" value="1" required checked><span>#1</span></label>\n\t\t\t\t\t\t\t\t<label class="male-hide"><input type="radio" name="eyes" value="2" required><span>#2</span></label>\n\t\t\t\t\t\t\t\t<label><input type="radio" name="eyes" value="3" required><span>#3</span></label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="label">\n\t\t\t\t\t\t\t<span>Eye gradient</span>\n\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t<label><input type="radio" name="eye_grad" value="2" required checked><span>2 colors</span></label>\n\t\t\t\t\t\t\t\t<label><input type="radio" name="eye_grad" value="3" required><span>3 colors</span></label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li class="content-colors">\n\t\t\t\t\t\t\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</div>').on("submit",function(t){t.preventDefault()}).on("added",function(t,o){var c={},d=!1,p=x(this),u=mk("canvas"),h=x.mk("a").attr({class:"btn typcn typcn-download",download:"sprite.png",disabled:!0}).text("Download"),e=x.mk("input").attr({type:"checkbox",name:"accept_terms"}).on("change mouseup",function(){h.attr("disabled",!this.checked)}),n=["cm_square","eyes_male12","eyes_male3","eyes_male12_grad2","eyes_male12_grad3","eyes_male3_grad2","eyes_male3_grad3","eyes_female1","eyes_female2","eyes_female3","eyes_female12_grad2","eyes_female12_grad3","eyes_female3_grad2","eyes_female3_grad3","horn_female","horn_male","wing_female","wing_male","body_female","body_male","eye_grad2","eye_grad3"],i={},g=function(t,e){if(void 0===i[e])throw new Error("Missing template image: "+e);t.drawImage(i[e],0,0,300,300,0,0,300,300)},r=function(){if(d){var a=p.mkData(),n=u.getContext("2d"),t="male"===a.body;delete a.accept_terms,n.clearRect(0,0,n.canvas.width,n.canvas.height),g(n,"cm_square"),g(n,"body_"+a.body);var e=p.find(".male-hide > input");t&&e.is(":checked")&&e.parent().prev().children("input").prop("checked",!0),e.prop("disabled",t);var i=p.find("#color-replace-ma");i.addClass("hidden"),a.features&&x.each(a.features.split(","),function(t,e){"horn"===e&&i.removeClass("hidden"),g(n,e+"_"+a.body)}),delete a.features,p.find("#color-replace-igm")["3"===a.eye_grad?"removeClass":"addClass"]("hidden"),g(n,"eyes_"+a.body+(t&&a.eyes<3?"12":a.eyes)),g(n,"eyes_"+a.body+(a.eyes<3?"12":"3")+"_grad"+a.eye_grad),delete a.eyes,delete a.body,x.each(a,function(t,e){g(n,t+e)});for(var l=n.getImageData(0,0,n.canvas.width,n.canvas.height),o=!1,r=0;r<l.data.length;r+=4)if(0!==l.data[r+3]){var s=c[l.data.slice(r,r+3).join(",")];s&&(o||(o=!0),l.data[r]=s.red,l.data[r+1]=s.green,l.data[r+2]=s.blue)}o&&n.putImageData(l,0,0),h.attr("href",n.canvas.toDataURL("image/png"))}},s=p.find(".content-colors");x.each({"Coat Outline":"#443633","Coat Shadow Outline":"#404433","Coat Fill":"#70605D","Coat Shadow Fill":"#6C7260","Iris Gradient Top":"#3B3B3B","Iris Gradient Middle":"#606060","Iris Gradient Bottom":"#BEBEBE","Iris Highlight Top":"#542727","Iris Highlight Bottom":"#7E3A3A","Magic Aura":"#B7B7B7"},function(t,e){var a,n,i,l=(n=e,i=(a=t).replace(/[^A-Z]/g,"").toLowerCase(),x.mk("div","color-replace-"+i).attr("class","color-replace").append(x.mk("input").attr({type:"text",value:n,"data-orig":n,class:"color-input",readonly:!0}).ponyColorPalette(o,n,function(t,e){var a=t.attr("data-orig");t.val(null===e?a:e).trigger("change");var n=x.RGBAColor.parse(a).toRGBArray().join(",");null!==e?c[n]=x.RGBAColor.parse(e):delete c[n],r()}).on("change",function(){var t=x(this),e=x.RGBAColor.parse(t.val());null===e&&t.css({backgroundColor:"",color:""}),t.css({backgroundColor:e.toHex(),color:127<e.yiq()?"black":"white"})}),x.mk("div").attr("class","color-label").text(a)));s.append(l)}),s.find(".color-input").trigger("change"),u.width=300,u.height=300,x(u).on("mousedown dragstart contextmenu keydown",function(){return!1}).on("focus",function(){this.blur()}),p.append(x.mk("div").html(u),x.mk("label").append(e,' <span>I accept that generated images are licensed under <a href=\'https://creativecommons.org/licenses/by-nc-sa/4.0/\' target="_blank" rel="noopener">CC-BY-NC-SA 4.0</a></span>')).on("change click mousedown","input",x.throttle(100,r)),x("#dialogButtons").prepend(h),x.Dialog.wait(!1,"Preloading images");var l=0;x.each(n,function(t,e){var a=new Image;a.src="/img/sprite_template/"+e+".png?v=1.1",x(a).on("load",function(){l++,i[e]=a,l===n.length&&(x.Dialog.clearNotice(/Preloading/),d=!0,r())}).on("error",function(){console.log("Loaded %d out of %d before erroring",l,i.length),x.Dialog.fail(!1,'Some images failed to load, please try <a class="sprite-template-gen">re-opening this form</a>, and if this issue persists, please <a class="send-feedback">let us know</a>.')})})}),P=void 0;function S(){(P=$(".tags")).filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Create new tag",icon:"plus",click:function(){var t,e,n,i,l,o;t=$(this),i=t.closest(".tags"),l=i.closest("[id^=p]").attr("id").substring(1),o=p?$content.children("h1").text():i.siblings("strong").text().trim(),$.Dialog.request("Create new tag",m.clone(!0,!0),"Create",function(a){a.children(".edit-only").replaceWith($.mk("label").append($.mk("input").attr({type:"checkbox",name:"addto"}).val(l).prop("checked","string"==typeof e),' Add this tag to the appearance "'+o+'" after creation')),"string"==typeof n&&void 0!==r[n]&&a.find("input[name=type][value="+n+"]").prop("checked",!0).trigger("change"),"string"==typeof e&&a.find("input[name=name]").val(e),a.on("submit",function(t){t.preventDefault();var e=a.mkData();$.Dialog.wait(!1,"Creating tag"),e.addto&&p&&(e.APPEARANCE_PAGE=!0),$.API.post("/cg/tag",e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.tags&&(i.html(this.tags),S()),b.clear(),$.Dialog.close()}))})})}}],"Tags"),P.children(".tag:not(.ctxmenu-bound)").ctxmenu([{text:"Edit tag",icon:"pencil",click:function(){var n=$(this),t=n.text().trim(),i=n.attr("class").match(/id-(\d+)(?:\s|$)/)[1],a="Editing tag: "+t;$.Dialog.wait(a,"Retrieving tag details from server"),$.API.get("/cg/tag/"+i,$.mkAjaxHandler(function(){var e=this;this.status?$.Dialog.request(a,m.clone(!0,!0).data("tag",e),"Save",function(a){a.find("input[name=type][value="+e.type+"]").prop("checked",!0),a.find("input[type=text][name], textarea[name]").each(function(){var t=$(this);t.val(e[t.attr("name")])}),a.on("submit",function(t){t.preventDefault();var e=a.mkData();p&&(e.APPEARANCE_PAGE=n.closest("div[id^=p]").attr("id").replace(/\D/g,"")),$.Dialog.wait(!1,"Saving changes"),$.API.put("/cg/tag/"+i,e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=this,e=$(".id-"+t.id);t.title?e.attr("title",t.title):e.removeAttr("title"),e.text(t.name).data("ctxmenu-items").eq(0).text("Tag: "+t.name),e.each(function(){t.synonym_of?$(this).remove():/typ-[a-z]+/.test(this.className)?this.className=this.className.replace(/typ-[a-z]+/,t.type?"typ-"+t.type:""):t.type&&(this.className+=" typ-"+t.type)}),$.Dialog.close()}))})}):$.Dialog.fail(a,this.message)}))}},{text:"Delete tag",icon:"trash",click:function(){var a=$(this),t=a.text().trim(),n=a.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Delete the "+t+" tag";$.Dialog.confirm(i,"Deleting this tag will also remove it from every appearance where it's been used.<br>Are you sure?",["Delete it","Nope"],function(t){if(t){var e={};p&&(e.APPEARANCE_PAGE=a.closest("[id^=p]").attr("id").substring(1)),function e(a){$.Dialog.wait(i,"Sending removal request"),$.API.delete("/cg/tag/"+n,a,$.mkAjaxHandler(function(){this.status?($(".id-"+n).remove(),b.clear(),$.Dialog.close()):this.confirm?$.Dialog.confirm(!1,this.message,["NUKE TAG","Never mind"],function(t){t&&(a.sanitycheck=!0,e(a))}):$.Dialog.fail(i,this.message)}))}(e)}})}},$.ctxmenu.separator,{text:"Create new tag",icon:"plus",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(t){return"Tag: "+t.text().trim()}),(e=$("ul.colors")).filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Re-order color groups",icon:"arrow-unsorted",click:function(){var i=$(this),t=i.closest("[id^=p]"),e=t.attr("id").substring(1),n="Re-order color groups of "+(p?$content.children("h1").text():t.children().last().children("strong").text().trim());$.Dialog.wait(n,"Retrieving color group list from server");var l="/cg/appearance/"+e+"/colorgroups";$.API.get(l,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=$.mk("form","cg-reorder"),a=$.mk("ol");$.each(this.cgs,function(t,e){a.append($.mk("li").attr("data-id",e.id).text(e.label))}),t.append($.mk("div").attr("class","cgs").append('<p class="align-center">Drag to re-arrange</p>',a)),Sortable.create(a.get(0),{ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.request(n,t,"Save",function(n){n.on("submit",function(t){t.preventDefault();var e={cgs:[]},a=n.children(".cgs");if(!a.length)return $.Dialog.fail(!1,"There are no color groups to re-order");a.find("ol").children().each(function(){e.cgs.push($(this).attr("data-id"))}),e.cgs=e.cgs.join(","),$.Dialog.wait(!1,"Saving changes"),p&&(e.APPEARANCE_PAGE=!0),$.API.put(l,e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(null,this.message);i.html(this.cgs),S(),$.Dialog.close()}))})})}))}},{text:"Create new group",icon:"folder-add",click:function(){w.factory("Create color group",$(this).closest("[id^=p]").attr("id").substring(1))}},{text:"Apply template (if empty)",icon:"document-add",click:function(){_($(this))}}],"Color groups"),e.children("li").filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Edit color group",icon:"pencil",click:function(){var t=$(this).closest("li"),e=t.attr("id").replace(/\D/g,""),a="Editing color group: "+t.find(".cat").contents().first().text().replace(/:\s?$/,"");$.Dialog.wait(a,"Retrieving color group details from server"),$.API.get("/cg/colorgroup/"+e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(a,this.message);w.factory(a,t,this)}))}},{text:"Delete color group",icon:"trash",click:function(){var e=$(this).closest("li"),a=e.attr("id").replace(/\D/g,""),n="Delete color group: "+e.find(".cat").contents().first().text().replace(/:\s?$/,"");$.Dialog.confirm(n,"By deleting this color group, all colors within will be removed too.<br>Are you sure?",function(t){t&&($.Dialog.wait(n,"Sending removal request"),$.API.delete("/cg/colorgroup/"+a,$.mkAjaxHandler(function(){if(this.status){var t=e.parent();1===t.children().length?t.empty():e.remove(),$.Dialog.close()}else $.Dialog.fail(n,this.message)})))})}},$.ctxmenu.separator,{text:"Re-order color groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}}],function(t){return"Color group: "+t.find(".cat").contents().first().text().replace(/:\s?$/,"")});var t=e.children("li").find(".valid-color");$.ctxmenu.addItems(t.filter(".ctxmenu-bound"),$.ctxmenu.separator,{text:"Edit color group",icon:"pencil",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),1)}},{text:"Delete color group",icon:"trash",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),2)}},$.ctxmenu.separator,{text:"Re-order color groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),3)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),4)}}),$content.find(".upload-wrap").filter(":not(.ctxmenu-bound)").each(function(){var t=$(this),e=t.closest("li");e.length||(e=$content.children("[id^=p]"));var a,l,n,i,o,r=e.attr("id").substring(1);l=r,n=(a=t).find("img").attr("src"),i=void 0,o=function(){n=a.find("img").attr("src"),i=-1===n.indexOf("blank-pixel.png"),a[i?"removeClass":"addClass"]("nosprite"),$.ctxmenu.setDefault(a,i?1:4)},a.uploadZone({requestKey:"sprite",title:"Upload sprite",accept:"image/png",target:$.API.API_PATH+"/cg/appearance/"+l+"/sprite"}).on("uz-uploadstart",function(){$.Dialog.close()}).on("uz-uploadfinish",function(){o()}).ctxmenu([{text:"Open image in new tab",icon:"arrow-forward",click:function(){if(-1!==n.indexOf("blank-pixel.png"))return $.Dialog.fail("Open image in new tab","This appearance lacks a sprite image");window.open(a.find("img").attr("src"),"_blank")}},{text:"Copy image URL",icon:"clipboard",click:function(){if(-1!==n.indexOf("blank-pixel.png"))return $.Dialog.fail("Copy image URL","This appearance lacks a sprite image");$.copy($.toAbsoluteURL(a.find("img").attr("src")))}},{text:"Check sprite colors",icon:"adjust-contrast",click:function(){if(-1!==n.indexOf("blank-pixel.png"))return $.Dialog.fail("Check sprite colors","This appearance lacks a sprite image");$.Navigation.visit(c+"/cg/sprite/"+l)}},{text:"Upload new sprite",icon:"upload",click:function(){var n="Upload sprite image",i=a.find('input[type="file"]');$.Dialog.request(n,g.clone(),"Download image",function(t){var a=t.find("input[name=image_url]");t.find(".upload-link").on("click",function(t){t.preventDefault(),t.stopPropagation(),i.trigger("click",[!0])}),u&&t.find(".sprite-template-gen").on("click",function(t){t.preventDefault(),t.stopPropagation(),$.Dialog.close();var e=I.clone(!0,!0);$.Dialog.request("Sprite Template Generator",e,!1,function(){e.triggerHandler("added",[l])})}),t.on("submit",function(t){t.preventDefault();var e=a.val();$.Dialog.wait(n,"Downloading external image to the server"),$.API.post("/cg/appearance/"+l+"/sprite",{image_url:e},$.mkAjaxHandler(function(){this.status?i.trigger("set-image",[this]):$.Dialog.fail(n,this.message)}))})})}},{text:"Remove sprite image",icon:"times",click:function(){if(-1!==n.indexOf("blank-pixel.png"))return $.Dialog.fail("Remove sprite image","This appearance lacks a sprite image");$.Dialog.confirm("Remove sprite image","Are you sure you want to <strong>permanently delete</strong> the sprite image from the server?",["Wipe it","Nope"],function(t){t&&($.Dialog.wait(!1,"Removing image"),$.API.delete("/cg/appearance/"+l+"/sprite",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);a.find("img").attr("src",this.sprite),o(),$.Dialog.close()})))})}}],"Sprite image").attr("title",s?" ":"").on("click",function(t,e){if(!0===e)return!0;t.preventDefault(),$.ctxmenu.runDefault(a)}),o()})}window.ctxmenus=function(){return S()},$("button.edit-appearance:not(.bound)").addClass("bound").on("click",function(){var t=$(this),e=t.closest("[id^=p]").attr("id").substring(1),a="Editing appearance: "+(p?$content.children("h1").text():t.parent().text().trim());$.Dialog.wait(a,"Retrieving appearance details from server"),$.API.get("/cg/appearance/"+e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.appearanceID=e,i(t,a,this)}))}),$("button.delete-appearance").on("click",function(){var t=$(this),e=t.closest("[id^=p]"),a=e.attr("id").substring(1),n="Deleting appearance: "+(p?$content.children("h1").text():t.parent().text().trim());$.Dialog.confirm(n,"Deleting this appearance will remove <strong>ALL</strong> of its color groups, the colors within them, and the sprite file, if any.<br>Delete anyway?",function(t){t&&($.Dialog.wait(n,"Sending removal request"),$.API.delete("/cg/appearance/"+a,$.mkAjaxHandler(function(){this.status?(e.remove(),$.Dialog.success(n,this.message),p?($.Dialog.wait("Navigation","Loading page 1"),$.Navigation.visit(c+"/cg")):$.Navigation.reload()):$.Dialog.fail(n,this.message)})))})}),$(".section-container").on("click",".edit-show-relations",function(){var t=$(this),e=t.closest("[id^=p]").attr("id").substring(1),a="Edit show relations for "+(p?$content.children("h1").text():t.parent().text().trim());$.Dialog.wait(a,"Retrieving relations from server");var n="/cg/appearance/"+e+"/guide-relations";$.API.get(n,$.mkAjaxHandler(function(t){if(!t.status)return $.Dialog.fail(!1,t.message);var e=window.reactComponents.SplitSelector,a=_extends({},t,{endpoint:n,formId:"show-relation-editor",valueKey:"id",displayKey:"label",findGroup:function(t){return t.type},onSuccess:function(t){var e=$("#related-shows");t.section?e.length?e.replaceWith(t.section):$(t.section).insertAfter($("#tags")):e.length&&e.remove(),$.Dialog.close()}});$.Dialog.request(!1,React.createElement(e,a),"Save")}))}).on("click",".edit-appearance-relations",function(){var t=$(this),s=t.closest("[id^=p]").attr("id").substring(1),e="Edit appearance relations for "+(p?$content.children("h1").text():t.parent().text().trim());$.Dialog.wait(e,"Retrieving relations from the server");var c=$content.find("section.related");$.API.get("/cg/appearance/"+s+"/relations",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=this,e=$.mk("form").attr("id","guide-relation-editor"),o=$.mk("select").attr({name:"listed",multiple:!0}),a=$.mk("select").attr("multiple",!0);t.linked&&t.linked.length&&$.each(t.linked,function(t,e){var a=$.mk("option").attr("value",e.id).text(e.label);e.mutual&&a.attr("data-mutual",!0).text("(M) "+a.text()),o.append(a)}),t.unlinked&&t.unlinked.length&&$.each(t.unlinked,function(t,e){a.append($.mk("option").attr("value",e.id).text(e.label))});var n=$.mk("div").attr("class","mutual-fieldset-wrap").html('<fieldset>\n\t\t\t\t\t<legend data-placeholder="Relation type"></legend>\n\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t<label><input type="radio" class="mutual-checkbox" name="mutual" value="1" required disabled><span>Mutual</span></label>\n\t\t\t\t\t\t<label><input type="radio" class="mutual-checkbox" name="mutual" value="0" required disabled><span>One way</span></label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="notice"></div>\n\t\t\t\t</fieldset>'),i=n.find(".notice"),l=n.find("legend"),r=/^\(M\) /;n.find("input").on("change click",function(){var t=$(this);if(!t.hasAttr("disabled")){var e=o.children(":selected"),a=t.is(":checked")&&"1"===t.attr("value"),n=e.hasAttr("data-mutual");a?n||e.attr("data-mutual",!0).text("(M) "+e.text()):n&&e.removeAttr("data-mutual").text(e.text().replace(r,""))}}),o.on("change",function(){var t=o.children(":selected");1===t.length?(n.find("input").enable(),i.hide(),l.text("Relation to "+t.text().replace(r,"")),n.find('input[value="'+(t.hasAttr("data-mutual")?"1":"0")+'"]').prop("checked",!0)):(n.find("input").disable(),l.empty(),1<t.length?i.attr("class","notice fail").text("Multiple appearances are selected").show():i.attr("class","notice info").text("Select a relation on the left to change the type").show())}).triggerHandler("change"),e.append($.mk("div").attr("class","split-select-wrap").append($.mk("div").attr("class","split-select").append("<span>Linked</span>",o),$.mk("div").attr("class","buttons").append($.mk("button").attr({class:"typcn typcn-chevron-left green",title:"Link selected"}).on("click",function(t){t.preventDefault(),o.append(a.children(":selected").prop("selected",!1)).children().sort(function(t,e){return t.innerHTML.localeCompare(e.innerHTML)}).appendTo(o)}),$.mk("button").attr({class:"typcn typcn-chevron-right red",title:"Unlink selected"}).on("click",function(t){t.preventDefault(),a.append(o.children(":selected").prop("selected",!1)).children().sort(function(t,e){return t.innerHTML.localeCompare(e.innerHTML)}).appendTo(a),0===o.children().length&&(n.find("input").disable(),l.empty(),n.find(".notice").show())})),$.mk("div").attr("class","split-select").append("<span>Available</span>",a)),n),$.Dialog.request(!1,e,"Save",function(t){t.on("submit",function(t){t.preventDefault();var i=[],l=[];o.children().each(function(t,e){var a=$(e),n=a.attr("value");i.push(n),a.hasAttr("data-mutual")&&l.push(n)}),$.Dialog.wait(!1,"Saving changes");var e={ids:i.join(","),mutuals:l.join(",")};p&&(e.APPEARANCE_PAGE=!0),$.API.put("/cg/appearance/"+s+"/relations",e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.section?(c.length||(c=$.mk("section").addClass("related").appendTo($content.children().last())),c.html($(this.section).filter("section").html())):c.length&&(c.remove(),c={length:0}),$.Dialog.close()}))})})}))}),S();var B=function(){function a(t,e){var i=this;_classCallCheck(this,a),this.afterSave=e,this.plaintextMode=!1,this.$tagsSection=$("#tags"),this.$tagList=this.$tagsSection.children(".tags"),this.$tagList.addClass("hidden"),this.$editButton=$("#edit-tags-btn"),this.$saveButton=$.mk("button").attr("class","green typcn typcn-tick").text("Save").insertAfter(this.$editButton),this.$editButton.detach(),this.$saveButton.on("click",function(t){t.preventDefault(),$.callCallback(e,[i.getValue()])}),this.$modeButton=$.mk("button").attr("class","darkblue typcn typcn-pencil").text("Plain text editor").insertAfter(this.$saveButton),this.$modeButton.on("click",function(t){t.preventDefault(),i.plaintextMode?(i.$textarea.addClass("hidden"),i.importTags(i.$textarea.val(),!1),i.$tagInput.parent().removeClass("hidden"),i.plaintextMode=!1,i.$modeButton.removeClass("typcn-edit").addClass("typcn-pencil").text("Plain text editor")):(i.$tagInput.parent().addClass("hidden"),i.$editor.children(".tag").remove(),i.$textarea.removeClass("hidden"),i.plaintextMode=!0,i.$modeButton.removeClass("typcn-pencil").addClass("typcn-edit").text("Interactive editor"))}),this.$discardButton=$.mk("button").attr("class","orange typcn typcn-times").text("Discard").insertAfter(this.$modeButton),this.$discardButton.on("click",function(t){t.preventDefault(),i.destroy()}),this.$textarea=$.mk("textarea").attr("class","hidden").val(t),this.$editor=$.mk("div").attr("class","tag-editor").insertAfter(this.$tagList),this.$tagInput=$.mk("input").attr({type:"text",required:!0,class:"addtag",maxlength:64}).patternAttr(n),this.$tagInput.on("keydown",function(t){if([Key.Enter,Key.Comma].includes(t.keyCode)&&(t.preventDefault(),i.$tagInput.is(":valid"))){var e=i.$tagInput.val(),a=i.$editor.children(".tag").children(".name").filter(function(){return $(this).text()===e});if(0<a.length){var n=a.closest(".tag");return n.removeClass("notice-me"),void setTimeout(function(){n.addClass("notice-me")},1)}i.addTag(e),i.$tagInput.autocomplete("val","")}}),this.$tagInput.nextAll(".aa-menu").on("click",".tag",function(){this.$tagInput.trigger({type:"keydown",keyCode:Key.Enter})}),this.$editor.append(this.$tagInput,this.$textarea),this.$tagInput.autocomplete({minLength:3},[{name:"tags",display:"name",source:function(t,e){if(b.has(t))return e(b.get(t));$.API.get("/cg/tags",{s:t},$.mkAjaxHandler(function(){e(b.set(t,this))}))},templates:{suggestion:function(t){return'<span class="tag id-'+t.tid+" "+t.type+" "+(t.synonym_of?"synonym":"monospace")+'">'+t.name+' <span class="uses">'+(t.synonym_of?'<span class="typcn typcn-flow-children"></span>'+t.synonym_target:t.uses)+"</span></span>"}}}]),this.importTags(t),$.Dialog.close()}return _createClass(a,[{key:"importTags",value:function(t){var e=this;(this.$editor.children(".tag").remove(),""!==t)&&t.split(",").forEach(function(t){e.addTag(t.trim(),!1)})}},{key:"addTag",value:function(t){var e=this,a=!(1<arguments.length&&arguments[1]!==f)||arguments[1];$.mk("span").attr("class","tag").append($.mk("span").attr("class","name").text(t),$.mk("span").attr("class","remove").on("click",function(t){$(t.target).parent().remove(),e.updateValue()})).insertBefore(this.$tagInput.closest(".algolia-autocomplete")),a&&this.updateValue()}},{key:"updateValue",value:function(){var t=[];this.$editor.find(".tag").children(".name").each(function(){t.push($(this).text())}),this.$textarea.val(t.join(", "))}},{key:"getValue",value:function(){return this.$textarea.val()}},{key:"disableButtons",value:function(){this.$saveButton.disable(),this.$modeButton.disable(),this.$discardButton.disable()}},{key:"enableButtons",value:function(){this.$saveButton.enable(),this.$modeButton.enable(),this.$discardButton.enable()}},{key:"destroy",value:function(){this.$tagList.removeClass("hidden"),this.$editButton.insertBefore(this.$saveButton),this.$editor.remove(),this.$saveButton.remove(),this.$modeButton.remove(),this.$discardButton.remove(),b.clear()}}]),a}(),E=$("#edit-tags-btn");E.on("click",function(t){t.preventDefault();var e=E.html();E.disable().html("Please wait&hellip;");var n=$(this).closest("[id^=p]").attr("id").replace(/\D/g,"");$.API.get("/cg/appearance/"+n+"/tagged",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this.tags,a=new B(e,function(t){a.disableButtons(),$.API.put("/cg/appearance/"+n+"/tagged",{tags:t,orig_tags:e},$.mkAjaxHandler(function(){if(!this.status)return a.enableButtons(),$.Dialog.fail("Saving tags",this.message);window.location.reload()})).fail(function(){a.enableButtons()})})})).always(function(){E.html(e).enable()})}),$(".cg-export").on("click",function(){window.open($.API.API_PATH+"/cg/export","_blank")}),$(".cg-reindex").on("click",function(){$.Dialog.confirm("Re-index all appearances","Wipe and rebuild ElasticSearch index?",function(t){t&&($.Dialog.wait(!1),$.API.post("/cg/reindex",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.segway(!1,this.message)})))})}),$(".cg-sprite-colors").on("click",function(){$.Dialog.confirm($(this).text(),"Run a check on all sprites & look for missing colors?",function(t){t&&($.Dialog.wait(!1,"Checking all sprite colors (this might take a while)"),$.API.post("/cg/sprite-color-checkup",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,this.message,!0)})))})})}();