"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e};!function(){var r=window.USERNAME_REGEX,o=window.FULLSIZE_MATCH_REGEX,e=window.SHOW_ID,d=$content.children("section.episode");function l(a,e,n){var s="Reserving request",i=function t(i){$.Dialog.wait(s,"Sending reservation to the server"),$.API.post("/post/"+n+"/reservation",i,$.mkAjaxHandler(function(){if(this.retry)return $.Dialog.confirm(!1,this.message,function(e){e&&(i.screwit=!0,t(i))});if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var e=$(this.li);a.hasClass("highlight")&&e.addClass("highlight"),a.replaceWith(e),Time.update(),e.rebindFluidbox()}$.Dialog.close()}))};if(void 0!==r&&e){var t=$.mk("form").attr("id","reserve-as").append($.mk("label").append("<span>Reserve as</span>",$.mk("input").attr({type:"text",name:"post_as",required:!0,placeholder:"Username"}).patternAttr(r)),$.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",spellcheck:!1,autocomplete:"off",placeholder:"time()"})));$.Dialog.request(s,t,"Reserve",function(t){t.on("submit",function(e){e.preventDefault(),i(t.mkData())})})}else i({})}$("#video").on("click",function(){$.Dialog.wait("Set video links","Requesting links from the server");var o="/show/"+e+"/video-data";$.API.get(o,$.mkAjaxHandler(function(){var e=this,t=e.type;if(!e.status)return $.Dialog.fail(!1,e.message);var i="<input type='url' class='yt' name='yt_1' placeholder='YouTube' spellcheck='false' autocomplete='off'>",a="<input type='url' class='dm' name='dm_1' placeholder='Dailymotion' spellcheck='false' autocomplete='off'>",n="<input type='url' class='sv' name='sv_1' placeholder='sendvid' spellcheck='false' autocomplete='off'>",s="<input type='url' class='mg' name='mg_1' placeholder='Mega' spellcheck='false' autocomplete='off'>",l=$.mk("form").attr("id","vidlinks").attr("class","align-center").html("<p>Enter video links below, leave any input blank to remove that video from the page.</p>\n\t\t\t\t\t<div class='inputs'>\n\t\t\t\t\t\t"+i+"\n\t\t\t\t\t\t"+a+"\n\t\t\t\t\t\t"+n+"\n\t\t\t\t\t\t"+s+"\n\t\t\t\t\t</div>");if(e.twoparter&&($.mk("p").html("<strong>~ Part 1 ~</strong>").insertBefore(l.children("input").first()),l.append("<p>Check below if either link contains the entire "+t+" instead of just one part</p>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label><input type='checkbox' name='yt_1_full'> YouTube</label>\n\t\t\t\t\t\t<label><input type='checkbox' name='dm_1_full'> Dailymotion</label>\n\t\t\t\t\t\t<label><input type='checkbox' name='sv_1_full'> sendvid</label>\n\t\t\t\t\t\t<label><input type='checkbox' name='mg_1_full'> Mega</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p><strong>~ Part 2 ~</strong></p>\n\t\t\t\t\t<div class='inputs'>\n\t\t\t\t\t\t"+i.replace("yt_1","yt_2")+"\n\t\t\t\t\t\t"+a.replace("dm_1","dm_2")+"\n\t\t\t\t\t\t"+n.replace("sv_1","sv_2")+"\n\t\t\t\t\t\t"+s.replace("mg_1","mg_2")+"\n\t\t\t\t\t</div>"),l.find('input[type="checkbox"]').on("change",function(){var e=$(this).attr("name").replace(/^([a-z]+)_.*$/,"$1");l.find("input").filter("[name="+e+"_2]").prop("disabled",this.checked)}),0<e.fullep.length&&$.each(e.fullep,function(e,t){l.find('input[type="checkbox"]').filter('[name="'+t+'_1_full"]').prop("checked",!0).trigger("change")})),0<Object.keys(e.vidlinks).length){var r=l.find('input[type="url"]');$.each(e.vidlinks,function(e,t){r.filter("[name="+e+"]").val(t)})}$.Dialog.request(!1,l,"Save",function(i){i.on("submit",function(e){e.preventDefault();var t=i.mkData();$.Dialog.wait(!1,"Saving links"),$.API.put(o,t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.epsection?(d.length||(d=$.mk("section").addClass("episode").insertBefore($content.children("section").first())),d.html($(this.epsection).filter("section").html()),bindVideoButtons()):d.length&&(d.remove(),d={length:0}),$.Dialog.close()}))})})}))}),$("#cg-relations").on("click",function(){$.Dialog.wait("Guide relation editor","Retrieving relations from server");var a="/show/"+e+"/guide-relations";$.API.get(a,$.mkAjaxHandler(function(e){if(!e.status)return $.Dialog.fail(!1,e.message);var t=window.reactComponents.SplitSelector,i=_extends({},e,{endpoint:a,formId:"guide-relation-editor",valueKey:"id",displayKey:"label",findGroup:function(e){return e.ishuman?"eqg":"pony"},onSuccess:function(e){var t=$content.children("section.appearances");e.section?t.length?t.replaceWith(e.section):$(e.section).insertBefore($content.children(".admin")):t.length&&t.remove(),$.Dialog.close()}});$.Dialog.request(!1,React.createElement(t,i),"Save")}))}),$("#edit-about_reservations, #edit-reservation_rules").on("click",function(e){e.preventDefault();var a=$(this).parent(),t=a.clone(),n=this.id.split("-").pop();t.children().remove();var i=t.text().trim();$.Dialog.wait('Editing "'+i+'"',"Retrieving setting's value"),$.API.get("/setting/"+n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("form",n+"-editor"),t=this.value;$.Dialog.request(!1,e,"Save",function(e){var i=$.codeFlask($.mk("div").attr("class","code-editor").appendTo(e).get(0),"markup");i.updateCode(t),e.on("submit",function(e){e.preventDefault();var t={value:i.getCode()};$.Dialog.wait(!1,"Saving"),$.API.put("/setting/"+n,t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);a.siblings().remove(),a.parent().append(this.value),$.Dialog.close()}))})})}))}),$(".posts").on("click","li[id] .reserve-request",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(t),a=i.id;i.type;l(t,e.shiftKey,a)}).on("click","li[id] .edit",function(e){e.preventDefault();var c=$(this).closest("li"),t=$._getLiTypeId(c),p=t.id,u="requests"===t.type;$.Dialog.wait("Editing post #"+p,"Retrieving details"),$.API.get("/post/"+p,$.mkAjaxHandler(function(d){if(!d.status)return $.Dialog.fail(!1,d.message);var e=$.mk("form").attr("id","post-edit-form").append($.mk("label").append($.mk("span").text("Description (3-255 chars."+(u?"":", optional")+")"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{3,255}$",name:"label",required:u})));u&&e.append($.mk("label").append($.mk("span").text("Request type"),$.mk("select").attr({name:"type",required:!0}).append($.mk("option").attr("value","chr").text("Character"),$.mk("option").attr("value","obj").text("Object"),$.mk("option").attr("value","bg").text("Background")))),"string"==typeof d.posted_at&&e.append($.mk("label").append($.mk("span").text("Post timestamp"),$.mk("input").attr({type:"datetime",name:"posted_at",required:!0,spellcheck:!1,autocomplete:"off"}))),"string"==typeof d.reserved_at&&e.append($.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",spellcheck:!1,autocomplete:"off"}))),"string"==typeof d.finished_at&&e.append($.mk("label").append($.mk("span").text("Finished at"),$.mk("input").attr({type:"datetime",name:"finished_at",spellcheck:!1,autocomplete:"off"})));var t=c.children(".image").hasClass("screencap"),i="finished"===c.closest("div").attr("class"),a=i?c.children(".original"):c.children(".image").children("a"),n=a.attr("href"),s=!i&&!o.test(n)&&/deviantart\.net\//.test(n),l=c.children(".broken-note").length;if(t||s||l){var r=$.mk("div").attr("class","align-center");t&&r.append($.mk("button","dialog-update-image").text("Update Image").attr("class","darkblue typcn typcn-pencil").data({$li:c,id:p})),s&&r.append($.mk("button","dialog-stash-fullsize-fix").text("Sta.sh fullsize fix").attr("class","orange typcn typcn-spanner").data({$li:c,id:p,finished:i,$fullsize_link:a})),l&&r.append($.mk("button","dialog-clear-broken-status").text("Clear broken status").attr("class","btn orange typcn typcn-spanner").data({$li:c,id:p})),e.append(r)}$.Dialog.request(!1,e,"Save",function(e){var n=e.find("[name=label]"),s=e.find("[name=type]"),l=void 0,r=void 0,o=void 0;if(d.label&&n.val(d.label),d.type&&s.children("option").filter(function(){return this.value===d.type}).attr("selected",!0),"string"==typeof d.posted_at){l=e.find("[name=posted_at]");var t=moment(d.posted_at);l.val(t.format())}if("string"==typeof d.reserved_at&&(r=e.find("[name=reserved_at]"),d.reserved_at.length)){var i=moment(d.reserved_at);r.val(i.format())}if("string"==typeof d.finished_at&&(o=e.find("[name=finished_at]"),d.finished_at.length)){var a=moment(d.finished_at);o.val(a.format())}e.on("submit",function(e){e.preventDefault();var t={label:n.val()};if(u&&(t.type=s.val()),"string"==typeof t.posted_at){if(t.posted_at=new Date(l.val()),isNaN(t.posted_at.getTime()))return $.Dialog.fail(!1,"Post timestamp is invalid");t.posted_at=t.posted_at.toISOString()}if("string"==typeof t.reserved_at){var i=r.val();if(i.length){if(t.reserved_at=new Date(i),isNaN(t.reserved_at.getTime()))return $.Dialog.fail(!1,'"Reserved at" timestamp is invalid');t.reserved_at=t.reserved_at.toISOString()}}if("string"==typeof t.finished_at){var a=o.val().trim();if(a.length){if(t.finished_at=new Date(a),isNaN(t.finished_at.getTime()))return $.Dialog.fail(!1,'"Finished at" timestamp is invalid');t.finished_at=t.finished_at.toISOString()}}$.Dialog.wait(!1,"Saving changes"),$.API.put("/post/"+p,t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);c.reloadLi(),$.Dialog.close()}))})})}))}).on("click","li[id] .cancel",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(t),a=i.id,n=i.type;$.Dialog.confirm("Cancel reservation","Are you sure you want to cancel this reservation?",function(e){e&&($.Dialog.wait(!1,"Cancelling reservation"),t.addClass("deleting"),"request"===n?$.API.delete("/post/"+a+"/reservation",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);t.removeClass("deleting").reloadLi(!1),$.Dialog.close()})):$.API.delete("/post/"+a+"/reservation",$.mkAjaxHandler(function(){return this.status?($.Dialog.close(),t[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){t.remove()})):$.Dialog.fail(!1,this.message)})))})}).on("click","li[id] .finish",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(t),a=i.id,n=i.type,s=$.capitalize(n),l=$.mk("form").attr("id","finish-res").append($.mk("label").append($.mk("span").text("Deviation URL"),$.mk("input").attr({type:"url",name:"deviation",spellcheck:!1,autocomplete:"off",required:!0})));void 0!==r&&l.append($.mk("label").append($.mk("span").text("Finished at"),$.mk("input").attr({type:"datetime",name:"finished_at",spellcheck:!1,autocomplete:"off",placeholder:"time()"}))),$.Dialog.request("Mark reservation as finished",l,"Finish",function(t){t.on("submit",function(e){e.preventDefault();var i=t.mkData();!function t(){$.Dialog.wait(!1,"Marking post as finished"),$.API.put("/post/"+a+"/finish",i,$.mkAjaxHandler(function(e){if(e.status)return $.Dialog.success(!1,s+" has been marked as finished"),void $("#"+n+"s").trigger("pls-update",[function(){"string"==typeof e.message&&e.message?$.Dialog.success(!1,e.message,!0):$.Dialog.close()}]);e.retry?$.Dialog.confirm(!1,e.message,["Continue","Cancel"],function(e){e&&(i.allow_overwrite_reserver=!0,t())}):$.Dialog.fail(!1,e.message)}))}()})})}).on("click","li[id] .unfinish",function(e){e.preventDefault();var t=$(this),i=t.closest("li"),a=$._getLiTypeId(i),n=a.id,s=a.type,l=t.hasClass("delete-only"),r=$.capitalize(s);$.Dialog.request((l?"Delete":"Un-finish")+" "+s,'<form id="unbind-check"><p>Are you sure you want to '+(l?"delete this reservation":"mark this "+s+" as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind '+s+" from user</label></form>","Un-finish",function(e){var i=e.find("[name=unbind]");l||e.prepend('<div class="notice info">By removing the "finished" flag, the post will be moved back to the "List of '+r+'" section</div>'),"reservation"===s?(i.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),l&&i.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(l?"reservation was added directly, it cannot be marked unfinished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),$w.trigger("resize"),e.on("submit",function(e){e.preventDefault();var t=i.prop("checked");$.Dialog.wait(!1,'Removing "finished" flag'+(t?" & unbinding from user":"")),$.API.delete("/post/"+n+"/finish"+(t?"?unbind":""),$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,void 0!==this.message?this.message:'"finished" flag removed successfully'),$("#"+s+"s").trigger("pls-update")}))})})}).on("click","li[id] .check",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(t).id;$.Dialog.wait("Submission approval status","Checking"),$.API.post("/post/"+i+"/approval",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this.message;t.reloadLi(),$.Dialog.success(!1,e,!0)}))}).on("click","li[id] .unlock",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(t).id;$.Dialog.confirm("Unlocking post","Are you sure you want to unlock this post?",function(e){e&&($.Dialog.wait(!1),$.API.delete("/post/"+i+"/approval",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);t.closest(".posts").trigger("pls-update")})))})}).on("click","li[id] .delete",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(t).id;$.Dialog.confirm("Deleting request #"+i,"You are about to permanently delete this request.<br>Are you sure about this?",function(e){e&&($.Dialog.wait(!1),t.addClass("deleting"),$.API.delete("/post/request/"+i,$.mkAjaxHandler(function(){if(!this.status)return t.removeClass("deleting"),$.Dialog.fail(!1,this.message);$.Dialog.close(),t[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){t.remove()})})))})}).on("click","li[id] .pls-transfer",function(e){e.preventDefault();var t=$(this).closest("li"),i=$._getLiTypeId(),a=i.id,n=i.type,s=t.children(".reserver").find(".name").text();$.Dialog.confirm("Take on reservation of "+n+" #"+a,"<p>Using this option, you can express your interest in finishing the "+n+" which "+s+" already reserved.</p>\n\t\t\t\t<p>They will be sent a notification letting them know you're interested and they'll be able to allow/deny the transfer of the reserver status as they see fit.</p>\n\t\t\t\t<p>Once "+s+" responds to your inquiry you'll receive a notification informing you about their decision. If they agreed, the post's reservation will be transferred to you immediately.</p>\n\t\t\t\t<p><strong>Are you sure you can handle this "+n+"?</strong></p>",function(e){e&&($.Dialog.wait(!1),$.API.post("/post/"+a+"/transfer",$.mkAjaxHandler(function(){return this.canreserve?$.Dialog.confirm(!1,this.message,function(e){e&&l(t,!1,a)}):this.status?void $.Dialog.success(!1,this.message,!0):$.Dialog.fail(!1,this.message)})))})}),$body.on("click","#dialog-update-image",function(e){e.preventDefault();var t=$(this).data(),a=t.$li,n=t.id;$.Dialog.close();var i=a.children(".image").find("img"),s=$.mk("form").attr("id","img-update-form").append($.mk("div").attr("class","oldimg").append($.mk("span").text("Current image"),i.clone()),$.mk("label").append($.mk("span").text("New image URL"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{2,255}$",name:"image_url",required:!0,autocomplete:"off",spellcheck:"false"})));$.Dialog.request("Update image of post #"+n,s,"Update",function(i){i.on("submit",function(e){e.preventDefault();var t=i.mkData();$.Dialog.wait(!1,"Replacing image"),$.API.put("/post/"+n+"/image",t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if($.Dialog.success(!1,"Image has been updated",!0),this.li){var e=$(this.li);a.hasClass("highlight")&&e.addClass("highlight"),a.replaceWith(e),Time.update(),e.rebindFluidbox()}else a.reloadLi()}))})})}).on("click","#dialog-stash-fullsize-fix",function(e){e.preventDefault();var t=$(this).data(),i=t.$li,a=t.id,n=t.finished,s=t.$fullsize_link;$.Dialog.close(),$.Dialog.wait("Fix Sta.sh fullsize URL","Fixing Sta.sh full size image URL"),$.API.post("/post/"+a+"/fix-stash",$.mkAjaxHandler(function(){if(!this.status){if(this.rmdirect){if(!n)return i.find(".post-date").children("a").first().triggerHandler("click"),$.Dialog.fail(!1,this.message+"<br>The post might be broken because of this, please check it for any issues.");i.children(".original").remove()}return $.Dialog.fail(!1,this.message)}s.attr("href",this.fullsize),$.Dialog.success(!1,"Fix successful",!0)}))}).on("click","#dialog-clear-broken-status",function(e){e.preventDefault();var t=$(this).data(),i=t.$li,a=t.id;$.Dialog.close(),$.Dialog.wait("Clear post broken status","Checking image availability"),$.API.get("/post/"+a+"/unbreak",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var e=$(this.li);i.hasClass("highlight")&&e.addClass("highlight"),i.replaceWith(e),Time.update(),e.rebindFluidbox()}$.Dialog.close()}))})}();