"use strict";!function(){var t=window.PRINTABLE_ASCII_PATTERN,e=window.EVENT_TYPES,p=Boolean(window.EventPage),n=$.mk("select").attr({name:"type",required:!0}).append('<option value="" style="display:none">(choose event type)</option>').on("change",function(){var t=$(this),e="contest"===t.val();t.parent().siblings(".who-vote")[e?"removeClass":"addClass"]("hidden").find("select")[e?"enable":"disable"]("hidden")}),a=$.mk("optgroup").attr("label","Available types").appendTo(n);$.each(e,function(t,e){a.append('<option value="'+t+'">'+e+"</option>")});var i=$.mk("form","event-editor").append($.mk("label").append("<span>Event name (2-64 chars.)</span>",$.mk("input").attr({type:"text",name:"name",minlength:2,maxlength:64,required:!0}).patternAttr(t)),'<div class="label">\n\t\t\t\t<span>Description (1-3000 chars.)<br>Uses <a href="https://help.github.com/articles/basic-writing-and-formatting-syntax/" target="_blank">Markdown</a> formatting</span>\n\t\t\t\t<div class="code-editor"></div>\n\t\t\t</div>',$.mk("label").append("<span>Event type (cannot ba changed later)</span>",n),$.mk("label").attr("class","who-vote hidden").append("<span>Who can vote on the entries?</span>",'<select name="vote_role" required>\n\t\t\t\t\t<optgroup label="Roles">\n\t\t\t\t\t\t<option value="user" selected>Any DeviantArt User</option>\n\t\t\t\t\t\t<option value="member">Club Members</option>\n\t\t\t\t\t\t<option value="staff">Staff Members</option>\n\t\t\t\t\t</optgroup>\n\t\t\t\t</select>'),$.mk("div").attr("class","label").append("<span>Start date & time</span>",$.mk("div").attr("class","input-group-2").append('<input type="date" name="start_date">','<input type="time" name="start_time">')),$.mk("div").attr("class","notice info align-center").html("Leave <q>Start date & time</q> blank if you want the event to start immediately after you press Add. Always specify times in your computer's timezone."),$.mk("div").attr("class","label").append("<span>End date & time</span>",$.mk("div").attr("class","input-group-2").append('<input type="date" name="end_date" required>','<input type="time" name="end_time" required>')),$.mk("div").attr("class","label").append("<span>Who can enter & how many times?</span>",$.mk("div").attr("class","input-group-2").append('<select name="entry_role" required>\n\t\t\t\t\t\t<optgroup label="Role in the group">\n\t\t\t\t\t\t\t<option value="user" selected>Any DeviantArt User</option>\n\t\t\t\t\t\t\t<option value="member">Club Members</option>\n\t\t\t\t\t\t\t<option value="staff">Staff Members</option>\n\t\t\t\t\t\t</optgroup>\n\t\t\t\t\t\t<optgroup label="Special">\n\t\t\t\t\t\t\t<option value="spec_discord">Discord Server Members</option>\n\t\t\t\t\t\t</optgroup>\n\t\t\t\t\t</select>','<input type="text" name="max_entries" pattern="^(0*[1-9]\\d*|[Uu]nlimited|0)$" list="max_entries-list" value="1">\n\t\t\t\t\t<datalist id="max_entries-list">\n\t\t\t\t\t\t<option value="Unlimited">\n\t\t\t\t\t\t<option value="1">\n\t\t\t\t\t</datalist>')),$.mk("div").attr("class","notice info align-center").html("Enter <q>0</q> or <q>Unlimited</q> to remove the number of entries cap.")),o=function(t,r,n){var l=!!n,d=void 0;if(p){if(!l)return;d=$content.children("h1")}else d=t.siblings().first();$.Dialog.request(r,i.clone(!0,!0),"Save",function(i){var o=void 0,s=$.renderCodeMirror({$el:i.find(".code-editor"),mode:"markdown"});if(l){if(o=n.eventID,i.find("input[name=name]").val(n.name),i.find("[name=type]").parent().remove(),i.find("[name=entry_role]").val(n.entry_role),i.find("[name=max_entries]").val(n.max_entries?n.max_entries:"Unlimited"),n.starts_at){var t=moment(n.starts_at);i.find('input[name="start_date"]').val($.momentToYMD(t)),i.find('input[name="start_time"]').val($.momentToHM(t))}if(n.ends_at){var e=moment(n.ends_at);i.find('input[name="end_date"]').val($.momentToYMD(e)),i.find('input[name="end_time"]').val($.momentToHM(e))}n.desc_src&&s.setValue(n.desc_src)}i.on("submit",function(t){t.preventDefault();var n=i.mkData();if(n.description=s.getValue(),n.start_date&&n.start_time){var e=$.mkMoment(n.start_date,n.start_time);n.starts_at=e.toISOString()}var a=$.mkMoment(n.end_date,n.end_time);n.ends_at=a.toISOString(),delete n.start_date,delete n.start_time,delete n.end_date,delete n.end_time,$.Dialog.wait(!1,"Saving changes"),p&&(n.EVENT_PAGE=!0),$.API[l?"put":"post"]("/event"+(l?"/"+o:""),n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(n=this,l)p?($.Dialog.wait(!1,"Reloading page",!0),$.Navigation.reload(function(){$.Dialog.close()})):(d.text(n.name),n.newurl&&d.attr("href",function(t,e){return e.replace(/\/[^/]+$/,"/"+n.newurl)}),$.Dialog.close());else{$.Dialog.success(r,"Event added");var t=function(){$.Dialog.wait(r,"Loading event page"),$.Navigation.visit(n.goto)};if(!n.info)return t();$.Dialog.segway(r,n.info,"Continue to event",t)}}))})})};$("#add-event").on("click",function(t){t.preventDefault(),o($(this),"Add new event")}),$content.on("click","[id^=event-] .edit-event",function(t){t.preventDefault();var e=$(this),n=e.closest("[id^=event-]").attr("id").split("-")[1],a="Editing event #"+n;$.Dialog.wait(a,"Retrieving event details from server"),$.API.get("/event/"+n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.eventID=n,o(e,a,this)}))}),$content.on("click","[id^=event-] .finalize-event",function(t){t.preventDefault();var n=$(this).closest("[id^=event-]").attr("id").split("-")[1],e="FInalize event #"+n,a=$.mk("form","finalize-event-form").append('<label>\n\t\t\t\t\t<span>Deviation link</span>\n\t\t\t\t\t<input type="url" name="favme" required>\n\t\t\t\t</label>');$.Dialog.request(e,a,"Finalize event",function(){a.on("submit",function(t){t.preventDefault();var e=a.mkData();$.Dialog.wait(!1,"Finalizing event"),$.API.post("/event/"+n+"/finalize",e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,"Event finalized successfully"),$.Navigation.reload(!0)}))})})}),$content.on("click","[id^=event-] .delete-event",function(t){t.preventDefault();var e=$(this).closest("[id^=event-]"),n=e.attr("id").split("-")[1],a=p?$content.children("h1").text():e.find(".event-name").html();$.Dialog.confirm("Delete event #"+n,'Are you <strong class="color-red"><em>ABSOLUTELY</em></strong> sure you want to delete &ldquo;'+a+"&rdquo; along with all submissions?",function(t){t&&($.Dialog.wait(!1),$.API.delete("/event/"+n,$.mkAjaxHandler(function(){return this.status?p?($.Dialog.success(!1,"Event deleted successfully"),$.Dialog.wait(!1,"Redirecting to event list"),void $.Navigation.visit("/events")):void $.Navigation.reload(!0):$.Dialog.fail(!1,this.message)})))})})}();