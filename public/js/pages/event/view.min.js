"use strict";!function(){var t=window.PRINTABLE_ASCII_PATTERN,r=$("#event-entries"),e=$.mk("form","new-entry").append('<label>\n\t\t\t<span>Entry link</span>\n\t\t\t<input type="url" name="link" required>\n\t\t</label>\n\t\t<div class="notice info">This must point to a deviation on DeviantArt or a Sta.sh upload. A Sta.sh link will not be visible to the public, so use that if you do not want to share the source file with anyone other than the staff. For collaboration events, you only need to submit the source file, we\'ll take care of the rest.</div>',$.mk("label").append("<span>Entry title</span>",$.mk("input").attr({type:"text",name:"title",required:!0,pattern:t.replace("+","{2,64}"),minlength:2,maxlength:64})),'<div class="notice info">Here you can enter the name of the character you\'re submitting for example.</div>\n\t\t<label>\n\t\t\t<span>Preview (optional)</span>\n\t\t\t<input type="url" name="prev_src">\n\t\t</label>\n\t\t<div class="notice info">You can link to a preview of your submission from any of the <a href="/about#supported-providers" target="_blank">supported image providers</a>. This will be displayed alongside your submission on the event page. You should only use this if your submission doesn\'t have a preview of its own.</div>');function i(){$(".entry-deviation-promise").each(function(){var i=$(this);if(i.isInViewport()){var t=i.attr("data-entryid");$.API.get("/event/entry/"+t+"/lazyload",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Failed to load preview for entry #"+t,this.message);$.loadImages(this.html).then(function(t){var e=i.closest("li[id]");i.replaceWith(t.$el),e.rebindFluidbox()})}))}})}$.fn.rebindFluidbox=function(){return this.find(".preview > a:not(.fluidbox--initialized)").fluidboxThis(),this},$("#enter-event").on("click",function(t){t.preventDefault();var n=$(this).closest("[id^=event-]").attr("id").split("-")[1];$.Dialog.wait("New entry","Checking whether you can submit any more entries"),$.API.get("/event/"+n+"/check-entries",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.message&&$.Dialog.success(!1,this.message),$.Dialog.request(!1,e.clone(),"Enter",function(i){i.on("submit",function(t){t.preventDefault();var e=i.mkData();$.Dialog.wait(!1,"Submitting your entry"),$.API.post("/event/"+n+"/entry",e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);r.html(this.entrylist).rebindFluidbox(),$.Dialog.close()}))})})}))}),r.rebindFluidbox().on("click",".edit-entry",function(t){t.preventDefault();var n=$(this).closest("[id^=entry-]"),a=n.attr("id").split("-")[1];$.Dialog.wait("Editing entry #"+a,"Retrieving entry details from server"),$.API.get("/event/entry/"+a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=this;$.Dialog.request(!1,e.clone(),"Save",function(i){t.link&&i.find('input[name="link"]').val(t.link),t.title&&i.find('input[name="title"]').val(t.title),t.prev_src&&i.find('input[name="prev_src"]').val(t.prev_src),i.on("submit",function(t){t.preventDefault();var e=i.mkData();$.Dialog.wait(!1,"Saving changes"),$.API.put("/event/entry/"+a,e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);n.html(this.entryhtml).rebindFluidbox(),$.Dialog.close()}))})})}))}),r.on("click",".delete-entry",function(t){t.preventDefault();var e=$(this).closest("[id^=entry-]"),i=e.attr("id").split("-")[1],n=e.find(".label").text();$.Dialog.confirm("Withdraw entry #"+i,"Are you sure you want to withdraw the entry <q>"+n+"</q>?",function(t){t&&($.Dialog.wait(!1,"Sending deletion request"),$.API.delete("/event/entry/"+i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.close(),e.fadeOut(500,function(){e.remove()})})))})}),r.on("click",".voting > button",function(t){t.preventDefault();var e=$(this),i=e.closest("[id^=entry-]").attr("id").split("-")[1],n=e.hasClass("upvote")?1:-1,a=e.hasClass("clicked");e.siblings("button").addBack().disable(),$.API[a?"delete":"post"]("/event/entry/"+i+"/vote",{value:n},$.mkAjaxHandler(function(){var t=e.siblings("button");if(this.disable||t.addBack().enable(),!this.status)return $.Dialog.fail("Voting on entry #"+i,this.message);e[a?"removeClass":"addClass"]("clicked"),t.removeClass("clicked"),e.siblings(".score").text(this.score),r.triggerHandler("reorder-items")}))}).on("reorder-items",function(){0!==r.find(".voting").length&&r.children().sort(function(t,e){var i=parseInt($(t).find(".score").text().replace(/^\D/,"-"),10),n=parseInt($(e).find(".score").text().replace(/^\D/,"-"),10);return i<n?1:n<i?-1:0}).appendTo(r)}),$.fn.refreshVoting=function(){var t=this,e=t.attr("id").split("-")[1];$.API.get("/event/entry/"+e+"/vote",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Refresh voting buttons of entry #"+e,this.message);t.find(".voting").replaceWith(this.voting),r.triggerHandler("reorder-items")}))},"contest"===window.EventType&&$.WS.recvEntryUpdates(!0),window._EventScroll=$.throttle(400,function(){i()}),$w.on("scroll mousewheel",window._EventScroll),i()}();