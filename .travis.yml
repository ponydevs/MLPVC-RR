language: php
php:
  - '7.4'
before_install:
  - echo "extension = redis.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - # https://github.com/travis-ci/travis-ci/issues/9624#issuecomment-389537036
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
  - sudo service postgresql restart
  - sleep 1
install:
  - cp .env.example .env
  - composer install
services:
  - postgresql
before_script:
  - psql -c 'CREATE DATABASE "winterchilla";' -U postgres
  - psql -c "CREATE USER \"winterchilla\" WITH LOGIN PASSWORD 'example-password'" -U postgres
  - psql "winterchilla" < ./setup/create_extensions.pg.sql
  - vendor/bin/phinx migrate
dist: bionic
addons:
  postgresql: "12"
  apt:
    packages:
    - postgresql-12
    - postgresql-client-12
env:
  global:
  - PGPORT=5433
