DocReady.push(function(){"use strict";function t(t){t.children(".tag").sort(function(t,e){var a=/^.*typ-([a-z]+).*$/;return t=[t.className.replace(a,"$1"),t.innerHTML.trim()],e=[e.className.replace(a,"$1"),e.innerHTML.trim()],t[0]===e[0]?t[1].localeCompare(e[1]):t[0].localeCompare(e[0])}).appendTo(t)}function e(t,e,a){var n="Create new tag",r=t.closest(".tags"),o=r.closest("[id^=p]"),s=o.attr("id").substring(1),l=m?$content.children("h1").text():r.siblings("strong").text().trim();$.Dialog.request(n,D.clone(!0,!0),"edit-tag","Create",function(t){t.append($.mk("label").append($.mk("input").attr({type:"checkbox",name:"addto"}).val(s).prop("checked","string"==typeof e),document.createTextNode(' Add this tag to the appearance "'+l+'" after creation'))),$.Dialog.center(),"string"==typeof a&&"undefined"!=typeof c[a]&&t.find("input[name=type][value="+a+"]").prop("checked",!0).trigger("change"),"string"==typeof e&&t.find("input[name=name]").val(e),t.on("submit",function(e){e.preventDefault();var a=t.mkData();$.Dialog.wait(!1,"Creating tag"),$.post("/colorguide/maketag"+g,a,$.mkAjaxHandler(function(){return this.status?(this.tags&&(r.children("[data-hasqtip]").qtip("destroy",!0),r.html(this.tags),window.tooltips(),i()),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}function a(t,e){var a=this;if("undefined"!=typeof e){var n;if(e instanceof jQuery){var r=e.attr("id").substring(2);n=e.parents("[id^=p]").attr("id").substring(1)}else n=e}$.Dialog.request(t,w.clone(!0,!0),"cg-editor","Save",function(t){var o=t.find("input[name=label]"),s=t.find("input[name=major]"),l=t.find("input[name=reason]"),c="object"==typeof a&&a.label&&a.Colors;c&&(o.val(a.label),t.trigger("render-color-inputs",[a.Colors])),t.on("submit",function(a){a.preventDefault();var d={label:o.val(),Colors:[]};return c||(d.ponyid=n),t.find(".clr").each(function(){var t=$(this),e=t.children(".clri");if(p.test(e.val())){var a=t.data("id"),i={hex:e.val().replace(p,"#$1").toUpperCase()};"undefined"!=typeof a&&(i.colorid=parseInt(a,10)),i.label=t.children(".clrl").val(),d.Colors.push(i)}}),0===d.Colors.length?$.Dialog.fail(!1,"You need to have at least 1 valid color"):(d.Colors=JSON.stringify(d.Colors),s.is(":checked")&&(d.major=!0,d.reason=l.val()),m&&(d.OUTPUT_COLOR_NAMES=!0,d.NO_COLON=!0),$.Dialog.wait(!1,"Saving changes"),void $.post("/colorguide/"+(c?"set":"make")+"cg"+(c?"/"+r:"")+g,d,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.cg||this.cgs){if(this.cg)e.children("[data-hasqtip]").qtip("destroy",!0),e.html(this.cg),this.update&&e.parents("li").find(".update").html(this.update);else if(this.cgs){var t=$("#p"+n);this.update&&t.find(".update").html(this.update),t.find("ul.colors").html(this.cgs)}window.tooltips(),i(),this.update&&window.updateTimes()}$.Dialog.close()})))})})}function i(){q.children("span:not(.ctxmenu-bound)").ctxmenu([{text:"Edit tag",icon:"pencil",click:function(){var e=$(this),a=e.text().trim(),i=e.attr("class").match(/id-(\d+)(?:\s|$)/)[1],n="Editing tag: "+a;$.Dialog.wait(n,"Retrieveing tag details from server"),$.post("/colorguide/gettag/"+i+g,$.mkAjaxHandler(function(){var e=this;this.status?$.Dialog.request(n,D.clone(!0,!0),"edit-tag","Save",function(a){a.find("input[name=type][value="+e.type+"]").prop("checked",!0),a.find("input[type=text][name], textarea[name]").each(function(){var t=$(this);t.val(e[t.attr("name")])}),a.on("submit",function(e){e.preventDefault();var n=a.mkData();$.Dialog.wait(!1,"Saving changes"),$.post("/colorguide/settag/"+i+g,n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$(".id-"+this.tid);e.qtip("destroy",!0),this.title?e.attr("title",this.title):e.removeAttr("title"),e.attr("class","tag id-"+this.tid+(this.type?" typ-"+this.type:"")).text(this.name).data("ctxmenu-items").eq(0).text("Tag: "+this.name),e.parent().each(function(){t($(this))}),window.tooltips(),$.Dialog.close()}))})}):$.Dialog.fail(n,this.message)}))}},{text:"Remove tag",icon:"minus",click:function(){var t=$(this),e=t.attr("class").match(/id-(\d+)(?:\s|$)/);if(!e)return!1;e=e[1];var a=t.closest("[id^=p]").attr("id").replace(/\D/g,""),i=t.text().trim(),n="Remove tag: "+i;$.Dialog.confirm(n,"The tag "+i+" will be removed from this appearance.<br>Are you sure?",["Remove it","Nope"],function(i){if(i){var r={tag:e};$.Dialog.wait(n,"Removing tag"),m&&(r.needupdate="?"),$.post("/colorguide/untag/"+a+g,r,$.mkAjaxHandler(function(){return this.status?(this.needupdate===!0&&o.html(this.eps).parent()[this.eps.length?"show":"hide"](),t.qtip("destroy",!0),t.remove(),void $.Dialog.close()):$.Dialog.fail(n,this.message)}))}})}},{text:"Delete tag",icon:"trash",click:function(){var t=$(this),e=t.text().trim(),a=t.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Detele tag: "+e;$.Dialog.confirm(i,"Deleting this tag will also remove it from every appearance where it's been used.<br>Are you sure?",["Delete it","Nope"],function(t){if(t){var e={};$.Dialog.wait(i,"Sending removal request"),m&&(e.needupdate="?"),function n(t){$.post("/colorguide/deltag/"+a+g,t,$.mkAjaxHandler(function(){if(this.status){this.needupdate===!0&&o.html(this.eps).parent()[this.eps.length?"show":"hide"]();var e=$(".id-"+a);e.qtip("destroy",!0),e.remove(),$.Dialog.close()}else this.confirm?$.Dialog.confirm(!1,this.message,["NUKE TAG","Nevermind"],function(e){e&&(t.sanitycheck=!0,n(t))}):$.Dialog.fail(i,this.message)}))}(e)}})}},!0,{text:"Create new tag",icon:"plus",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(t){return"Tag: "+t.text().trim()});var n=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"/colorguide/gettags?s=%QUERY",wildcard:"%QUERY"}}),c=[Key.Enter,Key.Comma];q.children(".addtag").each(function(){var t=$(this),a=t.closest("[id^=p]").attr("id").substring(1);t.typeahead(null,{name:"tags",display:"name",source:n,templates:{suggestion:Handlebars.compile('<span class="tag id-{{tid}} {{type}}">{{name}}</span>')}}),t.on("keydown",function(n){if(-1!==c.indexOf(n.keyCode)){n.preventDefault();var r=t.val().trim(),s=t.parents(".tags"),l=s.children(".tag"),p="Adding tag: "+r;if(l.filter(function(){return this.innerHTML.trim()===r}).length>0)return $.Dialog.fail(p,"This appearance already has this tag");$.Dialog.setFocusedElement(t.attr("disabled",!0)),t.parent().addClass("loading");var d={tag_name:r};m&&(d.needupdate="?"),$.post("/colorguide/tag/"+a+g,d,$.mkAjaxHandler(function(){if(t.removeAttr("disabled").parent().removeClass("loading"),this.status)this.needupdate===!0&&o.html(this.eps).parent().show(),s.children("[data-hasqtip]").qtip("destroy",!0),s.children(".tag").remove(),s.append($(this.tags).filter("span")),window.tooltips(),i(),t.typeahead("val","").focus();else{if("string"==typeof this.cancreate){var a=this.cancreate,n=this.typehint;return p=p.replace(r,a),$.Dialog.confirm(p,this.message,function(i){i&&e(t,a,n)})}$.Dialog.fail(p,this.message)}}))}}),t.nextAll(".tt-menu").on("click",".tag",function(){t.trigger({type:"keydown",keyCode:13})})}),r=$("ul.colors").attr("data-color",l),r.filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Re-order "+l+" groups",icon:"arrow-unsorted",click:function(){var t=$(this),e=t.closest("[id^=p]"),a=e.attr("id").substring(1),n=m?$content.children("h1").text():e.children().last().children("strong").text().trim(),r="Re-order "+l+" groups on appearance: "+n;$.Dialog.wait(r,"Retrieving color group list from server"),$.post("/colorguide/getcgs/"+a+g,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(this.message);var e=x.clone(),n=$.mk("ol");$.each(this.cgs,function(t,e){n.append($.mk("li").attr("data-id",e.groupid).text(e.label))}),$.mk("div").attr("class","cgs").append('<p class="align-center">Drag to re-arrange</p>',n).prependTo(e),$.Dialog.center(),new Sortable(n.get(0),{ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.request(r,e,"cg-reorder","Save",function(e){e.on("submit",function(n){n.preventDefault();var r={cgs:[]},o=e.children(".cgs");return o.length?(o.find("ol").children().each(function(){r.cgs.push($(this).attr("data-id"))}),r.cgs=r.cgs.join(","),$.Dialog.wait(!1,"Saving changes"),m&&(r.OUTPUT_COLOR_NAMES=!0,r.NO_COLON=!0),void $.post("/colorguide/setcgs/"+a+g,r,$.mkAjaxHandler(function(){return this.status?(t.html(this.cgs),window.tooltips(),i(),void $.Dialog.close()):$.Dialog.fail(null,this.message)}))):$.Dialog.fail(!1,"There are no color groups to re-order")})})}))}},{text:"Create new group",icon:"folder-add",click:function(){a("Create "+l+" group",$(this).closest("[id^=p]").attr("id").substring(1))}},{text:"Apply template (if empty)",icon:"document-add",click:function(){var t=$(this).parents("li").attr("id").substring(1);$.Dialog.confirm("Apply template on appearance","Add common color groups to this appearance?<br>Note: This will only work if there are no color groups currently present.",function(e){e&&($.Dialog.wait(!1,"Applying template"),$.post("/colorguide/applytemplate/"+t+g,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$("#p"+t);e.find("ul.colors").html(this.cgs),window.tooltips(),i(),$.Dialog.close()})))})}}],s+" groups"),r.children("li").filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Edit "+l+" group",icon:"pencil",click:function(){var t=$(this),e=t.closest("li"),i=e.attr("id").substring(2),n=t.children().first().text().replace(/:\s?$/,""),r="Editing "+l+" group: "+n;$.Dialog.wait(r,"Retrieving "+l+" group details from server"),$.post("/colorguide/getcg/"+i+g,$.mkAjaxHandler(function(){return this.status?void a.call(this,r,e):$.Dialog.fail(r,this.message)}))}},{text:"Delete "+l+" group",icon:"trash",click:function(){var t=$(this).closest("li"),e=t.attr("id").substring(2),a=t.children().first().text().replace(/:\s?$/,""),i="Delete "+l+" group: "+a;$.Dialog.confirm(i,"By deleting this "+l+" group, all "+l+"s within will be removed too.<br>Are you sure?",function(a){a&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/delcg/"+e+g,$.mkAjaxHandler(function(){this.status?(t.children("[data-hasqtip]").qtip("destroy",!0),t.remove(),$.Dialog.close()):$.Dialog.fail(i,this.message)})))})}},!0,{text:"Re-order "+l+" groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}}],function(t){return s+" group: "+t.children().first().text().trim().replace(":","")});var p=r.children("li").children("span[id^=c]:not(:empty)");p.length||(p=r.children("li").children(".color-line").children(":first-child")),$.ctxmenu.addItems(p.filter(":not(.ctxmenu-bound)"),!0,{text:"Edit "+l+" group",icon:"pencil",click:function(){$.ctxmenu.triggerItem($(this).parents(".ctxmenu-bound"),1)}},{text:"Delete "+l+" group",icon:"trash",click:function(){$.ctxmenu.triggerItem($(this).parents(".ctxmenu-bound"),2)}},!0,{text:"Re-order "+l+" groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parents(".ctxmenu-bound"),3)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parents(".ctxmenu-bound"),4)}}),$(".upload-wrap").filter(":not(.ctxmenu-bound)").each(function(){var t=$(this),e=t.closest("li");e.length||(e=$content.children("[id^=p]"));var a=e.attr("id").substring(1);!function(e){t.uploadZone({requestKey:"sprite",title:"Upload sprite",accept:"image/png",target:"/colorguide/setsprite/"+e}).on("uz-uploadstart",function(){$.Dialog.close()}).ctxmenu([{text:"Open image in new tab",icon:"arrow-forward","default":!0,attr:{href:t.find("img").attr("src"),target:"_blank"}},{text:"Copy image URL",icon:"clipboard",click:function(){$.copy($.urlToAbsolute(t.find("img").attr("src")))}},{text:"Upload new sprite",icon:"upload",click:function(){var a="Upload sprite image",i=t.find('input[type="file"]');$.Dialog.request(a,h.clone(),"sprite-img","Download image",function(t){var n=t.find("input[name=image_url]");t.find("a").on("click",function(t){t.preventDefault(),t.stopPropagation(),i.trigger("click",[!0])}),t.on("submit",function(t){t.preventDefault();var r=n.val();$.Dialog.wait(a,"Downloading external image to the server"),$.post("/colorguide/setsprite/"+e+g,{image_url:r},$.mkAjaxHandler(function(){this.status?i.trigger("set-image",[this.path]):$.Dialog.fail(a,this.message)}))})})}}],"Sprite image").attr("title",d?" ":"").on("click",function(e,a){return a===!0?!0:(e.preventDefault(),void t.data("ctxmenu-items").eq(1).children().get(0).click())})}(a)})}function n(){$("button.edit").on("click",function(){var t=$(this),e=t.closest("[id^=p]"),a=e.attr("id").substring(1),i=m?$content.children("h1").text():t.parent().text().trim(),n="Editing appearance: "+i;$.Dialog.wait(n,"Retrieving appearance details from server"),$.post("/colorguide/get/"+a+g,$.mkAjaxHandler(function(){var e=this;e.status?(e.ponyID=a,k(t,n,e)):$.Dialog.fail(n,this.message)}))}).next(".delete").on("click",function(){var t=$(this),e=t.closest("li"),a=e.attr("id").substring(1),i=t.parent().text().trim(),n="Deleting appearance: "+i;$.Dialog.confirm(n,"Deleting this appearance will remove <strong>ALL</strong> of its color groups, the colors within them, and the sprite file, if any.<br>Delete anyway?",function(t){t&&($.Dialog.wait(n,"Sending removal request"),$.post("/colorguide/delete/"+a+g,$.mkAjaxHandler(function(){if(this.status){e.remove(),$.Dialog.success(n,this.message);var t=window.location.pathname;0===f.children().length&&(t=t.replace(/(\d+)$/,function(t){return t>1?t-1:t})),$.toPage(t,!0,!0)}else $.Dialog.fail(n,this.message)})))})}),q=$(".tags").ctxmenu([{text:"Create new tag",icon:"plus",click:function(){e($(this))}}],"Tags"),i()}var r,o,s=window.Color,l=window.color,c=window.TAG_TYPES_ASSOC,p=window.HEX_COLOR_PATTERN,d="WebkitAppearance"in document.documentElement.style,u=window.EQG,g=u?"?eqg":"",m=!!window.AppearancePage,h=$.mk("form").attr("id","sprite-img").html('<p class="align-center"><a href="#upload">Click here to upload a file</a> (max. '+window.MAX_SIZE+') or enter a URL below.</p><label><input type="text" name="image_url" placeholder="External image URL" required></label><p class="align-center">The URL will be checked against the supported provider list, and if an image is found, it\'ll be downloaded to the server and set as this appearance\'s sprite image.</p>');m&&(o=$("#ep-appearances").children("p"));var f=$(".appearance-list"),v=$.mk("form").attr("id","pony-editor").append($.mk("label").append($.mk("span").text("Name (4-70 chars.)"),$.mk("input").attr({name:"label",placeholder:"Enter a name",pattern:PRINTABLE_ASCII_REGEX.replace("+","{4,70}"),required:!0,maxlength:70})),$.mk("label").append($.mk("span").text("Additional notes (255 chars. max, optional)"),$.mk("textarea").attr({name:"notes",maxlength:255})),$.mk("label").append($.mk("span").text("Link to cutie mark (optional)"),$.mk("input").attr({name:"cm_favme",placeholder:"DeviantArt submission URL"}))),k=function(t,e,a){var i,n=!!a,r=t.parents("[id^=p]"),o=r.find(".notes");if(m){if(!n)return;i=$content.children("h1")}else i=t.parent();$.Dialog.request(e,v.clone(),"pony-editor","Save",function(t){if(n){t.find("input[name=label]").val(a.label);var r=t.find("textarea");r.val(a.notes),0===parseInt(a.ponyID,10)&&r.removeAttr("maxlength"),t.find("input[name=cm_favme]").val(a.cm_favme),t.append($.mk("div").attr("class","align-center").append($.mk("button").attr("class","blue typcn typcn-image").text("Update rendered image").on("click",function(t){t.preventDefault(),$.Dialog.close(),$.Dialog.wait("Clear appearance image cache","Clearing cache"),$.post("/colorguide/clearrendercache/"+a.ponyID,$.mkAjaxHandler(function(){return this.status?void $.Dialog.success(!1,this.message,!0):$.Dialog.fail(!1,this.message)}))})))}else t.append($.mk("label").append($.mk("input").attr({type:"checkbox",name:"template"})," Pre-fill with common color groups")),$.Dialog.center();t.on("submit",function(r){r.preventDefault();var s=t.mkData();$.Dialog.wait(!1,"Saving changes"),m&&(s.noreturn=!0),$.post("/colorguide/"+(n?"set/"+a.ponyID:"make")+g,s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(n)m?($.Dialog.success(!1,"Metadata updated"),$.Dialog.wait(!1,"Reloading page"),HandleNav.reload(function(){$.Dialog.close()})):(i.children().first().text(this.label),o.html(this.notes),$.Dialog.close());else{$.Dialog.success(e,this.message,!0);var t=this.id,a=this.info;f.filter("#list").one("page-switch",function(i){var n=$("#p"+t);n.length&&$body.scrollTop(n.offset().top-n.outerHeight()/2),a&&(i.preventDefault(),$.Dialog.info(e,a))}),$.toPage(window.location.pathname.replace(/(\d+)?$/,this.page),!0,!0)}}))})})},x=$.mk("form").attr("id","cg-reorder").append($.mk("div").attr("class","notice").hide().html("<p></p>"));$("#new-appearance-btn").on("click",function(){k($(this),"Add new "+(u?"Character":"Pony"))});var D=$.mk("form").attr("id","edit-tag");D.append('<label><span>Tag name (4-30 chars.)</span><input type="text" name="name" required pattern="^.{4,30}$" maxlength="30"></label>');var b=$.mk("div").addClass("type-selector");$.each(c,function(t,e){var a=$.mk("label"),i=$.mk("input").attr({type:"checkbox",name:"type",value:t}).on("change",function(){this.checked&&$(this).parent().siblings().find("input").prop("checked",!1)});a.append(i,$.mk("span").addClass("tag typ-"+t).text(e)).appendTo(b)}),D.append($.mk("div").addClass("align-center").append("<span>Tag type (optional)</span><br>",b),$.mk("label").append('<span>Tag description (max 255 chars., optional)</span><br><textarea name="title" maxlength="255"></textarea>'),$.mk("div").attr("class","notice").hide().html("<p></p>"));var w=$.mk("form").attr("id","cg-editor"),y=$.mk("span").attr("class","clrp"),A=$.mk("input").attr({"class":"clri",pattern:p.toString().replace(/\//g,""),autocomplete:"off",spellcheck:"false"}).on("keyup change input",function(){var t=$(this),e=t.prev(),a=p.test(this.value);a?e.removeClass("invalid").css("background-color",this.value.replace(p,"#$1")):e.addClass("invalid"),t.next().attr("required",a)}).on("paste blur",function(t){var e=this,a=$(e),i=/^#?([A-Fa-f0-9]{3})$/,n=function(){var n=e.value;if(i.test(n)){var r=n.match(i)[1];n="#"+r[0]+r[0]+r[1]+r[1]+r[2]+r[2]}p.test(n)&&(a.val(n.replace(p,"#$1").toUpperCase()).trigger("change"),"blur"!==t.type&&a.next().focus())};"paste"===t.type?setTimeout(n,10):n()}),C=$.mk("input").attr({"class":"clrl",pattern:PRINTABLE_ASCII_REGEX.replace("+","{3,30}")}),T=$.mk("div").attr("class","clra").append($.mk("span").attr("class","typcn typcn-minus remove red").on("click",function(){$(this).closest(".clr").remove(),$.Dialog.center()})).append($.mk("span").attr("class","typcn typcn-arrow-move move blue")),E=function(t){var e=y.clone(),a=A.clone(!0,!0),i=C.clone(),n=T.clone(!0,!0),r=$.mk("div").attr("class","clr");return"object"==typeof t&&(t.colorid&&r.data("id",t.colorid),t.hex&&a.val(t.hex),t.label&&i.val(t.label)),r.append(e,a,i,n),a.trigger("change"),r},R=$.mk("button").attr("class","typcn typcn-plus green").text("Add new color").on("click",function(t){t.preventDefault();var e=$(this).parents("#cg-editor"),a=e.children(".clrs");a.length||e.append(a=$.mk("div").attr("class","clrs"));var i=E();a.append(i),i.find(".clri").focus(),$.Dialog.center()});w.append($.mk("label").append($.mk("span").text("Group name (2-30 chars.)"),mk("br"),$.mk("input").attr({type:"text",name:"label",pattern:PRINTABLE_ASCII_REGEX.replace("+","{2,30}"),required:!0})),$.mk("label").append($.mk("input").attr({type:"checkbox",name:"major"}).on("click",function(){$(this).parent().next()[this.checked?"show":"hide"]().children("input").attr("disabled",!this.checked),$.Dialog.center()}),$.mk("span").text("This is a major change")),$.mk("label").append($.mk("span").text("Change reason (1-255 chars.)"),mk("br"),$.mk("input").attr({type:"text",name:"reason",pattern:PRINTABLE_ASCII_REGEX.replace("+","{1,255}"),required:!0,disabled:!0})).hide(),$.mk("p").attr("class","align-center").text("The # symbol is optional, rows with invalid "+l+"s will be ignored. Each color must have a short (3-30 chars.) description of its intended use."),R,$.mk("div").attr("class","clrs"),$.mk("div").attr("class","notice").hide().html("<p></p>")).on("render-color-inputs",function(t,e){var a=$(this),i=a.children(".clrs").empty();$.each(e,function(t,e){i.append(E(e))}),new Sortable(i.get(0),{handle:".move",ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.center()}),window.ctxmenus=function(){i()};var q;f.on("page-switch",n),n()});
//# sourceMappingURL=colorguide-manage.min.js.map
