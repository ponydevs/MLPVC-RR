$(function(){function t(t){t.children().sort(function(t,e){var a=/^.*typ-([a-z]+).*$/;return t=[t.className.replace(a,"$1"),t.innerHTML.trim()],e=[e.className.replace(a,"$1"),e.innerHTML.trim()],t[0]===e[0]?t[1].localeCompare(e[1]):t[0].localeCompare(e[0])}).appendTo(t)}function e(t,e){var a="Create new tag",n=t.closest("li"),r=t.closest("div:not([class])"),o=r.children(".tags"),l=n.attr("id").replace(/\D/g,""),s=r.children("strong").text().trim();$.Dialog.request(a,f.clone(!0,!0),"edit-tag","Create",function(t){var a=t.children(".notice").children("p"),n=function(){a.html(this.message).parent().removeClass("info").addClass("fail").show(),t.find("input, texarea").attr("disabled",!1),$.Dialog.center()};t.append($.mk("label").append($.mk("input").attr({type:"checkbox",name:"addto"}).val(l).prop("checked","string"==typeof e),document.createTextNode(' Add this tag to the appearance "'+s+'" after creation'))),"string"==typeof e&&t.find("input[name=name]").val(e),$.Dialog.center(),t.on("submit",function(e){e.preventDefault();var r=t.serializeArray(),l={};$.each(r,function(t,e){l[e.name]=e.value}),a.text("Creating tag...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/maketag",l,$.mkAjaxHandler(function(){this.status?(this.tags&&(o.children("[data-hasqtip]").qtip("destroy",!0),o.html(this.tags),window.tooltips(),i()),$.Dialog.close()):n.call(this)}))})})}function a(t,e){var a=this;if("undefined"!=typeof e){console.log(e);var n=e.attr("id").substring(2),r=e.parents("li").attr("id").substring(1);console.log(n,r)}$.Dialog.request(t,k.clone(!0,!0),"cg-editor","Save",function(t){var o=t.children(".notice").children("p"),l=function(){o.html(this.message).parent().removeClass("info").addClass("fail").show(),t.find("input, texarea").attr("disabled",!1),$.Dialog.center()},s=t.find("input[name=label]"),c="object"==typeof a&&a.label&&a.Colors;c&&(s.val(a.label),t.trigger("render-color-inputs",[a.Colors])),t.on("submit",function(a){a.preventDefault();var p={label:s.val(),Colors:[]};if(c||(p.ponyid=r),t.find(".clr").each(function(){var t=$(this),e=t.children(".clri");if(d.test(e.val())){var a=t.data("id"),i={hex:e.val().replace(d,"#$1").toUpperCase()};"undefined"!=typeof a&&(i.colorid=parseInt(a,10)),i.label=t.children(".clrl").val(),p.Colors.push(i)}}),0===p.Colors.length)throw new Error("You need to add at least 1 color");p.Colors=JSON.stringify(p.Colors),o.text("Saving changes...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/"+(c?"set":"make")+"cg/"+n,p,$.mkAjaxHandler(function(){this.status?((this.cg||this.cgs)&&(this.cg?(e.children("[data-hasqtip]").qtip("destroy",!0),e.html(this.cg)):this.cgs&&e.parent().html(this.cgs),window.tooltips(),i()),$.Dialog.close()):l.call(this)}))})})}function i(){x.children("span:not(.ctxmenu-bound)").ctxmenu([{text:"Edit tag",icon:"pencil",click:function(){var e=$(this),a=e.text().trim(),i=e.attr("class").match(/id-(\d+)(?:\s|$)/)[1],n="Editing tag: "+a;$.Dialog.wait(n,"Retrieveing tag details from server"),$.post("/colorguide/gettag/"+i,$.mkAjaxHandler(function(){var e=this;this.status?$.Dialog.request(n,f.clone(!0,!0),"edit-tag","Save",function(a){var n=a.children(".notice").children("p"),r=function(){n.html(this.message).parent().removeClass("info").addClass("fail").show(),a.find("input, texarea").attr("disabled",!1),$.Dialog.center()};a.find("input[name=type][value="+e.type+"]").prop("checked",!0),a.find("input[type=text][name], textarea[name]").each(function(){var t=$(this);t.val(e[t.attr("name")])}),a.on("submit",function(e){e.preventDefault();var a=$(this).serializeArray(),o={};$.each(a,function(t,e){o[e.name]=e.value}),n.text("Saving changes...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/settag/"+i,o,$.mkAjaxHandler(function(){if(this.status){var e=$(".id-"+this.tid);e.qtip("destroy",!0),this.title?e.attr("title",this.title):e.removeAttr("title"),e.attr("class","tag id-"+this.tid+(this.type?" typ-"+this.type:"")).text(this.name).data("ctxmenu-items").eq(0).text("Tag: "+this.name),e.parent().each(function(){t($(this))}),window.tooltips(),$.Dialog.close()}else r.call(this)}))})}):$.Dialog.fail(n,this.message)}))}},{text:"Remove tag",icon:"minus",click:function(){var t=$(this),e=t.attr("class").match(/id-(\d+)(?:\s|$)/);if(!e)return!1;e=e[1];var a=t.closest("li").attr("id").replace(/\D/g,""),i=t.text().trim(),n="Remove tag: "+i;$.Dialog.confirm(n,"The tag "+i+" will be removed from this appearance.<br>Are you sure?",["Remove it","Nope"],function(i){i&&($.Dialog.wait(n,"Removing tag"),$.post("/colorguide/untag/"+a,{tag:e},$.mkAjaxHandler(function(){this.status?(t.qtip("destroy",!0),t.remove(),$.Dialog.close()):$.Dialog.fail(n,this.message)})))})}},{text:"Delete tag",icon:"trash",click:function(){var t=$(this),e=t.text().trim(),a=t.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Detele tag: "+e;$.Dialog.confirm(i,"Deleting this tag will also remove it from every appearance where it's been used.<br>Are you sure?",["Delete it","Nope"],function(t){t&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/deltag/"+a,$.mkAjaxHandler(function(){if(this.status){var t=$(".id-"+a);t.qtip("destroy",!0),t.remove(),$.Dialog.close()}else $.Dialog.fail(i,this.message)})))})}},!0,{text:"Create new tag",icon:"plus",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(t){return"Tag: "+t.text().trim()});var l=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"/colorguide/gettags?s=%QUERY",wildcard:"%QUERY"}}),s=[13,188];x.children(".addtag").each(function(){var t=$(this),a=t.parents("li").attr("id").substring(1);t.typeahead(null,{name:"tags",display:"name",source:l,templates:{suggestion:Handlebars.compile('<span class="tag id-{{tid}} typ-{{type}}">{{name}}</span>')}}),t.on("keydown",function(n){if(-1!==s.indexOf(n.keyCode)){n.preventDefault();var r=t.val().trim(),o=t.parents(".tags"),l=o.children(".tag"),c="Adding tag: "+r;if(l.filter(function(){return this.innerHTML.trim()===r}).length>0)return $.Dialog.fail(c,"This appearance already has this tag");$.Dialog._focusedElement=t.attr("disabled",!0),t.parent().addClass("loading"),$.post("/colorguide/tag/"+a,{tag_name:r},$.mkAjaxHandler(function(){if(this.status)o.children("[data-hasqtip]").qtip("destroy",!0),o.html(this.tags),window.tooltips(),i(),$("#p"+a).find(".addtag").focus();else if("string"==typeof this.cancreate){var n=this.cancreate;c=c.replace(r,n),$.Dialog.confirm(c,this.message,function(a){a&&e(t,n)})}else $.Dialog.fail(c,this.message);t.removeAttr("disabled").parent().removeClass("loading")}))}}),t.nextAll(".tt-menu").on("click",".tag",function(){t.trigger({type:"keydown",keyCode:13})})}),n=$("ul.colors:not(.static)"),n.attr("data-color",o).ctxmenu([{text:"Create new group",icon:"folder-add",click:function(){a("Create color group")}}],r+" groups").children("li").filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Edit "+o+" group",icon:"pencil",click:function(){var t=$(this),e=t.closest("li"),i=e.attr("id").substring(2),n=t.children().first().text().replace(/:\s?$/,""),r="Editing "+o+" group: "+n;$.Dialog.wait(r,"Retrieving "+o+" group details from server"),$.post("/colorguide/getcg/"+i,$.mkAjaxHandler(function(){try{if(!this.status)throw new Error(this.message);a.call(this,r,e.attr("id","cg"+i))}catch(t){handleError.call(t.message)}}))}},{text:"Delete "+o+" group",icon:"trash",click:function(){var t=$(this).closest("li"),e=t.attr("id").substring(2),a=t.children().first().text().replace(/:\s?$/,""),i="Delete "+o+" group: "+a;$.Dialog.confirm(i,"By deleting this "+o+" group, all "+o+"s within will be removed too.<br>Are you sure?",function(a){a&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/delcg/"+e,$.mkAjaxHandler(function(){this.status?(t.children("[data-hasqtip]").qtip("destroy",!0),t.remove(),$.Dialog.close()):$.Dialog.fail(i,this.message)})))})}},!0,{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(t){return r+" group: "+t.children().first().text().trim().replace(":","")}),$.ctxmenu.addItems($("ul.colors").children("li").children("span:not(:first-child)").off("click").on("click",function(t){t.preventDefault(),$.copy(this.innerHTML.trim())}).filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Copy HEX "+o+" code",icon:"clipboard","default":!0,click:function(){$.copy(this.innerHTML.trim())}}],function(t){return"Color: "+t.attr("oldtitle")}).filter(function(){return-1===this.parentNode.parentNode.className.indexOf("static")}),!0,{text:"Edit "+o+" group",icon:"pencil",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Delete "+o+" group",icon:"trash",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}},!0,{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),3)}})}var n,r=window.Color,o=window.color,l=window.TAG_TYPES_ASSOC,s=window.MAX_SIZE,c=window.PRINTABLE_ASCII_REGEX,d=window.HEX_COLOR_PATTERN,p="WebkitAppearance"in document.documentElement.style,u=$.mk("form").attr("id","sprite-img").html("<p class=align-center><a href=#upload>Click here to upload a file</a> (max. "+s+") or enter a URL below.</p><label><input type=text name=image_url placeholder=\"External image URL\" required></label><p class=align-center>The URL will be checked against the supported provider list, and if an image is found, it'll be downloaded to the server and set as this appearance's sprite image.</p>");$(".upload-wrap").each(function(){var t=$(this),e=t.closest("li").attr("id").substring(1);t.uploadZone({requestKey:"sprite",title:"Upload sprite",accept:"image/png",target:"/colorguide/setsprite/"+e}).on("uz-uploadstart",function(){$.Dialog.close()}).ctxmenu([{text:"Open image in new tab",icon:"arrow-forward","default":!0,attr:{href:t.find("img").attr("src"),target:"_blank"}},{text:"Copy image URL",icon:"clipboard",click:function(){$.copy($.urlToAbsolute(t.find("img").attr("src")))}},{text:"Upload new sprite",icon:"upload",click:function(){var e="Upload sprite image",a=t.closest("li").attr("id").substring(1),i=t.find('input[type="file"]');$.Dialog.request(e,u.clone(),"sprite-img","Download image",function(t){var n=t.find("input[name=image_url]");t.find("a").on("click",function(t){t.preventDefault(),t.stopPropagation(),i.trigger("click",[!0])}),t.on("submit",function(t){t.preventDefault();var r=n.val();$.Dialog.wait(e,"Downloading external image to the server"),$.post("/colorguide/setsprite/"+a,{image_url:r},$.mkAjaxHandler(function(){this.status?i.trigger("set-image",[this.path]):$.Dialog.fail(e,this.message)}))})})}}],"Sprite image").attr("title",p?" ":"").on("click",function(e,a){return a===!0?!0:(e.preventDefault(),void t.data("ctxmenu-items").eq(1).children().get(0).click())})});var g=$("#list"),m=!0,h=!1;g.children().on("edit-mode",function(t,e){var a=$(this),i=a.attr("id").substring(1);if(e===h);else if(e===m){var n="Editing appearance #"+i;$.post("/get/"+i,$.mkAjaxHandler(function(){this.status||$.Dialog.fail(n,this.message)}))}else console.warn("Invalid edit-mode action",e)}),g.find("button.edit").on("click",function(){$this.parents("li").trigger("edit-mode",[m])}).next().on("click",function(){var t=$(this),e=t.closest("li"),a=e.attr("id").substring(1),i=t.parent().text().trim(),n="Deleting appearance: "+i;$.Dialog.confirm(n,"Deleting this appearance will remove <strong>ALL</strong> of its color groups, the colors within them, and the sprite file, if any.<br>Delete anyway?",function(t){t&&($.Dialog.wait(n,"Sending removal request"),$.post("/colorguide/delete/"+a,$.mkAjaxHandler(function(){this.status?(e.remove(),$.Dialog.close()):$.Dialog.fail(n,this.message)})))})});var f=$.mk("form").attr("id","edit-tag");f.append("<label><span>Tag name (4-30 chars.)</span><input type=text name=name required pattern=^.{4,30}$ maxlength=30></label>");var v=$.mk("div").addClass("type-selector");$.each(l,function(t,e){var a=$.mk("label"),i=$.mk("input").attr({type:"checkbox",name:"type",value:t}).on("click keyup",function(){this.checked&&$(this).parent().siblings().find("input").prop("checked",!1)});a.append(i,$.mk("span").addClass("tag typ-"+t).text(e)).appendTo(v)}),f.append($.mk("div").addClass("align-center").append("<span>Tag type (optional)</span><br>",v)).append($.mk("label").append("<span>Tag description (max 255 chars., optional)</span><br><textarea name=title maxlength=255></textarea>")).append($.mk("div").attr("class","notice").hide().html("<p></p>"));var x=$(".tags").ctxmenu([{text:"Create new tag",icon:"plus",click:function(){e($(this))}}],"Tags"),k=$.mk("form").attr("id","cg-editor"),y=$.mk("span").attr("class","clrp"),b=$.mk("input").attr({"class":"clri",pattern:d.toString().replace(/\//g,""),autocomplete:"off",spellcheck:"false"}).on("keyup change input",function(){var t=$(this),e=t.prev(),a=d.test(this.value);a?e.removeClass("invalid").css("background-color",this.value.replace(d,"#$1")):e.addClass("invalid"),t.next().attr("required",a)}).on("paste blur",function(t){var e=this,a=$(e),i=/^#?([A-Fa-f0-9]{3})$/,n=function(){var n=e.value;if(i.test(n)){var r=n.match(i)[1];n="#"+r[0]+r[0]+r[1]+r[1]+r[2]+r[2]}d.test(n)&&(a.val(n.replace(d,"#$1").toUpperCase()).trigger("change"),"blur"!==t.type&&a.next().focus())};"paste"===t.type?setTimeout(n,10):n()}),w=$.mk("input").attr({"class":"clrl",pattern:c.replace("+","{3,30}")}),D=$.mk("div").attr("class","clra").append($.mk("span").attr("class","typcn typcn-minus remove red").on("click",function(){$(this).closest(".clr").remove(),$.Dialog.center()})).append($.mk("span").attr("class","typcn typcn-arrow-move move blue")),C=function(t){var e=y.clone(),a=b.clone(!0,!0),i=w.clone(),n=D.clone(!0,!0),r=$.mk("div").attr("class","clr");return"object"==typeof t&&(t.colorid&&r.data("id",t.colorid),t.hex&&a.val(t.hex),t.label&&i.val(t.label)),r.append(e,a,i,n),a.trigger("change"),r.draggabilly({axis:"y",containment:!0,handle:".move"}),r.on("dragStart dragMove dragEnd",function(t){var e,a=$(this),i=a.parent(),n=i.children(),r=$(this).data("draggabilly");switch(t.type){case"dragStart":a.addClass("moving");break;case"dragMove":var o=a.index(),l=r.position.y,s=l>0,c=Math.abs(l);e=Math.round((14>c?0:c-14)/28),e=o+e*(s?1:-1),a.data("moveto",[e,s]);break;case"dragEnd":a.removeClass("moving"),n.removeAttr("style");var d=a.data("moveto");a[d[1]?"insertAfter":"insertBefore"](n.eq(d[0]))}}),r},A=$.mk("button").attr("class","typcn typcn-plus green").text("Add new color").on("click",function(t){t.preventDefault();var e=$(this).parents("#cg-editor"),a=e.children(".clrs");a.length||e.append(a=$.mk("div").attr("class","clrs"));var i=C();a.append(i),i.find(".clri").focus(),$.Dialog.center()});k.append('<label><span>Group name (2-30 chars.)</span><br><input name=label pattern="'+c.replace("+","{2,30}")+'" required></label>').append("<p class=align-center>The # symbol is optional, rows with invalid "+o+"s will be ignored. Each color must have a short (3-30 chars.) description of its intended use.</p>",A).append($.mk("div").attr("class","clrs")).append($.mk("div").attr("class","notice").hide().html("<p></p>")),k.on("render-color-inputs",function(t,e){var a=$(this),i=a.children(".clrs").empty();$.each(e,function(t,e){i.append(C(e))}),$.Dialog.center()}),i(),window.ctxmenus=function(){i()}});
//# sourceMappingURL=colorguide-manage.min.js.map