$(function(){function e(n,a,s){n.children("button.reserve-request").off("click").on("click",function(){var t=$(this),i="Reserving request";$.Dialog.wait(i,"Sending reservation to the server"),$.post("/reserving/request/"+a,$.mkAjaxHandler(function(){this.status?($.Dialog.close(),t.nextAll().remove(),$(this.btnhtml).insertAfter(t),e(n,a,s),t.remove()):$.Dialog.fail(i,this.message)}))}),n.children("button.delete").on("click",function(){var e=$(this),t="Deleteing request";$.Dialog.confirm(t,"You are about to permanently delete this request.<br>Are you sure about this?",function(i){i&&$.post("/reserving/request/"+a+"?delete",$.mkAjaxHandler(function(){this.status?($.Dialog.close(),e.closest("li").remove()):$.Dialog.fail(t,this.message)}))})});var l=n.find(".reserver-actions").children();l.filter(".cancel").off("click").on("click",function(){var t=$(this),i="Cancel reservation";$.Dialog.confirm(i,"Are you sure you want to cancel this reservation?",function(o){o&&($.Dialog.wait(i,"Cancelling reservation"),$.post("/reserving/"+s+"/"+a+"?cancel",$.mkAjaxHandler(function(){if(this.status){if($.Dialog.close(),this.remove===!0)return n.remove();t.parent().prev().nextAll().addBack().remove(),$(this.btnhtml).appendTo(n),e(n,a,s)}else $.Dialog.fail(i,this.message)})))})}),l.filter(".finish").off("click").on("click",function(){var e="Finish reservation";$.Dialog.request(e,'<form id="finish-res"><div class="notice fail"><label>Error</label><p></p></div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"finish-res","Finish",function(){var n=$("#finish-res"),l=n.find(".notice p");l.parent().hide(),n.on("submit",function(c){c.preventDefault();var d=n.find("[name=deviation]").val(),u=function(e){l.html(e.message).parent().show(),i.trigger("resize"),n.find("input").attr("disabled",!1)};try{if("string"!=typeof d||0===d.length)throw new Error("Please enter a deviation URL");$.post("/reserving/"+s+"/"+a+"?finish",{deviation:d},$.mkAjaxHandler(function(){var i=this;i.status?t.call({callback:function(){"string"==typeof i.message?$.Dialog.success(e,i.message,!0):$.Dialog.close()}},s,o,r):u(i)}))}catch(c){u(c)}})})}),l.filter(".unfinish").off("click").on("click",function(){var e=$(this),n=e.hasClass("delete-only"),l=(n?"Delete":"Un-finish")+" reservation",c=s.charAt(0).toUpperCase()+s.substring(1);$.Dialog.request(l,'<form id="unbind-check"><p>Are you sure you want to '+(n?"delete this reservation":"mark this reservation as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind reservation from user</label></form>',"unbind-check","Un-finish",function(){var e=$("#unbind-check"),d=e.find("[name=unbind]");n||e.prepend('<div class="notice info">By removing the "finished" flag, the deviation will be moved back to the "List of '+c+'" section</div>'),"reservations"===s?(d.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),n&&d.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(n?"reservation was added directly, it cannot be marked un-finished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),i.trigger("resize"),e.on("submit",function(e){e.preventDefault();var i=d.prop("checked");$.Dialog.wait(l,'Removing "finished" flag'+(i?" & unbinding from user":"")),$.post("/reserving/"+s+"/"+a+"?unfinish"+(i?"&unbind":""),$.mkAjaxHandler(function(){this.status?($.Dialog.success(l,"undefined"!=typeof this.message?this.message:'"finished" flag removed successfully'),t(s,o,r)):$.Dialog.fail(l,this.message)}))})})})}function t(e,t,i){var n=e.charAt(0).toUpperCase()+e.substring(1),a=this;$.Dialog.wait(n,"Updating list"),$.post("/episode/"+e.replace(/([^s])$/,"$1s")+"/S"+t+"E"+i,$.mkAjaxHandler(function(){if(this.status){var t=$("#"+e.replace(/([^s])$/,"$1s")),i=$(this.render).filter("section").children();t.empty().append(i).rebindHandlers(),t.find(".post-form").data("type",e).formBind(),window.updateTimesF(),"object"==typeof a&&"function"==typeof a.callback?a.callback():$.Dialog.close()}else window.location.reload()}))}var i=$(window),n=$(document.body),a=$("header nav"),s=$("#content"),o=window.SEASON,r=window.EPISODE,l="S"+o+"E"+r;$("#video").on("click",function(){$.post("/episode/getvideos/"+l,$.mkAjaxHandler(function(){var e="Video links";$.Dialog.request(e,'<form id=vidlinks><input type="text" name="yt" placeholder="YouTube"><input type="text" name="dm" placeholder="Dailymotion"></form>',"vidlinks","Save",function(){var t=$("#vidlinks"),i=t.find("[name=yt]"),n=t.find("[name=dm]");this.yt&&i.val(this.yt),this.dm&&n.val(this.dm),t.on("submit",function(t){t.preventDefault(),$.Dialog.wait(e,"Saving links"),$.post("/episode/setvideos/"+l,{yt:i.val(),dm:n.val()},$.mkAjaxHandler(function(){if(this.status){var t=s.children("section.episode");this.epsection?(t.length||(t=$.mk("section").addClass("episode").insertBefore(s.children("section").first())),t.html($(this.epsection).filter("section").html())):t.length&&t.remove(),$.Dialog.close()}else $.Dialog.fail(e,this.message)}))})})}))});var c=$("#voting"),d=c.find("button");c.on("click","button",function(e){e.preventDefault();var t=$(this),i=t.siblings("button").addBack(),n=t.hasClass("green")?1:-1,a=""+l,s=(n>0?"Up":"Down")+"voting "+a;i.attr("disabled",!0),$.post("/episode/vote/"+a,{vote:n},$.mkAjaxHandler(function(){if(this.status){$.Dialog.close();var e=t.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml)}else $.Dialog.fail(s,this.message),i.attr("disabled",!1)}))}),c.find("time").data("dyntime-beforeupdate",function(e){return e.past===!0?d.length?void 0:($.post("/episode/vote/"+l+"?html",$.mkAjaxHandler(function(){this.status?(c.children("h2").nextAll().remove(),c.append(this.html)):$.Dialog.fail("Display voting buttons",this.message)})),$(this).removeData("dyntime-beforeupdate"),!1):void 0}),$.fn.rebindHandlers=function(){var t=$(this);return t.find("li[id]").each(function(){var t=$(this),i=parseInt(t.attr("id").replace(/\D/g,"")),a=t.closest("section[id]").attr("id");$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){n.addClass("no-distractions")}).on("closestart",function(){n.removeClass("no-distractions")}),e(t,i,a)}),t},$("#requests, #reservations").rebindHandlers(),$.fn.formBind=function(){function e(e){var t=f.data("prev-url"),i="string"==typeof t&&t.trim()===f.val().trim();if(c.attr("disabled",e===!0||i),e===!0||i?c.attr("title","You need to change the URL before chacking again."):c.removeAttr("title"),"keyup"===e.type){var n=f.val();y.test(n)&&f.val(f.val().replace(y,""))}}var s=$(this),c=s.find(".check-img"),d=s.find(".img-preview"),u=s.find("[name=label]"),f=s.find("[name=image_url]"),h=s.find("[name=label]"),v=d.children(".notice"),p=v.html(),m=d.children("img"),g=s.data("type"),b=g.charAt(0).toUpperCase()+g.substring(1);0===m.length&&(m=$(new Image).appendTo(d)),$("#"+g+"-btn").on("click",function(){s.is(":visible")||(s.show(),u.focus(),n.animate({scrollTop:s.offset().top-a.outerHeight()-10},500))}),"reservation"===g&&$("#add-reservation-btn").on("click",function(){var e="Add a reservation";$.Dialog.request(e,'<form id="add-reservation"><div class="notice fail"><label>Error</label><p></p></div><div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div><div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"add-reservation","Finish",function(){var n=$("#add-reservation"),a=n.find(".notice.fail").hide().children("p");n.on("submit",function(s){s.preventDefault();var c=n.find("[name=deviation]").val(),d=function(e){a.html(e.message).parent().show(),i.trigger("resize"),n.find("input").attr("disabled",!1)};try{if("string"!=typeof c||0===c.length)throw new Error("Please enter a deviation URL");$.post("/reserving/reservation?add="+l,{deviation:c},$.mkAjaxHandler(function(){this.status?($.Dialog.success(e,this.message),t(g,o,r)):d(this)}))}catch(s){d(s)}})})}),f.on("keyup change paste",e);var y=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,k='<strong class="typcn typcn-arrow-repeat" style=display:inline-block>Check image</strong>';c.on("click",function(t){t.preventDefault(),c.removeClass("red"),e(!0);var i=f.val();$.Dialog.wait(b+" process","Checking image"),$.post("/post",{image_url:i},$.mkAjaxHandler(function(){this.status?m.attr("src",this.preview).show().on("load",function(){v.hide(),f.data("prev-url",i),this.title&&!h.val().trim()&&$.Dialog.confirm("Confirm "+g+" title","The image you just checked had the following title:<br><br><p class=align-center><strong>"+this.title+"</strong></p><br>Would you like to use this as the "+g+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===g?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+g+" a description before clicking the "+k+" button.</p>",function(e){return e?(h.val(this.title),void $.Dialog.close()):s.find("input[name=label]").focus()})}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image. Make sure the URL is correct and try again!")}):(v.html(this.message).show(),m.hide())}))}),s.on("submit",function(e,i,n){if(e.preventDefault(),!i&&f.data("prev-url")!==f.val())return $.Dialog.confirm(title,"You modified the image URL without clicking the "+k+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&s.triggerHandler("submit",[!0])});if("undefined"==typeof f.data("prev-url"))return $.Dialog.fail(b,"Please click the "+k+" button before submitting your "+g+"!");if(!n&&"request"===g){var a=u.val(),l=s.find("select");if(a.indexOf("character")>-1&&"chr"!==l.val())return $.Dialog.confirm(b,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){l.focus()}):s.triggerHandler("submit",[i,!0])})}var c=s.mkData({what:g,episode:r,season:o,image_url:f.data("prev-url")});$.Dialog.wait(b,"Submitting "+g),$.post("/post",c,$.mkAjaxHandler(function(){this.status?($.Dialog.success(b+" posted successfully"),t(g,o,r)):$.Dialog.fail(b,this.message)}))}).on("reset",function(){c.attr("disabled",!1).addClass("red"),v.html(p).show(),m.hide(),f.removeData("prev-url"),$(this).hide()})},$(".post-form").each($.fn.formBind)});
//# sourceMappingURL=index.min.js.map