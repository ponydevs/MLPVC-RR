$(function(){function e(r,i,o){r.find("button.reserve-request").off("click").on("click",function(){var n=$(this),a="Reserving request";$.Dialog.wait(a,"Sending reservation to the server"),$.ajax({method:"POST",url:"/reserving/request/"+i,success:function(s){return"object"!=typeof s?console.log(s)&&t.trigger("ajaxerror"):void(s.status?($.Dialog.close(),$(s.btnhtml).insertAfter(n),e(r,i,o),n.remove()):$.Dialog.fail(a,s.message))}})}),r.find(".reserver-actions .typcn-times").off("click").on("click",function(){var n=$(this),a="Cancel reservation";$.Dialog.confirm(a,"Are you sure you want to cancel this reservation?",function(s){s&&($.Dialog.wait(a,"Cancelling reservation"),$.ajax({method:"POST",url:"/reserving/"+o+"/"+i+"?cancel",success:function(s){if("object"!=typeof s)return console.log(s)&&t.trigger("ajaxerror");if(s.status){if($.Dialog.close(),s.remove===!0)return n.closest("li").remove();$(s.btnhtml).insertBefore(n.parent().prev()),n.parent().prev().remove(),n.parent().remove(),e(r,i,o)}else $.Dialog.fail(a,s.message)}}))})})}var t=$(window),r=$(document.body),i=$("header nav"),o=window.SEASON,n=window.EPISODE;$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){r.addClass("no-distractions")}).on("closestart",function(){r.removeClass("no-distractions")}),$.fn.rebindHandlers=function(){var t=$(this);return t.find("li[id]").each(function(){var t=$(this),r=parseInt(t.attr("id").replace(/\D/g,"")),i=t.closest("section[id]").attr("id");e(t,r,i)}),t},$("#requests, #reservations").rebindHandlers(),$(".post-form").each(function(){!function e(a){function s(e){var t=u.data("prev-url"),r="string"==typeof t&&t.trim()===u.val().trim();l.attr("disabled",e===!0||r),e===!0||r?l.attr("title","You need to change the URL before chacking again."):l.removeAttr("title")}var l=a.find(".check-img"),c=a.find(".img-preview"),u=a.find("[name=image_url]"),d=a.find("[name=label]"),f=c.children(".notice"),g=f.html(),m=c.children("img"),h=a.data("type"),v=h.charAt(0).toUpperCase()+h.substring(1);0===m.length&&(m=$(new Image).appendTo(c)),$("#"+h+"-btn").on("click",function(){a.is(":visible")||(a.show(),u.focus(),r.animate({scrollTop:a.offset().top-i.outerHeight()-10},500))}),u.on("keyup change paste",s),l.on("click",function(e){e.preventDefault(),l.removeClass("red"),s(!0);var r=u.val();$.ajax({method:"POST",url:"/post",data:{image_url:r},success:function(e){return"object"!=typeof e?console.log(e)&&t.trigger("ajaxerror"):void(e.status?m.attr("src",e.preview).show().on("load",function(){f.hide(),u.data("prev-url",r),e.title&&!d.val().trim()&&d.val(e.title)}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image.<br>Make sure the URL is correct and try again!")}):(f.html(e.message).show(),m.hide()))}})});var p='<strong class="typcn typcn-arrow-repeat">Check image</strong>';a.on("submit",function(r,i){if(r.preventDefault(),!i&&u.data("prev-url")!==u.val())return $.Dialog.confirm("You modified the image URL without clicking the "+p+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&a.trigger("submit",[!0])});if("undefined"==typeof u.data("prev-url"))return $.Dialog.fail(v,"Please click the "+p+" button before submitting your "+h+"!");$.Dialog.wait(v,"Submitting "+h);var s=a.serializeArray(),l={what:h,episode:n,season:o};s.image_url=u.data("prev-url"),$.each(s,function(e,t){l[t.name]=t.value}),$.post("/post",l,function(r){return"object"!=typeof r?console.log(r)&&t.trigger("ajaxerror"):void(r.status?($.Dialog.wait(v,"Updating list"),$.post("/episode/"+h+"s/S"+o+"E"+n,{},function(r){if("object"!=typeof r)return console.log(r)&&t.trigger("ajaxerror");if(r.status){var i=$(r.render);console.log(i),e($("#"+h+"s").html(i.filter("section").html()).rebindHandlers().find(".post-form")),$.Dialog.close()}else window.location.reload()})):$.Dialog.fail(v,r.message))})}).on("reset",function(){l.attr("disabled",!1).addClass("red"),f.html(g).show(),m.hide(),u.removeData("prev-url"),$(this).hide()})}($(this))})});