DocReady.push(function(){"use strict";function e(i,s,r){i.children("button.reserve-request").off("click").on("click",function(){$.Dialog.wait("Reserving request","Sending reservation to the server"),$.post("/reserving/request/"+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=$(this.li);i.replaceWith(t),window.updateTimes(),e(t,s,r),$.Dialog.close()}))}),i.children("em").children("a").last().on("click",function(e){e.preventDefault(),n(this.hash),history.replaceState({},"",this.href)});var l=i.find(".actions").children();l.filter(".cancel").off("click").on("click",function(){$.Dialog.confirm("Cancel reservation","Are you sure you want to cancel this reservation?",function(t){t&&($.Dialog.wait(!1,"Cancelling reservation"),$.post("/reserving/"+r+"/"+s+"?cancel",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.remove===!0)return $.Dialog.close(),i.remove();var t=$(this.li);i.replaceWith(t),window.updateTimes(),e(t,s,r),$.Dialog.close()})))})}),l.filter(".finish").off("click").on("click",function(){$.Dialog.request("Finish reservation",'<form id="finish-res"><input type="text" name="deviation" placeholder="Deviation URL"></form>',"finish-res","Finish",function(e){e.on("submit",function(i){i.preventDefault();var n=e.find("[name=deviation]").val();if("string"!=typeof n||0===n.length)return $.Dialog.fail(!1,"Please enter a deviation URL");$.Dialog.wait(!1,"Marking reservation as finished");var l="/reserving/"+r+"/"+s+"?finish";$.post(l,{deviation:n},$.mkAjaxHandler(function(){var e=this,i=function(){$.Dialog.success(!1,"Reservation has been marked as finished"),t(r,a,o,function(){"string"==typeof e.message?$.Dialog.success(!1,e.message,!0):$.Dialog.close()})};e.status?i():e.retry?$.Dialog.confirm(!1,e.message,["Continue","Cancel"],function(t){t&&$.post(l,{deviation:n,allow_overwrite_reserver:!0},$.mkAjaxHandler(function(){return this.status?(e=this,void i()):$.Dialog.fail(!1,this.message)}))}):$.Dialog.fail(!1,e.message)}))})})}),l.filter(".unfinish").off("click").on("click",function(){var e=$(this),i=e.hasClass("delete-only"),n=r.charAt(0).toUpperCase()+r.substring(1),l=r.replace(/s$/,"");$.Dialog.request((i?"Delete":"Un-finish")+" "+l,'<form id="unbind-check"><p>Are you sure you want to '+(i?"delete this reservation":"mark this "+l+" as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind '+l+" from user</label></form>","unbind-check","Un-finish",function(){var e=$("#unbind-check"),l=e.find("[name=unbind]");i||e.prepend('<div class="notice info">By removing the "finished" flag, the post will be moved back to the "List of '+n+'" section</div>'),"reservations"===r?(l.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),i&&l.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(i?"reservation was added directly, it cannot be marked un-finished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),$w.trigger("resize"),e.on("submit",function(e){e.preventDefault();var i=l.prop("checked");$.Dialog.wait(!1,'Removing "finished" flag'+(i?" & unbinding from user":"")),$.post("/reserving/"+r+"/"+s+"?unfinish"+(i?"&unbind":""),$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,"undefined"!=typeof this.message?this.message:'"finished" flag removed successfully'),void t(r,a,o)):$.Dialog.fail(!1,this.message)}))})})}),l.filter(".check").off("click").on("click",function(e){e.preventDefault();var t=$(this);$.Dialog.wait("Deviation acceptance status","Checking"),$.post("/reserving/"+r+"/"+s+"?lock",$.mkAjaxHandler(function(){return this.status?(t.closest("li").children(".image").children("a").append($.mk("span").attr({"class":"typcn typcn-tick",title:"This submission has been accepted into the group gallery"})),t.parent().remove(),void(this.message?$.Dialog.success(!1,this.message,!0):$.Dialog.close())):$.Dialog.fail(!1,this.message)}))}),l.filter(".delete").on("click",function(){var e=$(this);$.Dialog.confirm("Deleteing request","You are about to permanently delete this request.<br>Are you sure about this?",function(t){t&&($.Dialog.wait(!1,"Sending deletion request"),$.post("/reserving/request/"+s+"?delete",$.mkAjaxHandler(function(){return this.status?($.Dialog.close(),void e.closest("li").fadeOut(1e3,function(){$(this).remove()})):$.Dialog.fail(!1,this.message)})))})}),l.filter(".edit").on("click",function(){var e=$(this),i=e.parents("li"),n=i.attr("id").split("-"),s=n[1],r=n[0];$.Dialog.wait("Editing "+r+" #"+s,"Retrieving "+r+" details"),$.post("/post/get-"+r+"/"+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this,n=$.mk("form").attr("id","post-edit-form").append($.mk("label").append($.mk("span").text("Description (3-255 chars."+("reservation"===r?", optional":"")+")"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{3,255}$",name:"label",required:"reservation"!==r})));"request"===r&&n.append($.mk("label").append($.mk("span").text("Request type"),$.mk("select").attr({name:"type",required:!0}).append($.mk("option").attr("value","chr").text("Character"),$.mk("option").attr("value","obj").text("Object"),$.mk("option").attr("value","bg").text("Backgound")))),"string"==typeof e.posted&&n.append($.mk("label").append($.mk("span").text("Post timestamp"),$.mk("input").attr({type:"datetime",name:"date",required:!0,spellcheck:!1}))),n.append($.mk("label").append($.mk("a").text("Update Image").attr({href:"#update","class":"btn darkblue typcn typcn-pencil"}).on("click",function(e){e.preventDefault(),$.Dialog.close();var n=i.children(".image").find("img"),l=$.mk("form").attr("id","img-update-form").append($.mk("div").attr("class","align-center").append($.mk("span").text("Current image"),n.clone().one("load",function(){$.Dialog.center()})),$.mk("label").append($.mk("span").text("New image URL"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{2,255}$",name:"image_url",required:!0})));$.Dialog.request("Update image of "+r+" #"+s,l,"img-update-form","Update",function(e){e.on("submit",function(i){i.preventDefault();var n=e.mkData();$.Dialog.wait(!1,"Replacing image"),$.post("/post/set-"+r+"-image/"+s,n,$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,"Image has been updated"),void t(r,a,o)):$.Dialog.fail(!1,this.message)}))})})}))),$.Dialog.request(!1,n,"post-edit-form","Save",function(t){var n,a=t.find("[name=label]"),o=t.find("[name=type]");if(e.label&&a.val(e.label),e.type&&o.children("option").filter(function(){return this.value===e.type}).attr("selected",!0),"string"==typeof e.posted){n=t.find("[name=date]");var l=moment(e.posted);n.val(l.format("YYYY-MM-DDTHH:mm:SSZ"))}t.on("submit",function(t){t.preventDefault();var l={label:a.val()};"request"===r&&(l.type=o.val()),"string"==typeof e.posted&&(l.posted=new Date(n.val()).toISOString()),$.Dialog.wait("Saving changes"),$.post("/post/set-"+r+"/"+s,l,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.label&&i.children(".label").text(this.label),this.type&&!i.parent().parent().hasClass("finished")){var e=$("#group-"+this.type).children("ul"),t=function(e){return new Date($(e).children("em").find("time").attr("datetime")).getTime()};e.append(i),e.children().sort(function(e,i){return t(e)-t(i)}).appendTo(e)}this.posted&&(i.children("em").find("time").attr("datetime",this.posted),window.updateTimes()),$.Dialog.close()}))})})}))})}function t(e,t,i,n){var a=e.charAt(0).toUpperCase()+e.substring(1);$.Dialog.wait(a,"Updating list"),$.post("/episode/"+e.replace(/([^s])$/,"$1s")+"/S"+t+"E"+i,$.mkAjaxHandler(function(){if(!this.status)return window.location.reload();var t=$("#"+e.replace(/([^s])$/,"$1s")),i=$(this.render).filter("section").children();t.empty().append(i).rebindHandlers().find(".post-form").data("type",e).formBind(),window.updateTimes(),"function"==typeof n?n():$.Dialog.close()}))}function i(e){"object"==typeof e&&"function"==typeof e.preventDefault&&e.preventDefault(),$.Dialog.close(),n(location.hash,e)}function n(e,t){var i=$(e);$(".highlight").removeClass("highlight"),i.length&&(i.addClass("highlight"),setTimeout(function(){$body.animate({scrollTop:i.offset().top-$navbar.outerHeight()-10},500,function(){"object"==typeof t&&"load"===t.type&&$.Dialog.close()})},1))}var a=window.SEASON,o=window.EPISODE,s="S"+a+"E"+o;$("#video").on("click",function(){$.Dialog.wait("Video links","Requesting links from the server"),$.post("/episode/getvideos/"+s,$.mkAjaxHandler(function(){var e=this;if(!e.status)return $.Dialog.fail(!1,e.message);var t=$.mk("form").attr("id","vidlinks").append($.mk("p").addClass("align-center").text("Enter vido links below, leave any input blank to remove that video from the episode page."),$.mk("input").attr({name:"yt",placeholder:"YouTube"}),$.mk("input").attr({name:"dm",placeholder:"Dailymotion"}));$.Dialog.request(!1,t,"vidlinks","Save",function(t){var i=t.find("[name=yt]"),n=t.find("[name=dm]");e.yt&&i.val(e.yt),e.dm&&n.val(e.dm),(e.yt||e.dm)&&(t.find("p").show(),$.Dialog.center()),t.on("submit",function(e){e.preventDefault(),$.Dialog.wait(!1,"Saving links"),$.post("/episode/setvideos/"+s,{yt:i.val(),dm:n.val()},$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$content.children("section.episode");this.epsection?(e.length||(e=$.mk("section").addClass("episode").insertBefore($content.children("section").first())),e.html($(this.epsection).filter("section").html())):e.length&&e.remove(),$.Dialog.close()}))})})}))});var r=$("#voting"),l=r.children(".rate");if(l.on("click",function(e){e.preventDefault();var t=($(this),function(e){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:e}),$.mk("span")).on("mouseenter mouseleave",function(e){var t=$(this),i=t.parent().find("input:checked"),n=i.parent(),a=t.closest("div").next().children("strong");switch(e.type){case"mouseleave":if(0===n.length){t.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}t=n;case"mouseenter":t.prevAll().addBack().children("span").attr("class","active"),t.nextAll().children("span").attr("class",""),a.text(t.children("input").attr("value"))}t.siblings().addBack().removeClass("selected"),n.addClass("selected")})}),i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(t(1),t(2),t(3),t(4),t(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5"));$.Dialog.request("Rating "+s,i,"star-rating","Rate",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();return"undefined"==typeof i.vote?$.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins"):($.Dialog.wait(!1,"Submitting your rating"),void $.post("/episode/vote/"+s,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=l.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml),$.Dialog.close()})))})})}),r.find("time").data("dyntime-beforeupdate",function(e){return e.past===!0?l.length?void 0:($.post("/episode/vote/"+s+"?html",$.mkAjaxHandler(function(){this.status||$.Dialog.fail("Display voting buttons",this.message),r.children("h2").nextAll().remove(),r.append(this.html)})),$(this).removeData("dyntime-beforeupdate"),!1):void 0}),$.fn.rebindHandlers=function(){var t=$(this);return t.find("li[id]").each(function(){var t=$(this),i=parseInt(t.attr("id").replace(/\D/g,"")),n=t.closest("section[id]").attr("id");$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){$body.addClass("no-distractions")}).on("closestart",function(){$body.removeClass("no-distractions")}),e(t,i,n)}),t},$("#requests, #reservations").rebindHandlers(),$.fn.formBind=function(){function e(e){var t=c.data("prev-url"),i="string"==typeof t&&t.trim()===c.val().trim();if(n.attr("disabled",e===!0||i),e===!0||i?n.attr("title","You need to change the URL before chacking again."):n.removeAttr("title"),"keyup"===e.type){var a=c.val();g.test(a)&&c.val(c.val().replace(g,""))}}var i=$(this),n=i.find(".check-img"),r=i.find(".img-preview"),l=i.find("[name=label]"),c=i.find("[name=image_url]"),d=i.find("[name=label]"),u=r.children(".notice"),f=u.html(),p=r.children("img"),h=i.data("type"),m=h.charAt(0).toUpperCase()+h.substring(1);0===p.length&&(p=$(new Image).appendTo(r)),$("#"+h+"-btn").on("click",function(){i.is(":visible")||(i.show(),l.focus(),$body.animate({scrollTop:i.offset().top-$navbar.outerHeight()-10},500))}),"reservation"===h&&$("#add-reservation-btn").on("click",function(){$.Dialog.request("Add a reservation",'<form id="add-reservation"><div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div><div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"add-reservation","Finish",function(e){e.on("submit",function(i){i.preventDefault();var n=e.find("[name=deviation]").val();return"string"!=typeof n||0===n.length?$.Dialog.fail(!1,"Please enter a deviation URL"):($.Dialog.wait(!1,"Adding reservation"),void $.post("/reserving/reservation?add="+s,{deviation:n},$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,this.message),void t(h,a,o)):$.Dialog.fail(!1,this.message)})))})})}),c.on("keyup change paste",e);var g=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,v='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';n.on("click",function(t){t.preventDefault(),n.removeClass("red"),e(!0);var a=c.val(),o=m+" process";$.Dialog.wait(m+" process","Checking image"),$.post("/post",{image_url:a},$.mkAjaxHandler(function(){function e(t,n){$.Dialog.wait(o,"Checking image availability"),p.attr("src",t.preview).show().off("load error").on("load",function(){u.hide(),c.data("prev-url",a),t.title&&!d.val().trim()?$.Dialog.confirm("Confirm "+h+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+t.title+"</strong></p><br>Would you like to use this as the "+h+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===h?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+h+" a description before clicking the "+v+" button.</p>",function(e){return e?(d.val(t.title),void $.Dialog.close()):i.find("input[name=label]").focus()}):$.Dialog.close(function(){i.find("input[name=label]").focus()})}).on("error",function(){return 1>n?($.Dialog.wait("Can't load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){e(t,n+1)},2e3)):void $.Dialog.fail(o,"There was an error while attempting to load the image. Make sure the URL is correct and try again!")})}var t=this;return t.status?void e(t,0):(u.html(t.message).show(),p.hide(),$.Dialog.close())}))}),i.on("submit",function(e,n,s){e.preventDefault();var r=m+" process";if(!n&&c.data("prev-url")!==c.val())return $.Dialog.confirm(r,"You modified the image URL without clicking the "+v+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&i.triggerHandler("submit",[!0])});if("undefined"==typeof c.data("prev-url"))return $.Dialog.fail(r,"Please click the "+v+" button before submitting your "+h+"!");if(!s&&"request"===h){var d=l.val(),u=i.find("select");if(d.indexOf("character")>-1&&"chr"!==u.val())return $.Dialog.confirm(r,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){u.focus()}):i.triggerHandler("submit",[n,!0])})}var f=i.mkData({what:h,episode:o,season:a,image_url:c.data("prev-url")});$.Dialog.wait(r,"Submitting "+h),$.post("/post",f,$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,m+" posted successfully"),void t(h,a,o)):$.Dialog.fail(!1,this.message)}))}).on("reset",function(){n.attr("disabled",!1).addClass("red"),u.html(f).show(),p.hide(),c.removeData("prev-url"),$(this).hide()})},$(".post-form").each($.fn.formBind),$w.on("hashchange",i),location.hash.length){var c=$content.find("img"),d=c.length,u=0;if(d>0&&$(location.hash).length>0){$.Dialog.wait("Scroll post into view","Waiting for page to load");var f=$.mk("progress").attr({max:d,value:0}).css({display:"block",width:"100%",marginTop:"5px"});$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(f),$content.imagesLoaded().progress(function(e,t){t.isLoaded?(u++,f.attr("value",u)):(d--,f.attr("max",d))}).always(function(){setTimeout(function(){$.Dialog.close(),i({type:"load"})},1)})}else i()}});
//# sourceMappingURL=episode.min.js.map
