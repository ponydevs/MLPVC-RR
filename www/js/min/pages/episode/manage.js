"use strict";!function(){var e=window.SEASON,t=window.EPISODE,o=window.USERNAME_REGEX,u=window.FULLSIZE_MATCH_REGEX,l="S"+e+"E"+t,r=(0===e?"Movie":"Episode").toLowerCase(),c=$content.children("section.episode");$("#video").on("click",function(){$.Dialog.wait("Set video links","Requesting links from the server"),$.API.get("/episode/"+l+"/video-data",$.mkAjaxHandler(function(){var e=this;if(!e.status)return $.Dialog.fail(!1,e.message);var t="<input type='url' class='yt' name='yt_1' placeholder='YouTube' spellcheck='false' autocomplete='off'>",i="<input type='url' class='dm' name='dm_1' placeholder='Dailymotion' spellcheck='false' autocomplete='off'>",a="<input type='url' class='sv' name='sv_1' placeholder='sendvid' spellcheck='false' autocomplete='off'>",n=$.mk("form").attr("id","vidlinks").attr("class","align-center").html("<p>Enter vido links below, leave any input blank to remove that video from the "+r+" page.</p>\n\t\t\t\t\t<div class='inputs'>\n\t\t\t\t\t\t"+t+"\n\t\t\t\t\t\t"+i+"\n\t\t\t\t\t\t"+a+"\n\t\t\t\t\t\t<input type='url' class='mg' name='mg_1' placeholder='Mega' spellcheck='false' autocomplete='off'>\n\t\t\t\t\t</div>");if(e.twoparter&&($.mk("p").html("<strong>~ Part 1 ~</strong>").insertBefore(n.children("input").first()),n.append("<p>Check below if either link contains the full "+r+" instead of just one part</p>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label><input type='checkbox' name='yt_1_full'> YouTube</label>\n\t\t\t\t\t\t<label><input type='checkbox' name='dm_1_full'> Dailymotion</label>\n\t\t\t\t\t\t<label><input type='checkbox' name='sv_1_full'> sendvid</label>\n\t\t\t\t\t\t<label><input type='checkbox' name='mg_1_full'> Mega</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p><strong>~ Part 2 ~</strong></p>\n\t\t\t\t\t<div class='inputs'>\n\t\t\t\t\t\t"+t.replace("yt_1","yt_2")+"\n\t\t\t\t\t\t"+i.replace("dm_1","dm_2")+"\n\t\t\t\t\t\t"+a.replace("sv_1","sv_2")+"\n\t\t\t\t\t\t"+a.replace("mg_1","mg_2")+"\n\t\t\t\t\t</div>"),n.find('input[type="checkbox"]').on("change",function(){var e=$(this).attr("name").replace(/^([a-z]+)_.*$/,"$1");n.find("input").filter("[name="+e+"_2]").attr("disabled",this.checked)}),0<e.fullep.length&&$.each(e.fullep,function(e,t){n.find('input[type="checkbox"]').filter('[name="'+t+'_1_full"]').prop("checked",!0).trigger("change")})),0<Object.keys(e.vidlinks).length){var s=n.find('input[type="url"]');$.each(e.vidlinks,function(e,t){s.filter("[name="+e+"]").val(t)})}$.Dialog.request(!1,n,"Save",function(i){i.on("submit",function(e){e.preventDefault();var t=i.mkData();$.Dialog.wait(!1,"Saving links"),$.API.put("/episode/"+l+"/video-data",t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.epsection?(c.length||(c=$.mk("section").addClass("episode").insertBefore($content.children("section").first())),c.html($(this.epsection).filter("section").html()),bindVideoButtons()):c.length&&(c.remove(),c={length:0}),$.Dialog.close()}))})})}))});var n=$content.children("section.appearances");function a(a,e,n,s){var l="Reserving request",i=function t(i){$.Dialog.wait(l,"Sending reservation to the server"),$.post("/post/reserve/request/"+n,i,$.mkAjaxHandler(function(){if(this.retry)return $.Dialog.confirm(!1,this.message,function(e){e&&(i.screwit=!0,t(i))});if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var e=$(this.li);a.hasClass("highlight")&&e.addClass("highlight"),a.replaceWith(e),Time.Update(),e.trigger("bind-more-handlers",[n,s])}$.Dialog.close()}))};if(void 0!==o&&e){var t=$.mk("form").attr("id","reserve-as").append($.mk("label").append("<span>Reserve as</span>",$.mk("input").attr({type:"text",name:"post_as",required:!0,placeholder:"Username"}).patternAttr(o)),$.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",spellcheck:!1,autocomplete:"off",placeholder:"time()"})));$.Dialog.request(l,t,"Reserve",function(t){t.on("submit",function(e){e.preventDefault(),i(t.mkData())})})}else i({})}$("#cg-relations").on("click",function(){$.Dialog.wait("Guide relation editor","Retrieving relations from server"),$.API.get("/episode/"+l+"/guide-relations",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this,t=$.mk("form").attr("id","guide-relation-editor"),a=$.mk("select").attr({name:"listed",multiple:!0}),i=$.mk("select").attr("multiple",!0);e.linked&&e.linked.length&&$.each(e.linked,function(e,t){a.append($.mk("option").attr("value",t.id).text(t.label))}),e.unlinked&&e.unlinked.length&&$.each(e.unlinked,function(e,t){i.append($.mk("option").attr("value",t.id).text(t.label))}),t.append($.mk("div").attr("class","split-select-wrap").append($.mk("div").attr("class","split-select").append("<span>Linked</span>",a),$.mk("div").attr("class","buttons").append($.mk("button").attr({class:"typcn typcn-chevron-left green",title:"Link selected"}).on("click",function(e){e.preventDefault(),a.append(i.children(":selected").prop("selected",!1)).children().sort(function(e,t){return e.innerHTML.localeCompare(t.innerHTML)}).appendTo(a)}),$.mk("button").attr({class:"typcn typcn-chevron-right red",title:"Unlink selected"}).on("click",function(e){e.preventDefault(),i.append(a.children(":selected").prop("selected",!1)).children().sort(function(e,t){return e.innerHTML.localeCompare(t.innerHTML)}).appendTo(i)})),$.mk("div").attr("class","split-select").append("<span>Available</span>",i))),$.Dialog.request(!1,t,"Save",function(e){e.on("submit",function(e){e.preventDefault();var i=[];a.children().each(function(e,t){i.push(t.value)}),$.Dialog.wait(!1,"Saving changes"),$.API.put("/episode/"+l+"/guide-relations",{ids:i.join(",")},$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.section?(n.length||(n=$.mk("section").addClass("appearances").insertBefore($content.children(".admin"))),n.html($(this.section).filter("section").html())):n.length&&(n.remove(),n={length:0}),$.Dialog.close()}))})})}))}),$("#edit-about_reservations, #edit-reservation_rules").on("click",function(e){e.preventDefault();var n=$(this).parent(),t=n.clone(),s=this.id.split("-").pop();t.children().remove();var i=t.text().trim();$.Dialog.wait('Editing "'+i+'"',"Retrieving setting's value"),$.post("/setting/get/"+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("form",s+"-editor").html("<span>"+i+"</span>"),a=this.value;$.Dialog.request(!1,e,"Save",function(e){var t=ace.edit($.mk("div").appendTo(e).get(0));t.setShowPrintMargin(!1);var i=$.aceInit(t,"html");i.setMode("html"),i.setUseWrapMode(!0),i.setValue(a),e.on("submit",function(e){e.preventDefault();var t={value:i.getValue()};$.Dialog.wait(!1,"Saving"),$.post("/setting/set/"+s,t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);n.siblings().remove(),n.parent().append(this.value),$.Dialog.close()}))})})}))});var i=function(){var i=$(this),e=$._getLiTypeId(i),s=e.id,l=e.type.replace(/s$/,""),r=$.capitalize(l);i.children("button.reserve-request").off("click").on("click",function(e){e.preventDefault(),a(i,e.shiftKey,s,l)});var t=i.find(".actions").children();t.filter(".cancel").off("click").on("click",function(){$.Dialog.confirm("Cancel reservation","Are you sure you want to cancel this reservation?",function(e){e&&($.Dialog.wait(!1,"Cancelling reservation"),i.addClass("deleting"),$.post("/post/unreserve/"+l+"/"+s,$.mkAjaxHandler(function(){return this.status?!0===this.remove?($.Dialog.close(),i[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){i.remove()})):(this.reload&&i.reloadLi(!1),$.Dialog.close(),void i.removeClass("deleting")):$.Dialog.fail(!1,this.message)})))})}),t.filter(".finish").off("click").on("click",function(){var e=$.mk("form").attr("id","finish-res").append($.mk("label").append($.mk("span").text("Deviation URL"),$.mk("input").attr({type:"url",name:"deviation",spellcheck:!1,autocomplete:"off",required:!0})));void 0!==o&&e.append($.mk("label").append($.mk("span").text("Finished at"),$.mk("input").attr({type:"datetime",name:"finished_at",spellcheck:!1,autocomplete:"off",placeholder:"time()"}))),$.Dialog.request("Complete reservation",e,"Finish",function(i){i.on("submit",function(e){e.preventDefault();var t=i.find("[name=deviation]").val();if("string"!=typeof t||0===t.length)return $.Dialog.fail(!1,"Please enter a deviation URL");var a="/post/finish/"+l+"/"+s,n=i.mkData();$.Dialog.wait(!1,"Marking "+l+" as finished"),$.post(a,n,$.mkAjaxHandler(function(){var t=this,i=function(){$.Dialog.success(!1,r+" has been marked as finished"),$("#"+l+"s").trigger("pls-update",[function(){"string"==typeof t.message&&t.message?$.Dialog.success(!1,t.message,!0):$.Dialog.close()}])};t.status?i():t.retry?$.Dialog.confirm(!1,t.message,["Continue","Cancel"],function(e){e&&(n.allow_overwrite_reserver=!0,$.Dialog.wait(!1),$.post(a,n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);t=this,i()})))}):$.Dialog.fail(!1,t.message)}))})})}),t.filter(".unfinish").off("click").on("click",function(){var t=$(this).hasClass("delete-only"),a=$.capitalize(l),e=l.replace(/s$/,"");$.Dialog.request((t?"Delete":"Un-finish")+" "+e,'<form id="unbind-check"><p>Are you sure you want to '+(t?"delete this reservation":"mark this "+e+" as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind '+e+" from user</label></form>","Un-finish",function(e){var i=e.find("[name=unbind]");t||e.prepend('<div class="notice info">By removing the "finished" flag, the post will be moved back to the "List of '+a+'" section</div>'),"reservation"===l?(i.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),t&&i.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(t?"reservation was added directly, it cannot be marked unfinished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),$w.trigger("resize"),e.on("submit",function(e){e.preventDefault();var t=i.prop("checked");$.Dialog.wait(!1,'Removing "finished" flag'+(t?" & unbinding from user":"")),$.post("/post/unfinish/"+l+"/"+s+(t?"?unbind":""),$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,void 0!==this.message?this.message:'"finished" flag removed successfully'),$("#"+l+"s").trigger("pls-update")}))})})}),t.filter(".check").off("click").on("click",function(e){e.preventDefault(),$.Dialog.wait("Submission approval status","Checking"),$.post("/post/lock/"+l+"/"+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this.message;i.reloadLi(),$.Dialog.success(!1,e,!0)}))}),t.filter(".unlock").off("click").on("click",function(e){e.preventDefault(),$.Dialog.confirm("Unlocking post","Are you sure you want to unlock this post?",function(e){e&&($.Dialog.wait(!1),$.post("/post/unlock/"+l+"/"+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$("#"+l+"s").trigger("pls-update")})))})}),t.filter(".delete").off("click").on("click",function(){var t=$(this);$.Dialog.confirm("Deleting request #"+s,"You are about to permanently delete this request.<br>Are you sure about this?",function(e){e&&($.Dialog.wait(!1),i.addClass("deleting"),$.post("/post/delete-request/"+s,$.mkAjaxHandler(function(){if(!this.status)return i.removeClass("deleting"),$.Dialog.fail(!1,this.message);$.Dialog.close(),t.closest("li")[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){$(this).remove()})})))})}),t.filter(".edit").off("click").on("click",function(){var p=$(this).parents("li"),e=p.attr("id").split("-"),d=e[1],f=e[0];$.Dialog.wait("Editing "+f+" #"+d,"Retrieving "+f+" details"),$.post("/post/get/"+f+"/"+d,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var c=this,e=$.mk("form").attr("id","post-edit-form").append($.mk("label").append($.mk("span").text("Description (3-255 chars."+("reservation"===f?", optional":"")+")"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{3,255}$",name:"label",required:"reservation"!==f})));"request"===f&&e.append($.mk("label").append($.mk("span").text("Request type"),$.mk("select").attr({name:"type",required:!0}).append($.mk("option").attr("value","chr").text("Character"),$.mk("option").attr("value","obj").text("Object"),$.mk("option").attr("value","bg").text("Backgound")))),"string"==typeof c.posted_at&&e.append($.mk("label").append($.mk("span").text("Post timestamp"),$.mk("input").attr({type:"datetime",name:"posted_at",required:!0,spellcheck:!1,autocomplete:"off"}))),"string"==typeof c.reserved_at&&e.append($.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",spellcheck:!1,autocomplete:"off"}))),"string"==typeof c.finished_at&&e.append($.mk("label").append($.mk("span").text("Finished at"),$.mk("input").attr({type:"datetime",name:"finished_at",spellcheck:!1,autocomplete:"off"})));var t=p.children(".image").hasClass("screencap"),i="finished"===p.closest("div").attr("class"),a=i?p.children(".original"):p.children(".image").children("a"),n=a.attr("href"),s=!i&&!u.test(n)&&/deviantart\.net\//.test(n),l=p.children(".broken-note").length;(t||s||l)&&e.append($.mk("label").append(t?$.mk("a").text("Update Image").attr({href:"#update",class:"btn darkblue typcn typcn-pencil"}).on("click",function(e){e.preventDefault(),$.Dialog.close();var t=p.children(".image").find("img"),i=$.mk("form").attr("id","img-update-form").append($.mk("div").attr("class","oldimg").append($.mk("span").text("Current image"),t.clone()),$.mk("label").append($.mk("span").text("New image URL"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{2,255}$",name:"image_url",required:!0,autocomplete:"off",spellcheck:"false"})));$.Dialog.request("Update image of "+f+" #"+d,i,"Update",function(i){i.on("submit",function(e){e.preventDefault();var t=i.mkData();$.Dialog.wait(!1,"Replacing image"),$.post("/post/set-image/"+f+"/"+d,t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if($.Dialog.success(!1,"Image has been updated",!0),this.li){var e=$(this.li);p.hasClass("highlight")&&e.addClass("highlight"),p.replaceWith(e),Time.Update(),e.trigger("bind-more-handlers",[d,f])}else p.reloadLi()}))})})}):void 0,s?$.mk("a").text("Sta.sh fullsize fix").attr({href:"#fix-stash-fullsize",class:"btn orange typcn typcn-spanner"}).on("click",function(e){e.preventDefault(),$.Dialog.close(),$.Dialog.wait("Fix Sta.sh fullsize URL","Fixing Sta.sh full size image URL"),$.post("/post/fix-stash/"+f+"/"+d,$.mkAjaxHandler(function(){if(!this.status){if(this.rmdirect){if(!i)return p.find(".post-date").children("a").first().triggerHandler("click"),$.Dialog.fail(!1,this.message+"<br>The post might be broken because of this, please check it for any issues.");p.children(".original").remove()}return $.Dialog.fail(!1,this.message)}a.attr("href",this.fullsize),$.Dialog.success(!1,"Fix successful",!0)}))}):void 0,l?$.mk("a").text("Clear broken status").attr({href:"#clear-broken-status",class:"btn orange typcn typcn-spanner"}).on("click",function(e){e.preventDefault(),$.Dialog.close(),$.Dialog.wait("Clear post broken status","Checking image availability"),$.post("/post/unbreak/"+f+"/"+d,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var e=$(this.li);p.hasClass("highlight")&&e.addClass("highlight"),p.replaceWith(e),Time.Update(),e.trigger("bind-more-handlers",[d,f])}$.Dialog.close()}))}):void 0)),$.Dialog.request(!1,e,"Save",function(e){var n=e.find("[name=label]"),s=e.find("[name=type]"),l=void 0,r=void 0,o=void 0;if(c.label&&n.val(c.label),c.type&&s.children("option").filter(function(){return this.value===c.type}).attr("selected",!0),"string"==typeof c.posted_at){l=e.find("[name=posted_at]");var t=moment(c.posted_at);l.val(t.format())}if("string"==typeof c.reserved_at&&(r=e.find("[name=reserved_at]"),c.reserved_at.length)){var i=moment(c.reserved_at);r.val(i.format())}if("string"==typeof c.finished_at&&(o=e.find("[name=finished_at]"),c.finished_at.length)){var a=moment(c.finished_at);o.val(a.format())}e.on("submit",function(e){e.preventDefault();var t={label:n.val()};if("request"===f&&(t.type=s.val()),"string"==typeof c.posted_at){if(t.posted_at=new Date(l.val()),isNaN(t.posted_at.getTime()))return $.Dialog.fail(!1,"Post timestamp is invalid");t.posted_at=t.posted_at.toISOString()}if("string"==typeof c.reserved_at){var i=r.val();if(i.length){if(t.reserved_at=new Date(i),isNaN(t.reserved_at.getTime()))return $.Dialog.fail(!1,'"Reserved at" timestamp is invalid');t.reserved_at=t.reserved_at.toISOString()}}if("string"==typeof c.finished_at){var a=o.val().trim();if(a.length){if(t.finished_at=new Date(a),isNaN(t.finished_at.getTime()))return $.Dialog.fail(!1,'"Finished at" timestamp is invalid');t.finished_at=t.finished_at.toISOString()}}$.Dialog.wait(!1,"Saving changes"),$.post("/post/set/"+f+"/"+d,t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);p.reloadLi(),$.Dialog.close()}))})})}))}),t.filter(".pls-transfer").off("click").on("click",function(){var e=i.children(".reserver").find(".name").text();$.Dialog.confirm("Take on reservation of "+l+" #"+s,"<p>Using this option, you can express your interest in finishing the "+l+" which "+e+" already reserved.</p>\n\t\t\t\t<p>They will be sent a notification letting them know you're interested and they'll be able to allow/deny the transfer of the reserver status as they see fit.</p>\n\t\t\t\t<p>Once "+e+" responds to your inquiry you'll receive a notification informing you about their decision. If they agreed, the post's reservation will be transferred to you immediately.</p>\n\t\t\t\t<p><strong>Are you sure you can handle this "+l+"?</strong></p>",function(e){e&&($.Dialog.wait(!1),$.post("/post/transfer/"+l+"/"+s,$.mkAjaxHandler(function(){return this.canreserve?$.Dialog.confirm(!1,this.message,function(e){e&&a(i,!1,s,l)}):this.status?void $.Dialog.success(!1,this.message,!0):$.Dialog.fail(!1,this.message)})))})})};$("#requests, #reservations").on("bind-more-handlers","li[id]",i).find("li[id]").each(i)}();
//# sourceMappingURL=/js/min/pages/episode/manage.js.map
