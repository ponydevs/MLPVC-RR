"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};DocReady.push(function(){function e(){"undefined"!=typeof s&&s.filter(".red").triggerHandler("click")}function t(){var e=$content.find("img[src]"),t=e.length,i=0;if(!t)return $.Dialog.close();var n=void 0;m&&($.Dialog.wait("Scroll post into view","Waiting for page to load"),n=$.mk("progress").attr({max:t,value:0}).css({display:"block",width:"100%",marginTop:"5px"}),$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(n)),$content.imagesLoaded().progress(function(e,a){if(a.isLoaded)i++,m&&n.attr("value",i);else if(a.img.src){var o=$(a.img).closest("li[id]");1===o.length&&o.reloadLi(),t--,m&&n.attr("max",t)}}).always(function(){var e=window._HighlightHash({type:"load"});e===!1&&m&&$.Dialog.info("Scroll post into view","The "+location.hash.replace(v,"$1")+" you were linked to has either been deleted or didn't exist in the first place. Sorry.<div class='align-center'><span class='sideways-smiley-face'>:\\</div>")})}var i=window.SEASON,n=window.EPISODE,a="S"+i+"E"+n,o=$("#live-update"),r=o.length,s=void 0,l=function(e,t){$("#reservations, #requests").trigger("pls-update",[e,t,!0])},d=void 0;window._HighlightHash=function(e){$(".highlight").removeClass("highlight");var t=$(location.hash);return!!t.length&&(t.addClass("highlight"),void setTimeout(function(){$.scrollTo(t.offset().top-$navbar.outerHeight()-10,500,function(){"object"===("undefined"==typeof e?"undefined":_typeof(e))&&"load"===e.type&&$.Dialog.close()})},1))},$w.on("hashchange",window._HighlightHash),r&&!function(){var t=void 0,i=30,n=function(){"undefined"!=typeof window._rlinterval&&(clearInterval(window._rlinterval),window._rlinterval=void 0)},a=o.find(".timer"),r=o.find("button.reload").on("click",function(t){t.preventDefault(),n();var i=function(t){a.html("&hellip;").css("color",""),r.disable().html("Reloading&hellip;");var i=0,n=2,o=function(a){return a===!1?e():(i++,void(i<n||(window._HighlightHash(),d(),t&&$.Dialog.close())))};l(o,!0)};$(".post-form").filter(":visible").length>0?$.Dialog.confirm("Reloading posts","You are in the process of posting a request/reservation. Reloading the posts will clear your progress.<br><br>Continue reloading?",function(e){e&&($.Dialog.wait(!1,"Updating posts"),i(!0))}):i()}),c=function(){var e=Math.round((t.getTime()-(new Date).getTime())/1e3)*-1,n=e>i?255:e/i*255;a.text(i-e+"s").css("color","rgb(255,"+(255-n/2)+","+(255-n)+")"),e>=i&&r.triggerHandler("click")};d=function(){r.html("Reload now").enable(),n(),s.hasClass("green")||(t=new Date,a.text(i+"s").css("color",""),window._rlinterval=setInterval(c,1e3))},s=o.find("button.disable").on("click",function(e){e.preventDefault();var t=s.hasClass("red");s.toggleHtml(["Enable","Disable"]).toggleClass("red green typcn-times typcn-tick"),t?a.parent().hide().next().show():a.parent().show().next().hide(),d()}),t=new Date,c(),window._rlinterval=setInterval(c,1e3),$w.on("dialog-opened",e)}();var c=$("#voting");c.on("click",".rate",function(e){e.preventDefault();var t=function(e){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:e}),$.mk("span")).on("mouseenter mouseleave",function(e){var t=$(this),i=t.parent().find("input:checked"),n=i.parent(),a=t.closest("div").next().children("strong");switch(e.type){case"mouseleave":if(0===n.length){t.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}t=n;case"mouseenter":t.prevAll().addBack().children("span").attr("class","active"),t.nextAll().children("span").attr("class",""),a.text(t.children("input").attr("value"))}t.siblings().addBack().removeClass("selected"),n.addClass("selected")})},i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(t(1),t(2),t(3),t(4),t(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5")),n=c.children(".rate");$.Dialog.request("Rating "+a,i,"Rate",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();return"undefined"==typeof i.vote?$.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins"):($.Dialog.wait(!1,"Submitting your rating"),void $.post("/episode/vote/"+a,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=n.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml),c.bindDetails(),$.Dialog.close()})))})})}),c.find("time").data("dyntime-beforeupdate",function(e){if(e.past===!0)return c.children(".rate").length?void 0:($.post("/episode/vote/"+a+"?html",$.mkAjaxHandler(function(){return this.status?(c.children("h2").nextAll().remove(),c.append(this.html),void c.bindDetails()):$.Dialog.fail("Display voting buttons",this.message)})),$(this).removeData("dyntime-beforeupdate"),!1)}),$.fn.bindDetails=function(){$(this).find("a.detail").on("click",function(e){e.preventDefault(),e.stopPropagation(),$.Dialog.wait("Voting details","Getting vote distribution information"),$.post("/episode/vote/"+a+"?detail",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("canvas"),t=e.get(0).getContext("2d"),i=$.mk("p").attr("class","tooltip");$.Dialog.info(!1,[$.mk("p").text("Here's a chart showing how the votes are distributed. Mouse over the different segments to see the exact number of votes."),$.mk("div").attr("id","vote-distrib").append(e,i)]);var n=[void 0,"#FF5454","#FFB554","#FFFF54","#8CD446","#4DC742"],a=this.data,o=0;return a.datasets[0].backgroundColor=[],a.datasets[0].hoverBackgroundColor=[],a.datasets[0].borderWidth=[],a.datasets[0].hoverBorderColor=[],$.each(a.datasets[0].data,function(e,t){var i=n[parseInt(a.labels[e],10)];a.datasets[0].backgroundColor.push(i);var r=$.hex2rgb(i),s=1.06;r.r=Math.round(Math.min(255,r.r*s)),r.g=Math.round(Math.min(255,r.g*s)),r.b=Math.round(Math.min(255,r.b*s)),a.datasets[0].hoverBackgroundColor.push($.rgb2hex(r)),a.datasets[0].borderWidth.push(2),a.datasets[0].hoverBorderColor.push("rgba("+r.r+","+r.g+","+r.b+",0.9)"),o+=parseInt(t,10)}),0===o?(e.remove(),void i.text("There are no votes for this episode yet")):void new Chart(t,{type:"pie",data:a,options:{titleFontColor:"#000",bodyFontColor:"#000",animation:{easing:"easeInOutExpo"},legend:{display:!1},tooltips:{callbacks:{title:function(e,t){var i=parseInt(t.labels[e[0].index],10);return i+" muffin"+(1!==i?"s":"")},label:function(e,t){var i=parseInt(t.datasets[e.datasetIndex].data[e.index],10),n=Math.round(i/o*1e3)/10;return i+" user"+(1!==i?"s":"")+" ("+n+"%)"}}}}})}))})},c.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find(".screencap > a:not(.fluidbox--initialized)").fluidbox({immediateOpen:!0,loader:!0}).on("openstart.fluidbox",function(){e(),$body.addClass("no-distractions")}).on("closestart.fluidbox",function(){$body.removeClass("no-distractions")})},$._getLiTypeId=function(e){var t=e.attr("id").split("-");return{id:t[1],type:t[0]+"s"}},$.fn.rebindHandlers=function(){return this.find("li[id]").each(function(){var e=$(this),t=$._getLiTypeId(e);e.trigger("bind-more-handlers",[t.id,t.type])}),this.closest("section").rebindFluidbox(),this};var u=function(){var e=$(this),t=$._getLiTypeId(e),i=t.type,n=t.id,a=e.find(".actions").children();e.rebindFluidbox(),a.filter(".share").on("click",function(){var e=$(this),t=window.location.href.replace(/([^:\/]\/).*$/,"$1")+"s/"+e.parents("li").attr("id").replace(/^(re[qs])[^-]+?-(\d+)$/,"$1/$2");$.Dialog.info("Sharing "+i.replace(/s$/,"")+" #"+n,$.mk("div").attr("class","align-center").append("Use the link below to link to this post directly:",$.mk("div").attr("class","share-link").text(t),$.mk("button").attr("class","blue typcn typcn-clipboard").text("Copy to clipboard").on("click",function(e){$.copy(t,e)})),function(){$("#dialogContent").find(".share-link").select()})})};$("#requests, #reservations").on("pls-update",function(e,t,i,n){if(r&&!n)return l(t,i);var o=$(this),s=o.attr("id"),d=$.capitalize(s),c=s.replace(/([^s])$/,"$1s"),u=function(){return"function"==typeof t&&i===!0?t(!1):void window.location.reload()};i!==!0&&$.Dialog.wait(!$.Dialog.isOpen()&&d,"Updating list of "+c,!0),$.ajax("/episode/"+c+"/"+a,{method:"POST",success:$.mkAjaxHandler(function(){if(!this.status)return u();var e=$(this.render).filter("section").children();o.empty().append(e).rebindHandlers(),o.find(".post-form").attr("data-type",s).formBind(),Time.Update(),"function"==typeof t?t():i!==!0&&$.Dialog.close()}),error:u})}).on("bind-more-handlers","li[id]",u).find("li[id]").each(u),$.fn.formBind=function(){function t(e){var t=c.data("prev-url"),i="string"==typeof t&&t.trim()===c.val().trim();if(s.attr("disabled",e===!0||i),e===!0||i?s.attr("title","You need to change the URL before chacking again."):s.removeAttr("title"),"keyup"===e.type){var n=c.val();m.test(n)&&c.val(c.val().replace(m,""))}}function o(){var e=c.val(),i=v+" process";s.removeClass("red"),t(!0),$.Dialog.wait(i,"Checking image"),$.post("/post",{image_url:e},$.mkAjaxHandler(function(){function t(n,a){$.Dialog.wait(i,"Checking image availability"),p.attr("src",n.preview).show().off("load error").on("load",function(){h.children("p:not(.keep)").remove(),c.data("prev-url",e),n.title&&!u.val().trim()?$.Dialog.confirm("Confirm "+g+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+n.title+"</strong></p><br>Would you like to use this as the "+g+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===g?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+g+" a description before clicking the "+b+" button.</p>",function(e){return e?(u.val(n.title),void $.Dialog.close()):r.find("input[name=label]").focus()}):$.Dialog.close(function(){r.find("input[name=label]").focus()})}).on("error",function(){return a<1?($.Dialog.wait("Can't load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){t(n,a+1)},2e3)):($.Dialog.fail(i,"There was an error while attempting to load the image. Make sure the URL is correct and try again!"),void s.enable())})}var n=this;return n.status?void t(n,0):(h.children("p:not(.keep)").remove(),h.prepend($.mk("p").attr("class","color-red").html(n.message)).show(),p.hide(),s.enable(),$.Dialog.close())}))}var r=$(this);if(r.length){var s=r.find(".check-img"),l=r.find(".img-preview"),d=r.find("[name=label]"),c=r.find("[name=image_url]"),u=r.find("[name=label]"),h=l.children(".notice"),f=h.html(),p=l.children("img"),g=r.attr("data-type").replace(/s$/,""),v=$.capitalize(g);0===p.length&&(p=$(new Image).appendTo(l)),$("#"+g+"-btn").on("click",function(){e(),r.is(":visible")||(r.show(),d.focus(),$.scrollTo(r.offset().top-$navbar.outerHeight()-10,500))}),"reservation"===g&&$("#add-reservation-btn").on("click",function(){var e=$.mk("form","add-reservation").html('<div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div>\n\t\t\t\t<div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div>\n\t\t\t\t<label>\n\t\t\t\t\t<span>Deviation URL</span>\n\t\t\t\t\t<input type="text" name="deviation">\n\t\t\t\t</label>');$.Dialog.request("Add a reservation",e,"Finish",function(e){e.on("submit",function(t){t.preventDefault();var i=e.find("[name=deviation]").val();return"string"!=typeof i||0===i.length?$.Dialog.fail(!1,"Please enter a deviation URL"):($.Dialog.wait(!1,"Adding reservation"),void $.post("/post/add-reservation",{deviation:i,epid:a},$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,this.message),void $("#"+g+"s").trigger("pls-update")):$.Dialog.fail(!1,this.message)})))})})}),c.on("keyup change paste",t);var m=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,b='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';s.on("click",function(e){e.preventDefault(),o()}),r.on("submit",function(e,t,a){e.preventDefault();var o=v+" process";if("undefined"==typeof c.data("prev-url"))return $.Dialog.fail(o,"Please click the "+b+" button before submitting your "+g+"!");if(!t&&c.data("prev-url")!==c.val())return $.Dialog.confirm(o,"You modified the image URL without clicking the "+b+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&r.triggerHandler("submit",[!0])});if(!a&&"request"===g){var s=function(){var e=d.val(),i=r.find("select");if(e.indexOf("character")>-1&&"chr"!==i.val())return{v:$.Dialog.confirm(o,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){i.focus()}):r.triggerHandler("submit",[t,!0])})}}();if("object"===("undefined"==typeof s?"undefined":_typeof(s)))return s.v}var l=r.mkData({what:g,episode:n,season:i,image_url:c.data("prev-url")});!function u(){$.Dialog.wait(o,"Submitting "+g),$.post("/post",l,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,["Go ahead","Nevermind"],function(e){e&&(l.allow_nonmember=!0,u())}):$.Dialog.fail(!1,this.message);$.Dialog.success(!1,v+" posted");var e=this.id;$("#"+g+"s").trigger("pls-update",[function(){$.Dialog.close(),$("#"+g+"-"+e).find("em.post-date").children("a").triggerHandler("click")}])}))}()}).on("reset",function(){s.attr("disabled",!1).addClass("red"),h.html(f).show(),p.hide(),c.removeData("prev-url"),$(this).hide()})}};var h=["requests","reservations"],f=0,p={},g=function w(e,i){$.each(h,function(e,n){!function(e){var n=$("#"+e);p[e]!==!0&&($.isInViewport(n.get(0))||i)&&(p[e]=!0,console.log("[DYN-POSTS] Loading %s section (force=%s)",e,i),n.trigger("pls-update",[function(){h.splice(h.indexOf(e),1),console.log("[DYN-POSTS] Loaded %s section",e),2===++f&&($w.off("scroll",w),t(!0))},!0,!0]))}(n)})};$w.on("scroll touchmove",$.throttle(250,g)),g();var v=/^#(request|reservation)-\d+$/,m=location.hash.length>1&&v.test(location.hash);m&&($.Dialog.wait("Scroll post into view","Preloading all posts, please wait"),g(null,!0));var b={};$.fn.reloadLi=function(){var e=$(this),t=e.attr("id").split("-"),i=t[0],n=t[1];b[t]||(b[t]=!0,console.log("[POST-FIX] Attemting to reload "+i+" #"+n),$.post("/post/reload-"+i+"/"+n,$.mkAjaxHandler(function(){if(this.status){var t=$(this.li);e.hasClass("highlight")&&t.addClass("highlight"),e.replaceWith(t),t.rebindFluidbox(),Time.Update(),t.trigger("rebind-handlers",[n,i])}})))}},function(){$body.removeClass("no-distractions"),$(".fluidbox--opened").fluidbox("close"),"number"==typeof window._rlinterval&&clearInterval(window._rlinterval),$w.off("hashchange",window._HighlightHash),delete window._HighlightHash,delete $.fn.reloadLi});
//# sourceMappingURL=/js/min/episode.js.map
